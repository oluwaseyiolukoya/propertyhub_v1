name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_URL: https://api.contrezz.com
          VITE_DATADOG_ENABLED: false
        run: npm run build

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Build backend
        run: |
          cd backend
          npm run build

      - name: Build summary
        run: |
          echo "‚úÖ Frontend build successful"
          echo "‚úÖ Backend build successful"
          echo "üì¶ Ready for deployment"

  deploy-to-digitalocean:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Trigger DigitalOcean Deployment
        uses: digitalocean/app_action@v1.1.5
        with:
          app_name: contrezz
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deployment initiated
        run: |
          echo "üöÄ Deployment triggered on DigitalOcean App Platform"
          echo "‚è±Ô∏è  Deployment typically takes 2-5 minutes"
          echo "üìä Monitor at: https://cloud.digitalocean.com/apps"
          echo ""
          echo "Production URLs:"
          echo "  Frontend: https://contrezz.com"
          echo "  Backend:  https://api.contrezz.com"

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-to-digitalocean
    
    steps:
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting 60 seconds for deployment to complete..."
          sleep 60

      - name: Check backend health
        run: |
          echo "üîç Checking backend health..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.contrezz.com/api/health)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Backend is healthy (HTTP $response)"
          else
            echo "‚ö†Ô∏è  Backend returned HTTP $response"
            exit 1
          fi

      - name: Check frontend
        run: |
          echo "üîç Checking frontend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://contrezz.com)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Frontend is accessible (HTTP $response)"
          else
            echo "‚ö†Ô∏è  Frontend returned HTTP $response"
            exit 1
          fi

      - name: Deployment complete
        run: |
          echo "üéâ Deployment verified successfully!"
          echo "‚úÖ Backend: https://api.contrezz.com"
          echo "‚úÖ Frontend: https://contrezz.com"
