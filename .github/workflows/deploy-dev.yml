name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_URL: https://api.contrezz.com
          VITE_DATADOG_ENABLED: false
        run: npm run build

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Build backend
        run: |
          cd backend
          npm run build

      - name: Build summary
        run: |
          echo "âœ… Frontend build successful"
          echo "âœ… Backend build successful"
          echo "ğŸ“¦ Ready for deployment"

  # DigitalOcean auto-deploys via webhook - no manual trigger needed
  deployment-info:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deployment notification
        run: |
          echo "ğŸš€ Build successful - DigitalOcean will auto-deploy"
          echo ""
          echo "ğŸ“Š Monitor deployment at:"
          echo "   https://cloud.digitalocean.com/apps"
          echo ""
          echo "â±ï¸  Deployment typically takes 3-5 minutes"
          echo ""
          echo "Production URLs:"
          echo "  ğŸŒ Frontend: https://contrezz.com"
          echo "  ğŸ”Œ Backend:  https://api.contrezz.com"
          echo ""
          echo "ğŸ’¡ DigitalOcean automatically deploys from the main branch"
          echo "   No manual trigger needed - webhook handles deployment"

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deployment-info
    
    steps:
      - name: Wait for deployment
        run: |
          echo "â³ Waiting 3 minutes for DigitalOcean deployment..."
          sleep 180

      - name: Check backend health
        run: |
          echo "ğŸ” Checking backend health..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://api.contrezz.com/api/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Backend is healthy (HTTP $response)"
              exit 0
            else
              echo "â³ Attempt $i/5: Backend returned HTTP $response, waiting 30s..."
              sleep 30
            fi
          done
          echo "âš ï¸  Backend health check timed out"
          echo "ğŸ’¡ Check DigitalOcean dashboard for deployment status"
          exit 1

      - name: Check frontend
        run: |
          echo "ğŸ” Checking frontend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://contrezz.com || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend is accessible (HTTP $response)"
          else
            echo "âš ï¸  Frontend returned HTTP $response"
            echo "ğŸ’¡ May still be deploying - check DigitalOcean dashboard"
          fi

      - name: Deployment summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment verified successfully!"
          echo ""
          echo "âœ… Backend:  https://api.contrezz.com"
          echo "âœ… Frontend: https://contrezz.com"
          echo ""
          echo "ğŸ“Š View logs: https://cloud.digitalocean.com/apps"
