generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model activity_logs {
  id          String     @id
  customerId  String?
  userId      String?
  action      String
  entity      String
  entityId    String?
  description String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime   @default(now())
  customers   customers? @relation(fields: [customerId], references: [id])
  users       users?     @relation(fields: [userId], references: [id])
}

model admins {
  id        String    @id
  email     String    @unique
  password  String
  name      String
  role      String    @default("super_admin")
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime
  lastLogin DateTime?
}

model customer_users {
  id          String    @id
  customerId  String
  userId      String
  role        String
  permissions Json?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  customers   customers @relation(fields: [customerId], references: [id], onDelete: Cascade)
  users       users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([customerId, userId])
}

model customers {
  id                        String                      @id
  company                   String
  owner                     String
  email                     String                      @unique
  phone                     String?
  website                   String?
  taxId                     String?
  industry                  String?
  companySize               String?
  planId                    String?
  billingCycle              String                      @default("monthly")
  mrr                       Float                       @default(0)
  trialEndsAt               DateTime?
  subscriptionStartDate     DateTime?
  status                    String                      @default("trial")
  lastLogin                 DateTime?
  propertyLimit             Int                         @default(5)
  userLimit                 Int                         @default(3)
  storageLimit              Int                         @default(1000)
  street                    String?
  city                      String?
  state                     String?
  postalCode                String?
  country                   String                      @default("Nigeria")
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  propertiesCount           Int                         @default(0)
  unitsCount                Int                         @default(0)
  notes                     String?
  timezone                  String?
  language                  String?
  yearEstablished           String?
  licenseNumber             String?
  insuranceProvider         String?
  insurancePolicy           String?
  insuranceExpiration       String?
  activity_logs             activity_logs[]
  customer_users            customer_users[]
  plans                     plans?                      @relation(fields: [planId], references: [id])
  documents                 documents[]
  invoices                  invoices[]
  payment_methods           payment_methods[]
  payment_settings          payment_settings[]
  payments                  payments[]
  properties                properties[]
  property_key_transactions property_key_transactions[]
  property_keys             property_keys[]
  support_tickets           support_tickets[]
  users                     users[]
  mrr_snapshots             mrr_snapshots[]
}

model mrr_snapshots {
  id          String    @id @default(uuid())
  customerId  String
  month       DateTime  // First day of the month
  mrr         Float     @default(0)
  planId      String?
  planName    String?
  status      String    // active, trial, cancelled
  billingCycle String?  // monthly, annual
  createdAt   DateTime  @default(now())
  customers   customers @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, month])
  @@index([month])
  @@index([customerId])
}

model documents {
  id                                  String      @id
  customerId                          String
  propertyId                          String?
  unitId                              String?
  tenantId                            String?
  managerId                           String?
  name                                String
  type                                String
  category                            String
  fileUrl                             String
  fileSize                            Int?
  format                              String?
  description                         String?
  uploadedBy                          String
  uploadedById                        String
  status                              String      @default("active")
  metadata                            Json?
  isShared                            Boolean     @default(false)
  sharedWith                          String[]    @default([])
  expiresAt                           DateTime?
  createdAt                           DateTime    @default(now())
  updatedAt                           DateTime
  customers                           customers   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  users_documents_managerIdTousers    users?      @relation("documents_managerIdTousers", fields: [managerId], references: [id])
  properties                          properties? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  users_documents_tenantIdTousers     users?      @relation("documents_tenantIdTousers", fields: [tenantId], references: [id], onDelete: Cascade)
  units                               units?      @relation(fields: [unitId], references: [id])
  users_documents_uploadedByIdTousers users       @relation("documents_uploadedByIdTousers", fields: [uploadedById], references: [id])
}

model expenses {
  id                               String     @id
  propertyId                       String
  unitId                           String?
  category                         String
  description                      String
  amount                           Float
  currency                         String     @default("NGN")
  date                             DateTime   @default(now())
  dueDate                          DateTime?
  status                           String     @default("pending")
  paidDate                         DateTime?
  paymentMethod                    String?
  recordedBy                       String
  recordedByRole                   String
  receipt                          String?
  notes                            String?
  requiresApproval                 Boolean    @default(false)
  approvedBy                       String?
  approvedAt                       DateTime?
  visibleToManager                 Boolean    @default(false)
  createdAt                        DateTime   @default(now())
  updatedAt                        DateTime
  users_expenses_approvedByTousers users?     @relation("expenses_approvedByTousers", fields: [approvedBy], references: [id])
  properties                       properties @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  users_expenses_recordedByTousers users      @relation("expenses_recordedByTousers", fields: [recordedBy], references: [id])
  units                            units?     @relation(fields: [unitId], references: [id])

  @@index([category])
  @@index([date])
  @@index([propertyId])
  @@index([status])
  @@index([visibleToManager])
}

model invoices {
  id            String     @id
  customerId    String
  invoiceNumber String     @unique
  amount        Float
  currency      String     @default("NGN")
  status        String     @default("pending")
  dueDate       DateTime
  paidAt        DateTime?
  billingPeriod String
  description   String?
  items         Json
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  refundedAt    DateTime?
  customers     customers  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  payments      payments[]
  refunds       refunds[]
}

model leases {
  id                String     @id
  propertyId        String
  unitId            String?
  tenantId          String
  leaseNumber       String     @unique
  startDate         DateTime
  endDate           DateTime
  monthlyRent       Float
  securityDeposit   Float
  currency          String     @default("NGN")
  status            String     @default("active")
  terms             String?
  specialClauses    Json?
  signedAt          DateTime?
  terminatedAt      DateTime?
  terminationReason String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime
  properties        properties @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  users             users      @relation(fields: [tenantId], references: [id])
  units             units?     @relation(fields: [unitId], references: [id])
  payments          payments[]
}

model payment_methods {
  id                String     @id
  tenantId          String
  customerId        String
  type              String     @default("card")
  provider          String     @default("paystack")
  authorizationCode String?
  cardBrand         String?
  cardLast4         String?
  cardExpMonth      String?
  cardExpYear       String?
  cardBin           String?
  cardType          String?
  bank              String?
  accountName       String?
  isDefault         Boolean    @default(false)
  isActive          Boolean    @default(true)
  metadata          Json?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime
  customers         customers  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  users             users      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments          payments[]

  @@index([customerId])
  @@index([isActive])
  @@index([isDefault])
  @@index([tenantId])
}

model payment_settings {
  id                   String    @id
  customerId           String
  provider             String
  publicKey            String?
  secretKey            String?
  testMode             Boolean   @default(false)
  isEnabled            Boolean   @default(false)
  bankTransferTemplate String?
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime
  customers            customers @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, provider])
}

model payments {
  id                String           @id
  customerId        String
  propertyId        String?
  unitId            String?
  leaseId           String?
  tenantId          String?
  invoiceId         String?
  amount            Float
  currency          String           @default("NGN")
  status            String           @default("pending")
  type              String           @default("rent")
  paymentMethod     String?
  provider          String
  providerReference String?
  providerFee       Float?
  paidAt            DateTime?
  metadata          Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  paymentMethodId   String?
  customers         customers        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoices          invoices?        @relation(fields: [invoiceId], references: [id])
  leases            leases?          @relation(fields: [leaseId], references: [id])
  payment_methods   payment_methods? @relation(fields: [paymentMethodId], references: [id])
  properties        properties?      @relation(fields: [propertyId], references: [id])
  users             users?           @relation(fields: [tenantId], references: [id])
  units             units?           @relation(fields: [unitId], references: [id])

  @@index([customerId])
  @@index([leaseId])
  @@index([paymentMethodId])
  @@index([propertyId])
  @@index([provider])
  @@index([status])
}

model plans {
  id            String      @id
  name          String      @unique
  description   String?
  monthlyPrice  Float
  annualPrice   Float
  currency      String      @default("NGN")
  propertyLimit Int
  userLimit     Int
  storageLimit  Int
  features      Json
  isActive      Boolean     @default(true)
  isPopular     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  customers     customers[]
}

model properties {
  id                    String                 @id
  customerId            String
  ownerId               String
  name                  String
  propertyType          String
  address               String
  city                  String
  state                 String
  postalCode            String
  country               String                 @default("Nigeria")
  yearBuilt             Int?
  totalUnits            Int
  floors                Int?
  totalArea             Float?
  lotSize               Float?
  parking               Int?
  currency              String                 @default("NGN")
  avgRent               Float?
  status                String                 @default("active")
  features              Json?
  unitFeatures          Json?
  insuranceProvider     String?
  insurancePolicyNumber String?
  insurancePremium      Float?
  insuranceExpiration   DateTime?
  propertyTaxes         Float?
  coverImage            String?
  images                Json?
  description           String?
  notes                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime
  securityDeposit       Float?
  applicationFee        Float?
  cautionFee            Float?
  legalFee              Float?
  agentCommission       Float?
  serviceCharge         Float?
  agreementFee          Float?
  purchasePrice         Float?
  currentValue          Float?
  documents             documents[]
  expenses              expenses[]
  leases                leases[]
  payments              payments[]
  customers             customers              @relation(fields: [customerId], references: [id], onDelete: Cascade)
  users                 users                  @relation(fields: [ownerId], references: [id])
  property_keys         property_keys[]
  property_managers     property_managers[]
  units                 units[]
  maintenance_requests  maintenance_requests[]
}

model property_key_transactions {
  id                                                        String        @id
  keyId                                                     String
  customerId                                                String
  action                                                    String
  performedById                                             String?
  performedByName                                           String?
  performedForUserId                                        String?
  performedForName                                          String?
  personType                                                String?
  witnessName                                               String?
  witnessSignature                                          String?
  depositAmount                                             Float?
  notes                                                     String?
  metadata                                                  Json?
  createdAt                                                 DateTime      @default(now())
  customers                                                 customers     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  property_keys                                             property_keys @relation(fields: [keyId], references: [id], onDelete: Cascade)
  users_property_key_transactions_performedByIdTousers      users?        @relation("property_key_transactions_performedByIdTousers", fields: [performedById], references: [id])
  users_property_key_transactions_performedForUserIdTousers users?        @relation("property_key_transactions_performedForUserIdTousers", fields: [performedForUserId], references: [id])

  @@index([action])
  @@index([customerId])
  @@index([keyId])
}

model property_keys {
  id                                        String                      @id
  customerId                                String
  propertyId                                String
  unitId                                    String?
  keyNumber                                 String                      @unique
  keyLabel                                  String?
  keyType                                   String
  status                                    String                      @default("available")
  numberOfCopies                            Int                         @default(1)
  location                                  String?
  notes                                     String?
  issuedToUserId                            String?
  issuedToName                              String?
  issuedToType                              String?
  issuedDate                                DateTime?
  expectedReturnDate                        DateTime?
  returnedDate                              DateTime?
  depositAmount                             Float?
  depositCurrency                           String?                     @default("NGN")
  depositRefunded                           Boolean                     @default(false)
  depositNotes                              String?
  createdById                               String?
  updatedById                               String?
  createdAt                                 DateTime                    @default(now())
  updatedAt                                 DateTime
  property_key_transactions                 property_key_transactions[]
  users_property_keys_createdByIdTousers    users?                      @relation("property_keys_createdByIdTousers", fields: [createdById], references: [id])
  customers                                 customers                   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  users_property_keys_issuedToUserIdTousers users?                      @relation("property_keys_issuedToUserIdTousers", fields: [issuedToUserId], references: [id])
  properties                                properties                  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  units                                     units?                      @relation(fields: [unitId], references: [id])
  users_property_keys_updatedByIdTousers    users?                      @relation("property_keys_updatedByIdTousers", fields: [updatedById], references: [id])

  @@index([customerId])
  @@index([keyType])
  @@index([propertyId])
  @@index([status])
}

model property_managers {
  id          String     @id
  propertyId  String
  managerId   String
  permissions Json?
  isActive    Boolean    @default(true)
  assignedAt  DateTime   @default(now())
  users       users      @relation(fields: [managerId], references: [id])
  properties  properties @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, managerId])
}

model refunds {
  id         String   @id
  invoiceId  String
  amount     Float
  currency   String   @default("NGN")
  reason     String?
  actorId    String?
  externalId String?
  metadata   Json?
  createdAt  DateTime @default(now())
  invoices   invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model roles {
  id          String   @id
  name        String   @unique
  description String?
  permissions Json
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model support_tickets {
  id           String    @id
  customerId   String
  ticketNumber String    @unique
  subject      String
  description  String
  category     String
  priority     String    @default("medium")
  status       String    @default("open")
  assignedTo   String?
  resolution   String?
  resolvedAt   DateTime?
  attachments  Json?
  tags         String[]  @default([])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  customers    customers @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model system_settings {
  id          String   @id
  key         String   @unique
  value       Json
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model units {
  id                   String                 @id
  propertyId           String
  unitNumber           String
  type                 String
  floor                Int?
  bedrooms             Int
  bathrooms            Float
  size                 Float?
  monthlyRent          Float
  securityDeposit      Float?
  status               String                 @default("vacant")
  features             Json?
  images               Json?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  documents            documents[]
  expenses             expenses[]
  leases               leases[]
  payments             payments[]
  property_keys        property_keys[]
  properties           properties             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  maintenance_requests maintenance_requests[]

  @@unique([propertyId, unitNumber])
}

model users {
  id                                                                            String                      @id
  customerId                                                                    String?
  name                                                                          String
  email                                                                         String                      @unique
  password                                                                      String?
  phone                                                                         String?
  role                                                                          String
  department                                                                    String?
  company                                                                       String?
  baseCurrency                                                                  String                      @default("USD")
  isActive                                                                      Boolean                     @default(true)
  status                                                                        String                      @default("pending")
  lastLogin                                                                     DateTime?
  invitedAt                                                                     DateTime?
  acceptedAt                                                                    DateTime?
  permissions                                                                   Json?
  avatar                                                                        String?
  createdAt                                                                     DateTime                    @default(now())
  updatedAt                                                                     DateTime
  activity_logs                                                                 activity_logs[]
  customer_users                                                                customer_users[]
  documents_documents_managerIdTousers                                          documents[]                 @relation("documents_managerIdTousers")
  documents_documents_tenantIdTousers                                           documents[]                 @relation("documents_tenantIdTousers")
  documents_documents_uploadedByIdTousers                                       documents[]                 @relation("documents_uploadedByIdTousers")
  expenses_expenses_approvedByTousers                                           expenses[]                  @relation("expenses_approvedByTousers")
  expenses_expenses_recordedByTousers                                           expenses[]                  @relation("expenses_recordedByTousers")
  leases                                                                        leases[]
  payment_methods                                                               payment_methods[]
  payments                                                                      payments[]
  properties                                                                    properties[]
  property_key_transactions_property_key_transactions_performedByIdTousers      property_key_transactions[] @relation("property_key_transactions_performedByIdTousers")
  property_key_transactions_property_key_transactions_performedForUserIdTousers property_key_transactions[] @relation("property_key_transactions_performedForUserIdTousers")
  property_keys_property_keys_createdByIdTousers                                property_keys[]             @relation("property_keys_createdByIdTousers")
  property_keys_property_keys_issuedToUserIdTousers                             property_keys[]             @relation("property_keys_issuedToUserIdTousers")
  property_keys_property_keys_updatedByIdTousers                                property_keys[]             @relation("property_keys_updatedByIdTousers")
  property_managers                                                             property_managers[]
  maintenance_requests_maintenance_requests_reportedByIdTousers                 maintenance_requests[]      @relation("maintenance_requests_reportedByIdTousers")
  maintenance_requests_maintenance_requests_assignedToIdTousers                 maintenance_requests[]      @relation("maintenance_requests_assignedToIdTousers")
  maintenance_updates                                                           maintenance_updates[]
  customers                                                                     customers?                  @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model maintenance_requests {
  id                String    @id @default(cuid())
  customerId        String
  propertyId        String
  unitId            String?
  reportedById      String
  assignedToId      String?
  ticketNumber      String    @unique
  title             String
  description       String
  category          String
  priority          String    @default("medium")
  status            String    @default("open")
  images            Json?
  preferredSchedule DateTime?
  scheduledDate     DateTime?
  estimatedCost     Float?
  actualCost        Float?
  completedAt       DateTime?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  property   properties            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit       units?                @relation(fields: [unitId], references: [id], onDelete: SetNull)
  reportedBy users                 @relation("maintenance_requests_reportedByIdTousers", fields: [reportedById], references: [id])
  assignedTo users?                @relation("maintenance_requests_assignedToIdTousers", fields: [assignedToId], references: [id])
  updates    maintenance_updates[]
}

model maintenance_updates {
  id                   String               @id @default(cuid())
  requestId            String
  updatedById          String
  note                 String
  status               String?
  attachments          Json?                @default("[]")
  createdAt            DateTime             @default(now())
  maintenance_requests maintenance_requests @relation(fields: [requestId], references: [id], onDelete: Cascade)
  updatedBy            users                @relation(fields: [updatedById], references: [id])
}
