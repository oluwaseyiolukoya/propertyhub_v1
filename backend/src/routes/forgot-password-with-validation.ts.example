// ALTERNATIVE VERSION: With email validation (less secure, better UX)
// This version tells users if their email is not registered

import express, { Request, Response } from 'express';
import prisma from '../lib/db';
import bcrypt from 'bcryptjs';
import crypto from 'crypto';
import { sendPasswordResetEmail } from '../lib/email';

const router = express.Router();

/**
 * POST /api/forgot-password
 * Request a temporary password reset (with email validation)
 */
router.post('/', async (req: Request, res: Response) => {
  try {
    const { email } = req.body;

    if (!email) {
      return res.status(400).json({
        success: false,
        error: 'Email is required'
      });
    }

    console.log('[Forgot Password] Request for email:', email);

    // Check if email exists across all user tables
    let account: any = null;
    let accountType: string = '';
    let tableName: string = '';

    // 1. Check users table
    const user = await prisma.users.findUnique({
      where: { email: email.toLowerCase() },
      select: {
        id: true,
        email: true,
        name: true,
        role: true,
        isActive: true
      }
    });

    if (user) {
      account = user;
      accountType = 'User';
      tableName = 'users';
      console.log('[Forgot Password] Found in users table, role:', user.role);
    }

    // 2. Check admins table
    if (!account) {
      const admin = await prisma.admins.findUnique({
        where: { email: email.toLowerCase() },
        select: {
          id: true,
          email: true,
          name: true,
          role: true,
          isActive: true
        }
      });

      if (admin) {
        account = admin;
        accountType = 'Admin';
        tableName = 'admins';
        console.log('[Forgot Password] Found in admins table, role:', admin.role);
      }
    }

    // 3. Check customers table
    if (!account) {
      const customer = await prisma.customers.findUnique({
        where: { email: email.toLowerCase() },
        select: {
          id: true,
          email: true,
          owner: true,
          status: true
        }
      });

      if (customer) {
        account = {
          id: customer.id,
          email: customer.email,
          name: customer.owner,
          isActive: customer.status === 'active' || customer.status === 'trial'
        };
        accountType = 'Customer';
        tableName = 'customers';
        console.log('[Forgot Password] Found in customers table');
      }
    }

    // 4. Check onboarding_applications table
    if (!account) {
      const application = await prisma.onboarding_applications.findUnique({
        where: { email: email.toLowerCase() },
        select: {
          id: true,
          email: true,
          name: true,
          status: true
        }
      });

      if (application) {
        account = {
          id: application.id,
          email: application.email,
          name: application.name,
          isActive: application.status === 'approved'
        };
        accountType = 'Applicant';
        tableName = 'onboarding_applications';
        console.log('[Forgot Password] Found in onboarding_applications table');
      }
    }

    // ⚠️ OPTION 2: Tell user if email not found (less secure)
    if (!account) {
      console.log('[Forgot Password] Email not found:', email);
      return res.status(404).json({
        success: false,
        error: 'No account found with this email address. Please check your email or sign up for a new account.'
      });
    }

    // Check if account is active
    if (!account.isActive) {
      console.log('[Forgot Password] Account inactive:', email);
      return res.status(403).json({
        success: false,
        error: 'This account is currently inactive. Please contact support for assistance.'
      });
    }

    // Generate temporary password (8 characters: letters + numbers)
    const tempPassword = crypto.randomBytes(4).toString('hex').toUpperCase();
    console.log('[Forgot Password] Generated temporary password for:', email);

    // Hash the temporary password
    const hashedPassword = await bcrypt.hash(tempPassword, 10);

    // Update password in the appropriate table
    try {
      switch (tableName) {
        case 'users':
          await prisma.users.update({
            where: { id: account.id },
            data: { password: hashedPassword }
          });
          break;

        case 'admins':
          await prisma.admins.update({
            where: { id: account.id },
            data: { password: hashedPassword }
          });
          break;

        case 'customers':
          console.log('[Forgot Password] Warning: Customers table does not have password field');
          return res.status(400).json({
            success: false,
            error: 'Password reset not available for customer accounts. Please contact support.'
          });

        case 'onboarding_applications':
          console.log('[Forgot Password] Warning: Applications table does not have password field');
          return res.status(400).json({
            success: false,
            error: 'Password reset not available for pending applications. Please contact support.'
          });

        default:
          console.error('[Forgot Password] Unknown table:', tableName);
          return res.status(500).json({
            success: false,
            error: 'Unable to process password reset. Please contact support.'
          });
      }

      console.log('[Forgot Password] Password updated in', tableName, 'for:', email);
    } catch (updateError: any) {
      console.error('[Forgot Password] Failed to update password:', updateError);
      return res.status(500).json({
        success: false,
        error: 'Failed to update password. Please try again or contact support.'
      });
    }

    // Send email with temporary password
    console.log('[Forgot Password] Attempting to send email to:', email);

    const emailResult = await sendPasswordResetEmail({
      to: account.email,
      name: account.name,
      temporaryPassword: tempPassword,
      accountType: accountType
    });

    if (!emailResult.success) {
      console.error('[Forgot Password] ❌ Failed to send email to:', email);
      console.error('[Forgot Password] Error details:', emailResult.error);

      // Rollback password change if email fails
      if (tableName === 'users' || tableName === 'admins') {
        console.log('[Forgot Password] Email failed - temporary password set but not delivered');
      }

      return res.status(500).json({
        success: false,
        error: 'Failed to send email. Please try again or contact support.',
        details: process.env.NODE_ENV === 'development' ? emailResult.error : undefined
      });
    }

    console.log('[Forgot Password] ✅ Email sent successfully to:', email);
    console.log('[Forgot Password] Message ID:', emailResult.messageId);

    return res.json({
      success: true,
      message: 'A temporary password has been sent to your email address.',
      emailVerified: true,
      messageId: process.env.NODE_ENV === 'development' ? emailResult.messageId : undefined
    });

  } catch (error: any) {
    console.error('[Forgot Password] Error:', error);
    return res.status(500).json({
      success: false,
      error: 'An error occurred while processing your request. Please try again later.'
    });
  }
});

export default router;

