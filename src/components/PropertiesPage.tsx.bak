import React, {
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "./ui/card";
import { Badge } from "./ui/badge";
import { Button } from "./ui/button";
import { Input } from "./ui/input";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "./ui/table";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "./ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "./ui/tabs";
import { Progress } from "./ui/progress";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "./ui/dropdown-menu";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "./ui/dialog";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "./ui/tooltip";
import { toast } from "sonner";
import {
  getUnits,
  createUnit,
  updateUnit,
  deleteUnit,
  getUnit,
} from "../lib/api/units";
import { archiveProperty, deleteProperty } from "../lib/api/properties";
import { Switch } from "./ui/switch";
import {
  getMaintenanceRequests,
  createMaintenanceRequest,
  updateMaintenanceRequest,
  deleteMaintenanceRequest,
} from "../lib/api/maintenance";
import { getOwnerDashboardOverview } from "../lib/api";
import {
  getFinancialOverview,
  getMonthlyRevenue,
  type MonthlyRevenueData,
} from "../lib/api/financial";
import { formatCurrency, getSmartBaseCurrency } from "../lib/currency";
import { usePersistentState } from "../lib/usePersistentState";
import {
  getExpenses,
  createExpense,
  updateExpense,
  deleteExpense,
  getExpenseStats,
  EXPENSE_CATEGORIES,
  EXPENSE_STATUSES,
  PAYMENT_METHODS,
  type Expense,
} from "../lib/api/expenses";
import { Label } from "./ui/label";
import { Textarea } from "./ui/textarea";
import { Popover, PopoverContent, PopoverTrigger } from "./ui/popover";
import { Calendar as CalendarComponent } from "./ui/calendar";
import {
  Building2,
  Users,
  DollarSign,
  TrendingUp,
  Eye,
  Edit,
  MoreHorizontal,
  Plus,
  MapPin,
  Calendar,
  Home,
  Bed,
  Bath,
  Wrench,
  CheckCircle,
  AlertTriangle,
  Clock,
  Info,
  FileText,
  Download,
  BarChart3,
  Trash2,
  PieChart,
  LineChart,
  Activity,
  Percent,
  TrendingDown,
  ArrowUpRight,
  ArrowDownRight,
  MoreVertical,
  Loader2,
  Send,
  Copy,
  Archive,
  ExternalLink,
  Zap,
  Shield,
  Settings,
  Upload,
  FileSpreadsheet,
  AlertCircle,
  X,
  Search,
  Maximize,
} from "lucide-react";
import { createProperty } from "../lib/api/properties";

interface PropertiesPageProps {
  user: any;
  onBack: () => void;
  onAddProperty?: (propertyData: any) => void;
  onNavigateToAddProperty?: () => void;
  properties: any[];
  onUpdateProperty?: (propertyId: number, updates: any) => void;
  onViewProperty?: (propertyId: string) => void;
  onEditProperty?: (propertyId: string) => void;
  onNavigateToTenants?: () => void;
  onNavigateToMaintenance?: () => void;
  onRefreshProperties?: () => void;
  onPropertyDeleted?: (propertyId: string) => void;
}

type ReportType = "financial" | "occupancy" | "maintenance" | "tenant" | "all";
type SingleReportType = Exclude<ReportType, "all">;

interface GeneratedReport {
  type: ReportType;
  generatedAt: string;
  filters: {
    propertyId: string;
    startDate: string | null;
    endDate: string | null;
  };
  data: any;
}

const REPORT_TYPE_LABELS: Record<ReportType, string> = {
  financial: "Financial",
  occupancy: "Occupancy",
  maintenance: "Maintenance",
  tenant: "Tenant",
  all: "All",
};

const ALL_REPORT_TYPES: SingleReportType[] = [
  "financial",
  "occupancy",
  "maintenance",
  "tenant",
];

const expenseCategoryIconMap: Record<
  string,
  React.ComponentType<{ className?: string }>
> = {
  maintenance: Wrench,
  utilities: Zap,
  insurance: Shield,
  management_fee: Users,
  property_tax: FileText,
};

const MAINTENANCE_CATEGORIES = [
  { value: "general", label: "General" },
  { value: "plumbing", label: "Plumbing" },
  { value: "electrical", label: "Electrical" },
  { value: "hvac", label: "HVAC" },
  { value: "landscaping", label: "Landscaping" },
  { value: "safety", label: "Safety" },
];

export function PropertiesPage({
  user,
  onBack,
  onAddProperty,
  onNavigateToAddProperty,
  properties,
  onUpdateProperty,
  onViewProperty,
  onEditProperty,
  onNavigateToTenants,
  onNavigateToMaintenance,
  onRefreshProperties,
  onPropertyDeleted,
}: PropertiesPageProps) {
  const [activeTab, setActiveTab] = usePersistentState(
    "properties-page-tab",
    "overview"
  );
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [viewMode, setViewMode] = useState<"grid" | "list">("grid");
  const [unitsViewMode, setUnitsViewMode] = useState<"grid" | "list">("grid");
  const [unitsCurrentPage, setUnitsCurrentPage] = useState(1);
  const [unitsSearchTerm, setUnitsSearchTerm] = useState("");
  const [unitsPropertyFilter, setUnitsPropertyFilter] = useState("all");
  const [unitsStatusFilter, setUnitsStatusFilter] = useState<"all" | "occupied" | "vacant" | "maintenance">("all");
  const UNITS_PER_PAGE = 10;

  // Calculate smart base currency based on properties
  const smartBaseCurrency = getSmartBaseCurrency(properties);
  const [unitsData, setUnitsData] = useState<any[]>([]);
  const [showAddUnitDialog, setShowAddUnitDialog] = useState(false);
  const [unitSaving, setUnitSaving] = useState(false);
  const [unitForm, setUnitForm] = useState<any>({
    propertyId: "",
    unitNumber: "",
    type: "",
    floor: "",
    bedrooms: "",
    bathrooms: "",
    size: "",
    monthlyRent: "",
    securityDeposit: "",
    status: "vacant",
    rentFrequency: "monthly",
    serviceCharge: "",
    legalFee: "",
    agentCommission: "",
    agreementFee: "",
    electricityMeter: "",
    prepaidMeter: false,
    wasteFee: "",
    estateDues: "",
    waterSource: "public",
    parkingAvailable: true,
  });
  const [maintenanceData, setMaintenanceData] = useState<any[]>([]);
  const [recentActivity, setRecentActivity] = useState<any[]>([]);
  const [reportType, setReportType] = useState<ReportType>("financial");
  const [reportPropertyFilter, setReportPropertyFilter] = useState("all");
  const [reportStartDate, setReportStartDate] = useState("");
  const [reportEndDate, setReportEndDate] = useState("");
  const [reportPreview, setReportPreview] = useState<GeneratedReport | null>(
    null
  );
  const [reportGenerating, setReportGenerating] = useState(false);
  const reportPreviewRef = useRef<HTMLDivElement | null>(null);
  
  // Email report dialog state
  const [showEmailDialog, setShowEmailDialog] = useState(false);
  const [emailReportTo, setEmailReportTo] = useState(user?.email || "");
  const [isSendingEmail, setIsSendingEmail] = useState(false);
  
  const [financialStats, setFinancialStats] = useState<{
    gross?: number;
    net?: number;
    expenses?: number;
    capRate?: number;
    occupancyRate?: number;
    operatingMargin?: number;
  }>({});
  const [monthlyRevenueData, setMonthlyRevenueData] = useState<
    MonthlyRevenueData[]
  >([]);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [unitToDelete, setUnitToDelete] = useState<any>(null);
  const [isDeleting, setIsDeleting] = useState(false);
  const [showPropertyDeleteDialog, setShowPropertyDeleteDialog] =
    useState(false);
  const [propertyToDelete, setPropertyToDelete] = useState<any>(null);
  const [deletedPropertyIds, setDeletedPropertyIds] = useState<Set<string>>(
    new Set()
  );
  const [isDeletingProperty, setIsDeletingProperty] = useState(false);

  // Expense management states
  const [expenses, setExpenses] = useState<Expense[]>([]);
  const [expenseStats, setExpenseStats] = useState<any>(null);
  const [showExpenseDialog, setShowExpenseDialog] = useState(false);
  const [expenseForm, setExpenseForm] = useState<any>({
    propertyId: "",
    unitId: "none",
    category: "",
    description: "",
    amount: "",
    currency: "",
    date: new Date().toISOString().split("T")[0],
    dueDate: "",
    status: "pending",
    paymentMethod: "",
    notes: "",
  });
  const [editingExpense, setEditingExpense] = useState<Expense | null>(null);
  const [expenseSaving, setExpenseSaving] = useState(false);
  const [expenseToDelete, setExpenseToDelete] = useState<Expense | null>(null);
  const [showExpenseDeleteDialog, setShowExpenseDeleteDialog] = useState(false);
  const [showAddMaintenanceDialog, setShowAddMaintenanceDialog] =
    useState(false);
  const [maintenanceSaving, setMaintenanceSaving] = useState(false);
  const [maintenanceEditingId, setMaintenanceEditingId] = useState<
    string | null
  >(null);
  const [maintenanceForm, setMaintenanceForm] = useState({
    propertyId: "",
    unitId: "none",
    title: "",
    description: "",
    priority: "medium",
    category: "general",
    scheduledDate: "",
    notifyTenant: false,
  });
  const [showFinancialDetailDialog, setShowFinancialDetailDialog] =
    useState(false);
  const [financialDetailProperty, setFinancialDetailProperty] =
    useState<null | {
      property: any;
      monthlyRevenue: number;
      totalExpenses: number;
      netIncome: number;
      occupancyRate: number;
      propertyExpenses: Expense[];
    }>(null);

  // View and Edit Unit states
  const [showViewUnitDialog, setShowViewUnitDialog] = useState(false);
  const [showEditUnitDialog, setShowEditUnitDialog] = useState(false);
  const [selectedUnit, setSelectedUnit] = useState<any>(null);
  const [editingUnit, setEditingUnit] = useState(false);
  const [selectedMaintenanceRequest, setSelectedMaintenanceRequest] =
    useState<any>(null);
  const [showMaintenanceViewDialog, setShowMaintenanceViewDialog] =
    useState(false);

  // Import Properties states
  const [showImportDialog, setShowImportDialog] = useState(false);
  const [importFile, setImportFile] = useState<File | null>(null);
  const [importData, setImportData] = useState<any[]>([]);
  const [importErrors, setImportErrors] = useState<string[]>([]);
  const [isImporting, setIsImporting] = useState(false);
  const [importProgress, setImportProgress] = useState(0);
  const [importResults, setImportResults] = useState<{
    success: number;
    failed: number;
    errors: string[];
  } | null>(null);

  // Derived helpers for currently selected unit (view/edit)
  const selectedUnitNigeria =
    (selectedUnit &&
      selectedUnit.features &&
      (selectedUnit.features as any).nigeria) ||
    {};
  const selectedUnitCurrency = selectedUnit?.properties?.currency || "USD";

  const refreshMaintenanceRequests = useCallback(async () => {
    try {
      const response = await getMaintenanceRequests();
      if (!response.error && Array.isArray(response.data)) {
        setMaintenanceData(response.data);
      }
    } catch (err) {
      console.error("Failed to load maintenance requests", err);
      toast.error("Unable to load maintenance requests");
    }
  }, []);

  useEffect(() => {
    (async () => {
      try {
        const [uRes, mRes, dRes, fRes, expRes, expStatsRes, monthlyRevenueRes] =
          await Promise.all([
            getUnits(),
            getMaintenanceRequests(),
            getOwnerDashboardOverview(),
            getFinancialOverview(),
            getExpenses(),
            getExpenseStats(),
            getMonthlyRevenue(6),
          ]);
        if (!uRes.error && Array.isArray(uRes.data)) setUnitsData(uRes.data);
        if (!mRes.error && Array.isArray(mRes.data))
          setMaintenanceData(mRes.data);
        if (!dRes.error && dRes.data?.recentActivity)
          setRecentActivity(dRes.data.recentActivity);
        if (!fRes.error && fRes.data) {
          // Use real financial data from backend
          const gross = Number(fRes.data.totalRevenue || 0);
          const expenses = Number(fRes.data.estimatedExpenses || 0);
          const net = Number(fRes.data.netOperatingIncome || 0);
          const capRate = Number(fRes.data.portfolioCapRate || 0);
          const occupancyRate = Number(fRes.data.occupancyRate || 0);
          const operatingMargin = Number(
            fRes.data.operatingMargin || (gross > 0 ? (net / gross) * 100 : 0)
          );
          setFinancialStats({
            gross,
            net,
            expenses,
            capRate,
            occupancyRate,
            operatingMargin,
          });
        }
        if (
          !expRes.error &&
          expRes.data?.data &&
          Array.isArray(expRes.data.data)
        ) {
          setExpenses(expRes.data.data);
        }
        if (!expStatsRes.error && expStatsRes.data) {
          setExpenseStats(expStatsRes.data);
        }
        if (!monthlyRevenueRes.error && Array.isArray(monthlyRevenueRes.data)) {
          setMonthlyRevenueData(monthlyRevenueRes.data);
        }
      } catch (e: any) {
        // Non-blocking: show a toast once
        toast.error("Failed to load financial data");
      }
    })();
  }, [properties.length, refreshMaintenanceRequests]);

  // Handle delete unit
  const handleDeleteUnit = async () => {
    if (!unitToDelete) return;

    try {
      setIsDeleting(true);
      const res = await deleteUnit(unitToDelete.id);

      if ((res as any).error) {
        throw new Error((res as any).error.error || "Failed to delete unit");
      }

      toast.success("Unit deleted successfully");
      setShowDeleteDialog(false);
      setUnitToDelete(null);

      // Refresh units list
      const uRes = await getUnits();
      if (!uRes.error && Array.isArray(uRes.data)) {
        setUnitsData(uRes.data);
      }
    } catch (error: any) {
      toast.error(error?.message || "Failed to delete unit");
    } finally {
      setIsDeleting(false);
    }
  };

  // Handle view unit details
  const handleViewUnit = async (unit: any) => {
    try {
      const res = await getUnit(unit.id);
      if (res.error) {
        throw new Error(res.error.error || "Failed to fetch unit details");
      }
      setSelectedUnit(res.data);
      setShowViewUnitDialog(true);
    } catch (error: any) {
      toast.error(error?.message || "Failed to load unit details");
    }
  };

  // Handle edit unit
  const handleEditUnit = async (unit: any) => {
    try {
      const res = await getUnit(unit.id);
      if (res.error) {
        throw new Error(res.error.error || "Failed to fetch unit details");
      }

      const data = res.data;
      // Newer units store Nigeria-specific fields inside features.nigeria
      const nigeriaFeatures =
        (data?.features && (data.features as any).nigeria) || {};

      // Populate form with unit data (prefer features.nigeria, fall back to top-level / property defaults)
      setUnitForm({
        propertyId: data.propertyId || "",
        unitNumber: data.unitNumber || "",
        type: data.type || "",
        floor: (data.floor ?? "").toString(),
        bedrooms: (data.bedrooms ?? "").toString(),
        bathrooms: (data.bathrooms ?? "").toString(),
        size: (data.size ?? "").toString(),
        monthlyRent: (data.monthlyRent ?? "").toString(),
        securityDeposit: (
          data.securityDeposit ??
          data.properties?.securityDeposit ??
          ""
        ).toString(),
        status: data.status || "vacant",

        // Nigeria-specific features (saved in JSON)
        rentFrequency: nigeriaFeatures.rentFrequency || "monthly",
        serviceCharge:
          nigeriaFeatures.serviceCharge?.toString() ??
          (data.properties?.serviceCharge != null
            ? String(data.properties.serviceCharge)
            : ""),
        cautionFee:
          nigeriaFeatures.cautionFee?.toString() ??
          (data.properties?.cautionFee != null
            ? String(data.properties.cautionFee)
            : ""),
        legalFee:
          nigeriaFeatures.legalFee?.toString() ??
          (data.properties?.legalFee != null
            ? String(data.properties.legalFee)
            : ""),
        agentCommission:
          nigeriaFeatures.agentCommission?.toString() ??
          (data.properties?.agentCommission != null
            ? String(data.properties.agentCommission)
            : ""),
        agreementFee:
          nigeriaFeatures.agreementFee?.toString() ??
          (data.properties?.agreementFee != null
            ? String(data.properties.agreementFee)
            : ""),
        electricityMeter:
          nigeriaFeatures.electricityMeter ?? data.electricityMeter ?? "",
        prepaidMeter:
          nigeriaFeatures.prepaidMeter ?? data.prepaidMeter ?? false,
        wasteFee: nigeriaFeatures.wasteFee?.toString() || "",
        estateDues: nigeriaFeatures.estateDues?.toString() || "",
        waterSource: nigeriaFeatures.waterSource || "public",
        parkingAvailable:
          nigeriaFeatures.parkingAvailable ?? data.parkingAvailable ?? true,
      });

      setSelectedUnit(data);
      setShowEditUnitDialog(true);
    } catch (error: any) {
      toast.error(error?.message || "Failed to load unit details");
    }
  };

  // Handle save edited unit
  const handleSaveEditedUnit = async () => {
    if (!selectedUnit) return;

    try {
      setEditingUnit(true);

      // Persist core scalar fields on the unit, and pack Nigeriaâ€‘specific
      // financial/utilities data into features.nigeria (same as Add Unit flow).
      const payload: any = {
        propertyId: unitForm.propertyId,
        unitNumber: unitForm.unitNumber,
        type: unitForm.type,
        floor: unitForm.floor ? Number(unitForm.floor) : null,
        bedrooms: unitForm.bedrooms ? Number(unitForm.bedrooms) : 0,
        bathrooms: unitForm.bathrooms ? Number(unitForm.bathrooms) : 0,
        size: unitForm.size ? Number(unitForm.size) : null,
        monthlyRent: unitForm.monthlyRent ? Number(unitForm.monthlyRent) : 0,
        securityDeposit: unitForm.securityDeposit
          ? Number(unitForm.securityDeposit)
          : null,
        status: unitForm.status,
        features: {
          nigeria: {
            rentFrequency: unitForm.rentFrequency,
            serviceCharge: unitForm.serviceCharge
              ? Number(unitForm.serviceCharge)
              : undefined,
            cautionFee: unitForm.cautionFee
              ? Number(unitForm.cautionFee)
              : undefined,
            legalFee: unitForm.legalFee ? Number(unitForm.legalFee) : undefined,
            agentCommission: unitForm.agentCommission
              ? Number(unitForm.agentCommission)
              : undefined,
            agreementFee: unitForm.agreementFee
              ? Number(unitForm.agreementFee)
              : undefined,
            electricityMeter: unitForm.electricityMeter || undefined,
            prepaidMeter: unitForm.prepaidMeter,
            wasteFee: unitForm.wasteFee ? Number(unitForm.wasteFee) : undefined,
            estateDues: unitForm.estateDues
              ? Number(unitForm.estateDues)
              : undefined,
            waterSource: unitForm.waterSource,
            parkingAvailable: unitForm.parkingAvailable,
          },
        },
      };

      const res = await updateUnit(selectedUnit.id, payload);

      if ((res as any).error) {
        throw new Error((res as any).error.error || "Failed to update unit");
      }

      toast.success("Unit updated successfully");
      setShowEditUnitDialog(false);
      setSelectedUnit(null);

      // Refresh units list
      const uRes = await getUnits();
      if (!uRes.error && Array.isArray(uRes.data)) {
        setUnitsData(uRes.data);
      }
    } catch (error: any) {
      toast.error(error?.message || "Failed to update unit");
    } finally {
      setEditingUnit(false);
    }
  };

  // Import Properties Functions
  const sampleCSVData = `name,propertyType,address,city,state,postalCode,country,totalUnits,floors,yearBuilt,totalArea,lotSize,parking,currency,avgRent,securityDeposit,applicationFee,legalFee,agentCommission,serviceCharge,agreementFee,insuranceProvider,insurancePolicyNumber,insurancePremium,insuranceExpiration,propertyTaxes,description,notes,coverImage,images
"Sunrise Apartments","Apartment Complex","123 Main Street","Lagos","Lagos","100001","Nigeria","12","3","2020","5000","2500","24","NGN","150000","300000","25000","50000","150000","30000","20000","AXA Mansard","POL-2024-001","500000","2025-12-31","250000","Modern apartment complex with swimming pool, gym, and 24/7 security","Near major shopping centers","https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800","https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800|https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800"
"Palm Estate","Residential","45 Palm Avenue","Abuja","FCT","900001","Nigeria","8","2","2018","3500","1800","16","NGN","200000","400000","30000","75000","200000","40000","25000","Leadway Assurance","POL-2024-002","400000","2025-06-30","180000","Gated community with 24/7 security and backup power","Family-friendly neighborhood","https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800","https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800|https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800"
"Ocean View Towers","High Rise","78 Marina Road","Lagos","Lagos","100002","Nigeria","24","8","2022","12000","4000","50","NGN","350000","700000","50000","100000","350000","60000","35000","AIICO Insurance","POL-2024-003","800000","2025-09-15","450000","Luxury waterfront apartments with panoramic ocean views","Premium location with easy access to Victoria Island","https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800","https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800|https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800"`;

  const downloadSampleCSV = () => {
    const blob = new Blob([sampleCSVData], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "property_import_template.csv");
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    toast.success("Sample CSV template downloaded");
  };

  const parseCSV = (text: string): any[] => {
    const lines = text.split("\n").filter((line) => line.trim());
    if (lines.length < 2) return [];

    const headers = lines[0]
      .split(",")
      .map((h) => h.trim().replace(/^"|"$/g, ""));
    const data: any[] = [];

    for (let i = 1; i < lines.length; i++) {
      const values: string[] = [];
      let current = "";
      let inQuotes = false;

      for (const char of lines[i]) {
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          values.push(current.trim().replace(/^"|"$/g, ""));
          current = "";
        } else {
          current += char;
        }
      }
      values.push(current.trim().replace(/^"|"$/g, ""));

      if (values.length === headers.length) {
        const row: any = {};
        headers.forEach((header, index) => {
          row[header] = values[index];
        });
        data.push(row);
      }
    }

    return data;
  };

  const validateImportData = (
    data: any[]
  ): { valid: any[]; errors: string[] } => {
    const errors: string[] = [];
    const valid: any[] = [];
    const requiredFields = [
      "name",
      "propertyType",
      "address",
      "city",
      "state",
      "totalUnits",
    ];

    data.forEach((row, index) => {
      const rowErrors: string[] = [];

      // Check required fields
      requiredFields.forEach((field) => {
        if (!row[field] || row[field].toString().trim() === "") {
          rowErrors.push(`Missing ${field}`);
        }
      });

      // Validate numeric fields
      const numericFields = [
        "totalUnits",
        "floors",
        "yearBuilt",
        "totalArea",
        "lotSize",
        "parking",
        "avgRent",
        "securityDeposit",
        "applicationFee",
        "legalFee",
        "agentCommission",
        "serviceCharge",
        "agreementFee",
        "insurancePremium",
        "propertyTaxes",
      ];

      numericFields.forEach((field) => {
        if (
          row[field] &&
          row[field].toString().trim() !== "" &&
          isNaN(parseFloat(row[field]))
        ) {
          rowErrors.push(`${field} must be a number`);
        }
      });

      if (rowErrors.length > 0) {
        errors.push(`Row ${index + 1}: ${rowErrors.join(", ")}`);
      } else {
        // Parse images - can be pipe-separated URLs
        const imagesArray = row.images
          ? row.images
              .split("|")
              .map((url: string) => url.trim())
              .filter((url: string) => url)
          : [];

        valid.push({
          // Basic Information
          name: row.name,
          propertyType: row.propertyType,
          address: row.address,
          city: row.city,
          state: row.state,
          postalCode: row.postalCode || "",
          country: row.country || "Nigeria",

          // Property Details
          totalUnits: parseInt(row.totalUnits) || 1,
          floors: row.floors ? parseInt(row.floors) : undefined,
          yearBuilt: row.yearBuilt ? parseInt(row.yearBuilt) : undefined,
          totalArea: row.totalArea ? parseFloat(row.totalArea) : undefined,
          lotSize: row.lotSize ? parseFloat(row.lotSize) : undefined,
          parking: row.parking ? parseInt(row.parking) : undefined,

          // Financial Information
          currency: row.currency || "NGN",
          avgRent: row.avgRent ? parseFloat(row.avgRent) : undefined,
          securityDeposit: row.securityDeposit
            ? parseFloat(row.securityDeposit)
            : undefined,
          applicationFee: row.applicationFee
            ? parseFloat(row.applicationFee)
            : undefined,
          legalFee: row.legalFee ? parseFloat(row.legalFee) : undefined,
          agentCommission: row.agentCommission
            ? parseFloat(row.agentCommission)
            : undefined,
          serviceCharge: row.serviceCharge
            ? parseFloat(row.serviceCharge)
            : undefined,
          agreementFee: row.agreementFee
            ? parseFloat(row.agreementFee)
            : undefined,

          // Insurance & Legal
          insuranceProvider: row.insuranceProvider || undefined,
          insurancePolicyNumber: row.insurancePolicyNumber || undefined,
          insurancePremium: row.insurancePremium
            ? parseFloat(row.insurancePremium)
            : undefined,
          insuranceExpiration: row.insuranceExpiration || undefined,
          propertyTaxes: row.propertyTaxes
            ? parseFloat(row.propertyTaxes)
            : undefined,

          // Additional Information
          description: row.description || "",
          notes: row.notes || "",

          // Images
          coverImage:
            row.coverImage || (imagesArray.length > 0 ? imagesArray[0] : ""),
          images: imagesArray,
        });
      }
    });

    return { valid, errors };
  };

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!file.name.endsWith(".csv")) {
      toast.error("Please select a CSV file");
      return;
    }

    setImportFile(file);
    setImportErrors([]);
    setImportResults(null);

    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target?.result as string;
      const parsed = parseCSV(text);
      const { valid, errors } = validateImportData(parsed);

      setImportData(valid);
      setImportErrors(errors);

      if (valid.length === 0 && errors.length > 0) {
        toast.error("No valid properties found in the file");
      } else if (valid.length > 0) {
        toast.success(`Found ${valid.length} valid properties to import`);
      }
    };
    reader.readAsText(file);
  };

  const handleImportProperties = async () => {
    if (importData.length === 0) {
      toast.error("No valid properties to import");
      return;
    }

    setIsImporting(true);
    setImportProgress(0);

    let success = 0;
    let failed = 0;
    const errors: string[] = [];

    for (let i = 0; i < importData.length; i++) {
      const property = importData[i];

      try {
        const res = await createProperty(property);
        if (res.error) {
          throw new Error(res.error.error || "Failed to create property");
        }
        success++;
      } catch (error: any) {
        failed++;
        errors.push(`"${property.name}": ${error.message || "Unknown error"}`);
      }

      setImportProgress(Math.round(((i + 1) / importData.length) * 100));
    }

    setImportResults({ success, failed, errors });
    setIsImporting(false);

    if (success > 0) {
      toast.success(`Successfully imported ${success} properties`);
      // Trigger a refresh of the properties list
      window.location.reload();
    }

    if (failed > 0) {
      toast.error(`Failed to import ${failed} properties`);
    }
  };

  const resetImportDialog = () => {
    setShowImportDialog(false);
    setImportFile(null);
    setImportData([]);
    setImportErrors([]);
    setImportProgress(0);
    setImportResults(null);
  };

  // Expense Management Functions
  const loadExpenses = async () => {
    try {
      const [expRes, expStatsRes] = await Promise.all([
        getExpenses(),
        getExpenseStats(),
      ]);
      if (
        !expRes.error &&
        expRes.data?.data &&
        Array.isArray(expRes.data.data)
      ) {
        setExpenses(expRes.data.data);
      }
      if (!expStatsRes.error && expStatsRes.data) {
        setExpenseStats(expStatsRes.data);
      }
    } catch (error: any) {
      toast.error("Failed to load expenses");
    }
  };

  const handleAddExpense = () => {
    setEditingExpense(null);
    setExpenseForm({
      propertyId: properties[0]?.id || "",
      unitId: "none",
      category: "",
      description: "",
      amount: "",
      currency: properties[0]?.currency || "NGN",
      date: new Date().toISOString().split("T")[0],
      dueDate: "",
      status: "pending",
      paymentMethod: "",
      notes: "",
    });
    setShowExpenseDialog(true);
  };

  const handleEditExpense = (expense: Expense) => {
    setEditingExpense(expense);
    setExpenseForm({
      propertyId: expense.propertyId,
      unitId: expense.unitId || "",
      category: expense.category,
      description: expense.description,
      amount: expense.amount.toString(),
      currency: expense.currency,
      date: expense.date.split("T")[0],
      dueDate: expense.dueDate ? expense.dueDate.split("T")[0] : "",
      status: expense.status,
      paymentMethod: expense.paymentMethod || "",
      notes: expense.notes || "",
    });
    setShowExpenseDialog(true);
  };

  const handleSaveExpense = async () => {
    try {
      setExpenseSaving(true);

      if (
        !expenseForm.propertyId ||
        !expenseForm.category ||
        !expenseForm.description ||
        !expenseForm.amount
      ) {
        toast.error("Please fill in all required fields");
        return;
      }

      const expenseData = {
        propertyId: expenseForm.propertyId,
        unitId:
          expenseForm.unitId && expenseForm.unitId !== "none"
            ? expenseForm.unitId
            : undefined,
        category: expenseForm.category,
        description: expenseForm.description,
        amount: parseFloat(expenseForm.amount),
        currency: expenseForm.currency,
        date: expenseForm.date,
        dueDate: expenseForm.dueDate || undefined,
        status: expenseForm.status,
        paymentMethod: expenseForm.paymentMethod || undefined,
        notes: expenseForm.notes || undefined,
      };

      if (editingExpense) {
        const res = await updateExpense(editingExpense.id, expenseData);
        if (res.error) {
          throw new Error(
            res.error.message || res.error.error || "Failed to update expense"
          );
        }
        toast.success("Expense updated successfully");
      } else {
        const res = await createExpense(expenseData);
        if (res.error) {
          throw new Error(
            res.error.message || res.error.error || "Failed to create expense"
          );
        }
        toast.success("Expense created successfully");
      }

      setShowExpenseDialog(false);
      await loadExpenses();

      // Refresh financial overview
      const fRes = await getFinancialOverview();
      if (!fRes.error && fRes.data) {
        const gross = Number(fRes.data.totalRevenue || 0);
        const expenses = Number(fRes.data.estimatedExpenses || 0);
        const net = Number(fRes.data.netOperatingIncome || 0);
        const capRate = Number(fRes.data.portfolioCapRate || 0);
        const occupancyRate = Number(fRes.data.occupancyRate || 0);
        const operatingMargin = Number(
          fRes.data.operatingMargin || (gross > 0 ? (net / gross) * 100 : 0)
        );
        setFinancialStats({
          gross,
          net,
          expenses,
          capRate,
          occupancyRate,
          operatingMargin,
        });
      }
    } catch (error: any) {
      toast.error(error?.message || "Failed to save expense");
    } finally {
      setExpenseSaving(false);
    }
  };

  const handleDeleteExpense = async () => {
    if (!expenseToDelete) return;

    try {
      setIsDeleting(true);
      const res = await deleteExpense(expenseToDelete.id);
      if (res.error) {
        throw new Error(
          res.error.message || res.error.error || "Failed to delete expense"
        );
      }

      toast.success("Expense deleted successfully");
      setShowExpenseDeleteDialog(false);
      setExpenseToDelete(null);
      await loadExpenses();

      // Refresh financial overview
      const fRes = await getFinancialOverview();
      if (!fRes.error && fRes.data) {
        const gross = Number(fRes.data.totalRevenue || 0);
        const expenses = Number(fRes.data.estimatedExpenses || 0);
        const net = Number(fRes.data.netOperatingIncome || 0);
        const capRate = Number(fRes.data.portfolioCapRate || 0);
        const occupancyRate = Number(fRes.data.occupancyRate || 0);
        const operatingMargin = Number(
          fRes.data.operatingMargin || (gross > 0 ? (net / gross) * 100 : 0)
        );
        setFinancialStats({
          gross,
          net,
          expenses,
          capRate,
          occupancyRate,
          operatingMargin,
        });
      }
    } catch (error: any) {
      toast.error(error?.message || "Failed to delete expense");
    } finally {
      setIsDeleting(false);
    }
  };

  const handleSaveMaintenance = async () => {
    if (!maintenanceForm.propertyId || !maintenanceForm.title) {
      toast.error("Please select a property and enter a title");
      return;
    }
    if (!maintenanceForm.description) {
      toast.error("Please provide a brief description");
      return;
    }

    try {
      setMaintenanceSaving(true);
      const payload: any = {
        propertyId: maintenanceForm.propertyId,
        title: maintenanceForm.title,
        description: maintenanceForm.description,
        priority: maintenanceForm.priority,
        category: maintenanceForm.category,
      };

      if (maintenanceForm.unitId && maintenanceForm.unitId !== "none") {
        payload.unitId = maintenanceForm.unitId;
      }
      if (maintenanceForm.scheduledDate) {
        payload.scheduledDate = maintenanceForm.scheduledDate;
      }
      if (maintenanceForm.notifyTenant) {
        payload.notifyTenant = true;
      }

      let response;
      if (maintenanceEditingId) {
        response = await updateMaintenanceRequest(
          maintenanceEditingId,
          payload
        );
      } else {
        response = await createMaintenanceRequest(payload);
      }

      if (response.error) {
        throw new Error(response.error.message || "Unable to save request");
      }

      toast.success(
        maintenanceEditingId
          ? "Maintenance request updated"
          : "Maintenance request created"
      );
      setShowAddMaintenanceDialog(false);
      resetMaintenanceForm();
      await refreshMaintenanceRequests();
    } catch (error: any) {
      console.error("Save maintenance error", error);
      toast.error(error?.message || "Failed to save maintenance request");
    } finally {
      setMaintenanceSaving(false);
    }
  };

  const resetMaintenanceForm = () => {
    setMaintenanceForm({
      propertyId: "",
      unitId: "none",
      title: "",
      description: "",
      priority: "medium",
      category: "general",
      scheduledDate: "",
      notifyTenant: false,
    });
    setMaintenanceEditingId(null);
  };

  const formatDateTimeInput = (value?: string | null) => {
    if (!value) return "";
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return "";
    const tzOffset = date.getTimezoneOffset();
    const localISO = new Date(date.getTime() - tzOffset * 60000)
      .toISOString()
      .slice(0, 16);
    return localISO;
  };

  const handleMaintenanceView = (request: any) => {
    setSelectedMaintenanceRequest(request);
    setShowMaintenanceViewDialog(true);
  };

  const handleMaintenanceEdit = (request: any) => {
    setMaintenanceEditingId(request.id);
    setMaintenanceForm({
      propertyId: request.propertyId || request.property?.id || "",
      unitId: request.unitId || "none",
      title: request.title || "",
      description: request.description || "",
      priority: request.priority || "medium",
      category: request.category || "general",
      scheduledDate: formatDateTimeInput(request.scheduledDate),
      notifyTenant: false,
    });
    setShowAddMaintenanceDialog(true);
  };

  const handleMaintenanceDelete = async (request: any) => {
    const confirmed = window.confirm(
      "Are you sure you want to delete this maintenance request?"
    );
    if (!confirmed) return;

    try {
      const response = await deleteMaintenanceRequest(request.id);
      if (response.error) {
        throw new Error(response.error.message || "Unable to delete request");
      }
      toast.success("Maintenance request deleted");
      await refreshMaintenanceRequests();
    } catch (error: any) {
      console.error("Delete maintenance error", error);
      toast.error(error?.message || "Failed to delete maintenance request");
    }
  };

  const handleGenerateReport = () => {
    if (
      reportPropertyFilter !== "all" &&
      !properties.some(
        (property) => String(property.id) === reportPropertyFilter
      )
    ) {
      toast.error("Selected property not found");
      return;
    }

    setReportGenerating(true);

    try {
      const targetProperties =
        reportPropertyFilter === "all"
          ? visibleProperties
          : visibleProperties.filter(
              (property) => String(property.id) === reportPropertyFilter
            );

      const propertyIds = targetProperties.map((property) =>
        String(property.id)
      );

      const filteredExpenses =
        reportPropertyFilter === "all"
          ? expenses
          : expenses.filter((expense) =>
              propertyIds.includes(String(expense.propertyId))
            );

      const filteredMaintenance =
        reportPropertyFilter === "all"
          ? maintenanceRequests
          : maintenanceRequests.filter(
              (request: any) =>
                String(request.propertyId) === reportPropertyFilter
            );

      const filteredUnits =
        reportPropertyFilter === "all"
          ? unitsData
          : unitsData.filter(
              (unit) => String(unit.propertyId) === reportPropertyFilter
            );

      const totalUnits = targetProperties.reduce(
        (sum, property) => sum + (property._count?.units ?? 0),
        0
      );
      const occupiedUnits = targetProperties.reduce(
        (sum, property) => sum + (property.occupiedUnits ?? 0),
        0
      );

      const sortedExpenses = [...filteredExpenses].sort(
        (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
      );
      const sortedMaintenance = [...filteredMaintenance].sort(
        (a: any, b: any) =>
          new Date(b.createdAt || b.updatedAt || 0).getTime() -
          new Date(a.createdAt || a.updatedAt || 0).getTime()
      );

      const filters = {
        propertyId: reportPropertyFilter,
        startDate: reportStartDate || null,
        endDate: reportEndDate || null,
      };

      const now = new Date();

      const buildReportData = (type: SingleReportType) => {
        switch (type) {
          case "financial": {
            const totalRevenue = targetProperties.reduce(
              (sum, property) => sum + Number(property.totalMonthlyIncome || 0),
              0
            );

            const totalExpensesAmount = filteredExpenses.reduce(
              (sum, expense) => sum + Number(expense.amount || 0),
              0
            );

            const expenseCategoriesMap = filteredExpenses.reduce(
              (acc, expense) => {
                const category = expense.category || "other";
                const current = acc.get(category) || { amount: 0, count: 0 };
                current.amount += Number(expense.amount || 0);
                current.count += 1;
                acc.set(category, current);
                return acc;
              },
              new Map<string, { amount: number; count: number }>()
            );

            const expenseCategories = Array.from(expenseCategoriesMap.entries())
              .map(([category, info]) => ({
                category,
                label: formatCategoryLabel(category),
                amount: info.amount,
                count: info.count,
              }))
              .sort((a, b) => b.amount - a.amount)
              .slice(0, 5);

            return {
              portfolio: {
                totalProperties: targetProperties.length,
                totalUnits,
                occupiedUnits,
                occupancyRate:
                  totalUnits > 0 ? (occupiedUnits / totalUnits) * 100 : 0,
                totalRevenue,
                totalExpenses: totalExpensesAmount,
                netOperatingIncome: totalRevenue - totalExpensesAmount,
              },
              expenses: {
                total: totalExpensesAmount,
                categories: expenseCategories,
              },
              revenueTrends: monthlyRevenueData.slice(-6),
              recentExpenses: sortedExpenses.slice(0, 6),
            };
          }
          case "occupancy": {
            const propertyBreakdown = targetProperties.map((property) => {
              const propertyUnits = filteredUnits.filter(
                (unit) => String(unit.propertyId) === String(property.id)
              );
              const propertyTotalUnits =
                property._count?.units ?? propertyUnits.length ?? 0;
              const propertyOccupiedUnits = propertyUnits.filter(
                (unit) => unit.status === "occupied"
              ).length;
              const propertyVacant = Math.max(
                propertyTotalUnits - propertyOccupiedUnits,
                0
              );

              return {
                id: property.id,
                name: property.name,
                totalUnits: propertyTotalUnits,
                occupiedUnits: propertyOccupiedUnits,
                vacantUnits: propertyVacant,
                occupancyRate:
                  propertyTotalUnits > 0
                    ? (propertyOccupiedUnits / propertyTotalUnits) * 100
                    : 0,
                monthlyRevenue: Number(property.totalMonthlyIncome || 0),
                currency: property.currency || smartBaseCurrency,
              };
            });

            return {
              summary: {
                totalProperties: targetProperties.length,
                totalUnits,
                occupiedUnits,
                vacantUnits: Math.max(totalUnits - occupiedUnits, 0),
                occupancyRate:
                  totalUnits > 0 ? (occupiedUnits / totalUnits) * 100 : 0,
              },
              propertyBreakdown,
            };
          }
          case "maintenance": {
            const totalRequests = filteredMaintenance.length;
            const completed = filteredMaintenance.filter(
              (request: any) =>
                (request.status || "").toLowerCase() === "completed"
            ).length;
            const highPriority = filteredMaintenance.filter(
              (request: any) =>
                (request.priority || "").toLowerCase() === "high"
            ).length;
            const costTotal = filteredMaintenance.reduce(
              (sum, request: any) =>
                sum + Number(request.actualCost ?? request.estimatedCost ?? 0),
              0
            );

            const upcoming = maintenanceRequests
              .filter((request: any) => {
                if (!request.scheduledDate) return false;
                const scheduledDate = new Date(request.scheduledDate);
                if (Number.isNaN(scheduledDate.getTime())) return false;
                if (
                  reportPropertyFilter !== "all" &&
                  String(request.propertyId) !== reportPropertyFilter
                ) {
                  return false;
                }
                return scheduledDate.getTime() > Date.now();
              })
              .sort(
                (a: any, b: any) =>
                  new Date(a.scheduledDate).getTime() -
                  new Date(b.scheduledDate).getTime()
              )
              .slice(0, 5);

            return {
              summary: {
                totalRequests,
                completed,
                open: Math.max(totalRequests - completed, 0),
                highPriority,
                averageCost: totalRequests ? costTotal / totalRequests : 0,
              },
              highPriorityRequests: filteredMaintenance
                .filter(
                  (request: any) =>
                    (request.priority || "").toLowerCase() === "high"
                )
                .slice(0, 5),
              recentRequests: sortedMaintenance.slice(0, 6),
              upcoming,
            };
          }
          case "tenant": {
            const tenantUnits = unitsData.filter((unit) => {
              const hasTenant = Boolean(unit.leases?.[0]?.users);
              if (!hasTenant) return false;
              if (reportPropertyFilter === "all") return true;
              return String(unit.propertyId) === reportPropertyFilter;
            });

            const tenants = tenantUnits.map((unit) => {
              const lease = unit.leases?.[0];
              return {
                propertyId: unit.propertyId,
                unitId: unit.id,
                unitNumber: unit.unitNumber,
                tenantName: lease?.users?.name || "Unknown tenant",
                email: lease?.users?.email || "",
                phone: lease?.users?.phone || "",
                leaseEnd: lease?.endDate || null,
                status: unit.status,
              };
            });

            const expiringSoon = tenants.filter((tenant) => {
              if (!tenant.leaseEnd) return false;
              const leaseEndDate = new Date(tenant.leaseEnd);
              if (Number.isNaN(leaseEndDate.getTime())) return false;
              const daysUntil =
                (leaseEndDate.getTime() - now.getTime()) /
                (1000 * 60 * 60 * 24);
              return daysUntil <= 30;
            }).length;

            return {
              totalTenants: tenants.length,
              expiringSoon,
              tenants: tenants.slice(0, 10),
            };
          }
          default:
            return null;
        }
      };

      let data: any;
      if (reportType === "all") {
        data = ALL_REPORT_TYPES.reduce((acc, type) => {
          acc[type] = buildReportData(type);
          return acc;
        }, {} as Record<SingleReportType, any>);
      } else {
        data = buildReportData(reportType as SingleReportType);
      }

      if (!data) {
        throw new Error("Unable to generate report data");
      }
      const payload: GeneratedReport = {
        type: reportType,
        generatedAt: new Date().toISOString(),
        filters,
        data,
      };

      setReportPreview(payload);
      toast.success("Report generated");
    } catch (error) {
      console.error("Failed to generate report", error);
      toast.error("Failed to generate report");
    } finally {
      setReportGenerating(false);
    }
  };

  const handleResetReportFilters = () => {
    setReportPropertyFilter("all");
    setReportStartDate("");
    setReportEndDate("");
    setReportPreview(null);
    setReportGenerating(false);
  };

  const handleDownloadReport = async () => {
    if (!reportPreview) {
      toast.error("Generate a report first");
      return;
    }
    if (!reportPreviewRef.current) {
      toast.error("Nothing to export yet");
      return;
    }

    try {
      const html2canvas = (await import("html2canvas")).default;
      const { jsPDF } = await import("jspdf");

      const canvas = await html2canvas(reportPreviewRef.current, {
        scale: Math.max(window.devicePixelRatio, 2),
        backgroundColor: "#ffffff",
        useCORS: true,
        logging: false,
      });

      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "pt", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 36;
      const usableWidth = pageWidth - margin * 2;
      const imgHeight = (canvas.height * usableWidth) / canvas.width;

      pdf.setFontSize(14);
      pdf.text("Portfolio Report", margin, margin - 6);
      pdf.setFontSize(10);
      pdf.text(
        `Type: ${REPORT_TYPE_LABELS[reportPreview.type]} | Property: ${
          reportPreviewPropertyLabel || "All properties"
        }`,
        margin,
        margin + 8
      );
      pdf.text(
        `Generated: ${new Date(reportPreview.generatedAt).toLocaleString()}`,
        margin,
        margin + 20
      );
      if (reportPreviewDateRange) {
        pdf.text(`Range: ${reportPreviewDateRange}`, margin, margin + 32);
      }

      let position = margin + (reportPreviewDateRange ? 44 : 32);
      pdf.addImage(imgData, "PNG", margin, position, usableWidth, imgHeight);

      let heightLeft = imgHeight - (pageHeight - position - margin);
      let offset = position - imgHeight;

      while (heightLeft > 0) {
        pdf.addPage();
        pdf.addImage(imgData, "PNG", margin, offset, usableWidth, imgHeight);
        heightLeft -= pageHeight - margin * 2;
        offset -= pageHeight - margin * 2;
      }

      const suffix = new Date().toISOString().split("T")[0];
      const filename = `portfolio-report-${reportPreview.type}-${suffix}.pdf`;
      pdf.save(filename);
      toast.success("PDF downloaded");
    } catch (error) {
      console.error("PDF download failed", error);
      toast.error("Failed to generate PDF");
    }
  };

  const handleEmailReport = () => {
    if (!reportPreview) {
      toast.error("Generate a report first");
      return;
    }
    // Set default email and show dialog
    setEmailReportTo(user?.email || "");
    setShowEmailDialog(true);
  };

  const sendReportEmail = async () => {
    if (!reportPreview || !emailReportTo.trim()) {
      toast.error("Please enter a valid email address");
      return;
    }

    setIsSendingEmail(true);
    try {
      const response = await fetch("/api/dashboard/reports/scheduled/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("auth_token")}`,
        },
        body: JSON.stringify({
          email: emailReportTo.trim(),
          subject: `${REPORT_TYPE_LABELS[reportPreview.type]} Report - ${reportPreviewPropertyLabel}`,
          report: {
            type: reportPreview.type,
            generatedAt: reportPreview.generatedAt,
            propertyLabel: reportPreviewPropertyLabel,
            filters: {
              propertyId: reportPropertyFilter,
              startDate: reportStartDate,
              endDate: reportEndDate,
            },
          },
        }),
      });

      const data = await response.json();

      if (response.ok && data.success) {
        toast.success(`Report sent to ${emailReportTo}`);
        setShowEmailDialog(false);
        setEmailReportTo("");
      } else {
        toast.error(data.error || "Failed to send report");
      }
    } catch (error: any) {
      console.error("Failed to send report email:", error);
      toast.error("Failed to send report. Please try again.");
    } finally {
      setIsSendingEmail(false);
    }
  };

  const handleOpenFinancialDetails = (property: any) => {
    const details = computePropertyFinancialDetails(property);
    setFinancialDetailProperty(details);
    setShowFinancialDetailDialog(true);
  };

  const getPropertyUnitsForExpense = (propertyId: string) => {
    const property = properties.find((p) => p.id === propertyId);
    if (!property) return [];
    return unitsData.filter((u) => u.propertyId === propertyId);
  };

  // Filter out deleted properties for immediate UI feedback
  const visibleProperties = properties.filter(
    (property) => !deletedPropertyIds.has(property.id)
  );

  // Calculate portfolio metrics from visible properties (excludes deleted)
  // Use _count.units (actual unit records) instead of totalUnits (metadata field)
  const getActualUnitCount = (p: any) => p._count?.units ?? 0;

  const portfolioMetrics = {
    totalProperties: visibleProperties.length,
    totalUnits: visibleProperties.reduce(
      (sum, p) => sum + getActualUnitCount(p),
      0
    ),
    occupiedUnits: visibleProperties.reduce(
      (sum, p) => sum + (p.occupiedUnits ?? 0),
      0
    ),
    vacantUnits: visibleProperties.reduce((sum, p) => {
      const total = getActualUnitCount(p);
      const occ = p.occupiedUnits ?? 0;
      return sum + Math.max(total - occ, 0);
    }, 0),
    totalRevenue: visibleProperties.reduce(
      (sum, p) => sum + (p.totalMonthlyIncome || 0),
      0
    ),
    avgOccupancy:
      visibleProperties.length > 0
        ? visibleProperties.reduce((sum, p) => {
            const total = getActualUnitCount(p);
            const occ = p.occupiedUnits ?? 0;
            return (
              sum + (p.occupancyRate ?? (total > 0 ? (occ / total) * 100 : 0))
            );
          }, 0) / visibleProperties.length
        : 0,
    maintenanceRequests: maintenanceData.length,
  };

  const maintenanceRequests = maintenanceData;

  const maintenanceStatsAggregates = useMemo(() => {
    const total = maintenanceRequests.length;
    const highPriority = maintenanceRequests.filter(
      (request: any) => (request.priority || "").toLowerCase() === "high"
    ).length;

    const costEntries = maintenanceRequests
      .map((request: any) =>
        Number(
          request.actualCost ?? request.estimatedCost ?? request.cost ?? null
        )
      )
      .filter((value) => Number.isFinite(value)) as number[];
    const avgCost =
      costEntries.length > 0
        ? costEntries.reduce((sum, value) => sum + value, 0) /
          costEntries.length
        : 0;

    const responseEntries = maintenanceRequests
      .map((request: any) => {
        if (typeof request.responseTimeHours === "number") {
          return request.responseTimeHours;
        }
        const createdAt = request.createdAt
          ? new Date(request.createdAt).getTime()
          : null;
        const firstResponseAt =
          request.firstResponseAt ||
          request.scheduledDate ||
          request.completedAt;
        if (createdAt && firstResponseAt) {
          const responseTime =
            (new Date(firstResponseAt).getTime() - createdAt) /
            (1000 * 60 * 60);
          return responseTime;
        }
        return null;
      })
      .filter(
        (value): value is number => typeof value === "number" && value >= 0
      );

    const avgResponseHours =
      responseEntries.length > 0
        ? responseEntries.reduce((sum, value) => sum + value, 0) /
          responseEntries.length
        : null;

    return {
      total,
      highPriority,
      avgCost,
      avgResponseHours,
    };
  }, [maintenanceRequests]);

  const scheduledMaintenanceList = useMemo(() => {
    const now = Date.now();
    return maintenanceRequests
      .filter((request: any) => {
        if ((request.status || "").toLowerCase() === "scheduled") {
          return true;
        }
        if (request.scheduledDate) {
          const scheduledTime = new Date(request.scheduledDate).getTime();
          return scheduledTime >= now;
        }
        return false;
      })
      .sort((a: any, b: any) => {
        const dateA = a.scheduledDate ? new Date(a.scheduledDate).getTime() : 0;
        const dateB = b.scheduledDate ? new Date(b.scheduledDate).getTime() : 0;
        return dateA - dateB;
      })
      .slice(0, 3);
  }, [maintenanceRequests]);

  const formatCategoryLabel = (value: string) =>
    EXPENSE_CATEGORIES.find((c) => c.value === value)?.label ||
    value
      .split("_")
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" ");

  const formatMonthLabel = (month: string) => {
    if (!month) return "â€”";
    const parsed = new Date(month);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toLocaleString("default", {
        month: "short",
        year: "numeric",
      });
    }
    return month;
  };

  const formatReportDateRange = (
    start?: string | null,
    end?: string | null
  ) => {
    if (start && end) {
      return `${start} â†’ ${end}`;
    }
    if (start) {
      return `From ${start}`;
    }
    if (end) {
      return `Until ${end}`;
    }
    return null;
  };

  const expenseCategoryBreakdown = useMemo(() => {
    if (!expenseStats?.byCategory?.length) {
      return { total: expenseStats?.totalAmount ?? 0, items: [] };
    }

    const total =
      expenseStats.totalAmount ??
      expenseStats.byCategory.reduce(
        (sum: number, category: any) =>
          sum + Number(category._sum?.amount ?? 0),
        0
      );

    const sorted = [...expenseStats.byCategory].sort(
      (a, b) => Number(b._sum?.amount ?? 0) - Number(a._sum?.amount ?? 0)
    );

    const items = sorted.slice(0, 5).map((category) => {
      const amount = Number(category._sum?.amount ?? 0);
      const percent = total > 0 ? (amount / total) * 100 : 0;
      const Icon = expenseCategoryIconMap[category.category] ?? FileText;

      return {
        key: category.category,
        label: formatCategoryLabel(category.category),
        amount,
        percent,
        Icon,
      };
    });

    return { total, items };
  }, [expenseStats]);

  const renderReportSection = (
    type: SingleReportType,
    sectionData: any,
    context: { propertyLabel: string; filters: typeof reportPreview.filters }
  ) => {
    if (!sectionData) {
      return (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="h-16 w-16 rounded-2xl bg-gray-100 flex items-center justify-center mb-4">
            <FileText className="h-8 w-8 text-gray-400" />
          </div>
          <p className="text-gray-500 font-medium">No data available for this report.</p>
          <p className="text-gray-400 text-sm mt-1">Try adjusting your filters or date range.</p>
        </div>
      );
    }

    switch (type) {
      case "financial": {
        const { portfolio, expenses, revenueTrends, recentExpenses } =
          sectionData || {};
        const netIncome = (portfolio?.netOperatingIncome ?? 0) - (expenses?.total ?? 0);
        return (
          <div className="space-y-6">
            {/* Financial Stats Grid */}
            <div className="grid gap-4 md:grid-cols-4">
              <div className="rounded-xl bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-green-600">Total Revenue</p>
                  <div className="h-8 w-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <TrendingUp className="h-4 w-4 text-green-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">
                  {formatCurrency(portfolio?.totalRevenue ?? 0, smartBaseCurrency)}
                </p>
                <p className="text-xs text-green-600 mt-1">
                  Net {formatCurrency(portfolio?.netOperatingIncome ?? 0, smartBaseCurrency)}
                </p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-red-50 to-rose-50 border border-red-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-red-600">Total Expenses</p>
                  <div className="h-8 w-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                    <TrendingDown className="h-4 w-4 text-red-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">
                  {formatCurrency(expenses?.total ?? 0, smartBaseCurrency)}
                </p>
                <p className="text-xs text-gray-500 mt-1">{context.propertyLabel}</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-purple-50 to-violet-50 border border-purple-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-[#7C3AED]">Occupancy Rate</p>
                  <div className="h-8 w-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <PieChart className="h-4 w-4 text-[#7C3AED]" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">
                  {portfolio?.occupancyRate ? `${portfolio.occupancyRate.toFixed(1)}%` : "0%"}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {portfolio?.occupiedUnits ?? 0} of {portfolio?.totalUnits ?? 0} units
                </p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-blue-600">Net Income</p>
                  <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <DollarSign className="h-4 w-4 text-blue-600" />
                  </div>
                </div>
                <p className={`text-2xl font-bold ${netIncome >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  {formatCurrency(netIncome, smartBaseCurrency)}
                </p>
                <p className="text-xs text-gray-500 mt-1">After expenses</p>
              </div>
            </div>

            {/* Expense Categories */}
            <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
              <div className="bg-gradient-to-r from-red-50 to-rose-50 px-5 py-3 border-b border-red-100">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="h-8 w-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                      <PieChart className="h-4 w-4 text-red-600" />
                    </div>
                    <h4 className="font-semibold text-gray-900">Top Expense Categories</h4>
                  </div>
                  <Badge className="bg-red-100 text-red-700 border-red-200">
                    {expenses?.categories?.length ?? 0} Categories
                  </Badge>
                </div>
              </div>
              <div className="p-4">
                {expenses?.categories?.length ? (
                  <div className="space-y-3">
                    {expenses.categories.map((category: any, index: number) => (
                      <div
                        key={category.category}
                        className="flex items-center gap-4 p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors"
                      >
                        <div className="h-8 w-8 rounded-full bg-gradient-to-br from-red-400 to-rose-500 flex items-center justify-center text-white text-sm font-bold">
                          {index + 1}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="font-medium text-gray-900">{category.label}</p>
                          <p className="text-xs text-gray-500">
                            {category.count} expense{category.count === 1 ? "" : "s"}
                          </p>
                        </div>
                        <p className="text-sm font-bold text-gray-900">
                          {formatCurrency(category.amount, smartBaseCurrency)}
                        </p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-sm text-gray-500 text-center py-4">
                    No expenses recorded for the selected filters.
                  </p>
                )}
              </div>
            </div>

            {/* Revenue Trends */}
            {revenueTrends?.length ? (
              <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div className="bg-gradient-to-r from-green-50 to-emerald-50 px-5 py-3 border-b border-green-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="h-8 w-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <LineChart className="h-4 w-4 text-green-600" />
                      </div>
                      <h4 className="font-semibold text-gray-900">Revenue Trend</h4>
                    </div>
                    <Badge className="bg-green-100 text-green-700 border-green-200">
                      Last {revenueTrends.length} months
                    </Badge>
                  </div>
                </div>
                <div className="p-4">
                  <div className="grid gap-3 sm:grid-cols-2">
                    {revenueTrends.map((item: MonthlyRevenueData) => (
                      <div
                        key={item.month}
                        className="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200"
                      >
                        <div>
                          <p className="font-semibold text-gray-900">{formatMonthLabel(item.month)}</p>
                          <p className="text-xs text-gray-500 mt-1">
                            Net {formatCurrency(item.netIncome || 0, smartBaseCurrency)}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="font-bold text-green-600">
                            {formatCurrency(item.revenue || 0, smartBaseCurrency)}
                          </p>
                          <p className="text-xs text-red-500 mt-1">
                            -{formatCurrency(item.expenses || 0, smartBaseCurrency)}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ) : null}

            {/* Recent Expenses */}
            <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
              <div className="bg-gradient-to-r from-amber-50 to-yellow-50 px-5 py-3 border-b border-amber-100">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="h-8 w-8 rounded-lg bg-amber-500/20 flex items-center justify-center">
                      <Clock className="h-4 w-4 text-amber-600" />
                    </div>
                    <h4 className="font-semibold text-gray-900">Recent Expenses</h4>
                  </div>
                  <Badge className="bg-amber-100 text-amber-700 border-amber-200">
                    {recentExpenses?.length ?? 0} Items
                  </Badge>
                </div>
              </div>
              <div className="p-4">
                {recentExpenses?.length ? (
                  <div className="space-y-3">
                    {recentExpenses.map((expense: Expense) => (
                      <div
                        key={expense.id}
                        className="flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors"
                      >
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-lg bg-amber-100 flex items-center justify-center">
                            <DollarSign className="h-5 w-5 text-amber-600" />
                          </div>
                          <div>
                            <p className="font-medium text-gray-900">{expense.description}</p>
                            <p className="text-xs text-gray-500">
                              {expense.property?.name || "â€”"} â€¢ {formatCategoryLabel(expense.category)}
                            </p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className="font-bold text-gray-900">
                            {formatCurrency(expense.amount, expense.currency || smartBaseCurrency)}
                          </p>
                          <p className="text-xs text-gray-500">
                            {expense.date ? new Date(expense.date).toLocaleDateString() : "â€”"}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-sm text-gray-500 text-center py-4">
                    No expense data available for this filter.
                  </p>
                )}
              </div>
            </div>
          </div>
        );
      }
      case "occupancy": {
        const { summary, propertyBreakdown } = sectionData || {};
        const occupancyRate = summary?.occupancyRate ?? 0;
        return (
          <div className="space-y-6">
            {/* Occupancy Stats Grid */}
            <div className="grid gap-4 md:grid-cols-4">
              <div className="rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-blue-600">Total Units</p>
                  <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <Building2 className="h-4 w-4 text-blue-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">{summary?.totalUnits ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Across all properties</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-green-600">Occupied</p>
                  <div className="h-8 w-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <CheckCircle className="h-4 w-4 text-green-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-green-600">{summary?.occupiedUnits ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Active tenants</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-amber-50 to-yellow-50 border border-amber-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-amber-600">Vacant</p>
                  <div className="h-8 w-8 rounded-lg bg-amber-500/20 flex items-center justify-center">
                    <Home className="h-4 w-4 text-amber-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-amber-600">{summary?.vacantUnits ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Available units</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-purple-50 to-violet-50 border border-purple-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-[#7C3AED]">Occupancy Rate</p>
                  <div className="h-8 w-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <Percent className="h-4 w-4 text-[#7C3AED]" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">
                  {occupancyRate ? `${occupancyRate.toFixed(1)}%` : "0%"}
                </p>
                <div className="mt-2">
                  <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-[#7C3AED] to-purple-600 rounded-full transition-all"
                      style={{ width: `${Math.min(occupancyRate, 100)}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Property Breakdown Table */}
            {propertyBreakdown?.length ? (
              <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div className="bg-gradient-to-r from-purple-50 to-violet-50 px-5 py-3 border-b border-purple-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="h-8 w-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <BarChart3 className="h-4 w-4 text-[#7C3AED]" />
                      </div>
                      <h4 className="font-semibold text-gray-900">Property Breakdown</h4>
                    </div>
                    <Badge className="bg-purple-100 text-[#7C3AED] border-purple-200">
                      {propertyBreakdown.length} Properties
                    </Badge>
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <Table>
                    <TableHeader>
                      <TableRow className="bg-gray-50 hover:bg-gray-50 border-b border-gray-200">
                        <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Property</TableHead>
                        <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Total Units</TableHead>
                        <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Occupied</TableHead>
                        <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Vacant</TableHead>
                        <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Occupancy</TableHead>
                        <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Revenue</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {propertyBreakdown.map((property: any, index: number) => (
                        <TableRow key={property.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'} hover:bg-purple-50/50 transition-colors`}>
                          <TableCell>
                            <div className="flex items-center gap-3">
                              <div className="h-9 w-9 rounded-lg bg-gradient-to-br from-[#7C3AED] to-purple-600 flex items-center justify-center text-white text-sm font-bold">
                                {property.name?.charAt(0) || 'P'}
                              </div>
                              <span className="font-medium text-gray-900">{property.name}</span>
                            </div>
                          </TableCell>
                          <TableCell className="font-medium text-gray-900">{property.totalUnits}</TableCell>
                          <TableCell>
                            <span className="text-green-600 font-medium">{property.occupiedUnits}</span>
                          </TableCell>
                          <TableCell>
                            <span className="text-amber-600 font-medium">{property.vacantUnits}</span>
                          </TableCell>
                          <TableCell>
                            <div className="flex items-center gap-2">
                              <div className="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div
                                  className="h-full bg-gradient-to-r from-[#7C3AED] to-purple-600 rounded-full"
                                  style={{ width: `${property.occupancyRate || 0}%` }}
                                />
                              </div>
                              <span className="text-sm font-medium text-gray-900">
                                {property.occupancyRate ? `${property.occupancyRate.toFixed(1)}%` : "0%"}
                              </span>
                            </div>
                          </TableCell>
                          <TableCell className="text-right font-bold text-green-600">
                            {formatCurrency(property.monthlyRevenue || 0, property.currency || smartBaseCurrency)}
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </div>
            ) : (
              <div className="rounded-xl border-2 border-dashed border-gray-200 p-8 text-center">
                <div className="h-12 w-12 rounded-xl bg-gray-100 flex items-center justify-center mx-auto mb-3">
                  <Building2 className="h-6 w-6 text-gray-400" />
                </div>
                <p className="text-gray-500 font-medium">No occupancy data available</p>
                <p className="text-gray-400 text-sm mt-1">Try adjusting your filters</p>
              </div>
            )}
          </div>
        );
      }
      case "maintenance": {
        const { summary, highPriorityRequests, recentRequests, upcoming } =
          sectionData || {};
        return (
          <div className="space-y-6">
            {/* Maintenance Stats Grid */}
            <div className="grid gap-4 md:grid-cols-4">
              <div className="rounded-xl bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-orange-600">Active Requests</p>
                  <div className="h-8 w-8 rounded-lg bg-orange-500/20 flex items-center justify-center">
                    <Wrench className="h-4 w-4 text-orange-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">{summary?.totalRequests ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Open work orders</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-green-600">Completed</p>
                  <div className="h-8 w-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <CheckCircle className="h-4 w-4 text-green-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-green-600">{summary?.completed ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Resolved this period</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-red-50 to-rose-50 border border-red-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-red-600">High Priority</p>
                  <div className="h-8 w-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                    <AlertTriangle className="h-4 w-4 text-red-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-red-600">{summary?.highPriority ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Urgent attention needed</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-blue-600">Avg. Cost</p>
                  <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <DollarSign className="h-4 w-4 text-blue-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">
                  {formatCurrency(summary?.averageCost ?? 0, smartBaseCurrency)}
                </p>
                <p className="text-xs text-gray-500 mt-1">Per work order</p>
              </div>
            </div>

            {/* High Priority Queue */}
            {highPriorityRequests?.length ? (
              <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div className="bg-gradient-to-r from-red-50 to-rose-50 px-5 py-3 border-b border-red-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="h-8 w-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                        <AlertTriangle className="h-4 w-4 text-red-600" />
                      </div>
                      <h4 className="font-semibold text-gray-900">High-Priority Queue</h4>
                    </div>
                    <Badge className="bg-red-100 text-red-700 border-red-200">
                      {highPriorityRequests.length} Urgent
                    </Badge>
                  </div>
                </div>
                <div className="p-4 space-y-3">
                  {highPriorityRequests.map((request: any) => (
                    <div key={request.id} className="flex items-center gap-4 p-3 rounded-xl bg-red-50/50 border border-red-100">
                      <div className="h-10 w-10 rounded-lg bg-red-500 flex items-center justify-center">
                        <AlertTriangle className="h-5 w-5 text-white" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-gray-900">{request.title}</p>
                        <p className="text-xs text-gray-500">
                          {request.property?.name || "â€”"} â€¢ {request.category || "general"}
                        </p>
                      </div>
                      <Badge className="bg-red-100 text-red-700 border-red-200">High</Badge>
                    </div>
                  ))}
                </div>
              </div>
            ) : null}

            {/* Recent Activity & Upcoming Schedule */}
            <div className="grid gap-6 lg:grid-cols-2">
              {/* Recent Activity */}
              <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-5 py-3 border-b border-blue-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <Activity className="h-4 w-4 text-blue-600" />
                      </div>
                      <h4 className="font-semibold text-gray-900">Recent Activity</h4>
                    </div>
                    <Badge className="bg-blue-100 text-blue-700 border-blue-200">
                      {recentRequests?.length ?? 0}
                    </Badge>
                  </div>
                </div>
                <div className="p-4">
                  {recentRequests?.length ? (
                    <div className="space-y-3">
                      {recentRequests.map((request: any) => (
                        <div
                          key={request.id}
                          className="flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors"
                        >
                          <div className="flex items-center gap-3">
                            <div className="h-9 w-9 rounded-lg bg-blue-100 flex items-center justify-center">
                              <Wrench className="h-4 w-4 text-blue-600" />
                            </div>
                            <div>
                              <p className="font-medium text-gray-900">{request.title}</p>
                              <p className="text-xs text-gray-500">
                                {request.property?.name || "â€”"} â€¢ {request.status || "pending"}
                              </p>
                            </div>
                          </div>
                          <Badge className={
                            request.priority === 'high'
                              ? 'bg-red-100 text-red-700 border-red-200'
                              : request.priority === 'medium'
                              ? 'bg-amber-100 text-amber-700 border-amber-200'
                              : 'bg-green-100 text-green-700 border-green-200'
                          }>
                            {request.priority || "medium"}
                          </Badge>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-6">
                      <div className="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center mx-auto mb-2">
                        <Activity className="h-5 w-5 text-gray-400" />
                      </div>
                      <p className="text-sm text-gray-500">No maintenance activity recorded</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Upcoming Schedule */}
              <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div className="bg-gradient-to-r from-green-50 to-emerald-50 px-5 py-3 border-b border-green-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="h-8 w-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <Calendar className="h-4 w-4 text-green-600" />
                      </div>
                      <h4 className="font-semibold text-gray-900">Upcoming Schedule</h4>
                    </div>
                    <Badge className="bg-green-100 text-green-700 border-green-200">
                      {upcoming?.length ?? 0}
                    </Badge>
                  </div>
                </div>
                <div className="p-4">
                  {upcoming?.length ? (
                    <div className="space-y-3">
                      {upcoming.map((request: any) => (
                        <div key={request.id} className="p-3 rounded-lg bg-gradient-to-r from-green-50 to-emerald-50 border border-green-100">
                          <div className="flex items-center gap-3">
                            <div className="h-9 w-9 rounded-lg bg-green-500 flex items-center justify-center">
                              <Calendar className="h-4 w-4 text-white" />
                            </div>
                            <div>
                              <p className="font-medium text-gray-900">{request.title}</p>
                              <p className="text-xs text-gray-500">{request.property?.name || "â€”"}</p>
                            </div>
                          </div>
                          <div className="mt-2 flex items-center gap-2 text-xs text-green-600">
                            <Clock className="h-3 w-3" />
                            {new Date(request.scheduledDate).toLocaleString()}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-6">
                      <div className="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center mx-auto mb-2">
                        <Calendar className="h-5 w-5 text-gray-400" />
                      </div>
                      <p className="text-sm text-gray-500">No upcoming visits scheduled</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }
      case "tenant": {
        const { totalTenants, expiringSoon, tenants } = sectionData || {};
        const selectedVacantUnits =
          context.filters.propertyId === "all"
            ? portfolioMetrics.vacantUnits
            : (() => {
                const property = visibleProperties.find(
                  (p) => String(p.id) === context.filters.propertyId
                );
                if (!property) return 0;
                const total = property._count?.units ?? 0;
                const occupied = property.occupiedUnits ?? 0;
                return Math.max(total - occupied, 0);
              })();

        return (
          <div className="space-y-6">
            {/* Tenant Stats Grid */}
            <div className="grid gap-4 md:grid-cols-3">
              <div className="rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-blue-600">Active Tenants</p>
                  <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <Users className="h-4 w-4 text-blue-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">{totalTenants ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Currently leasing</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-amber-50 to-yellow-50 border border-amber-100 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-amber-600">Expiring Soon</p>
                  <div className="h-8 w-8 rounded-lg bg-amber-500/20 flex items-center justify-center">
                    <AlertTriangle className="h-4 w-4 text-amber-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-amber-600">{expiringSoon ?? 0}</p>
                <p className="text-xs text-gray-500 mt-1">Within 30 days</p>
              </div>
              <div className="rounded-xl bg-gradient-to-br from-gray-50 to-slate-50 border border-gray-200 p-4">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs font-medium text-gray-600">Vacant Units</p>
                  <div className="h-8 w-8 rounded-lg bg-gray-200 flex items-center justify-center">
                    <Home className="h-4 w-4 text-gray-600" />
                  </div>
                </div>
                <p className="text-2xl font-bold text-gray-900">{selectedVacantUnits}</p>
                <p className="text-xs text-gray-500 mt-1">Available for lease</p>
              </div>
            </div>

            {/* Tenant List */}
            {tenants?.length ? (
              <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-5 py-3 border-b border-blue-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <Users className="h-4 w-4 text-blue-600" />
                      </div>
                      <h4 className="font-semibold text-gray-900">Tenant Directory</h4>
                    </div>
                    <Badge className="bg-blue-100 text-blue-700 border-blue-200">
                      {tenants.length} Tenants
                    </Badge>
                  </div>
                </div>
                <div className="p-4 space-y-3">
                  {tenants.map((tenant: any) => {
                    const propertyName =
                      visibleProperties.find(
                        (property) => property.id === tenant.propertyId
                      )?.name || "â€”";
                    const isExpiringSoon = tenant.leaseEnd &&
                      new Date(tenant.leaseEnd).getTime() - Date.now() < 30 * 24 * 60 * 60 * 1000;
                    return (
                      <div
                        key={`${tenant.unitId}-${tenant.tenantName}-${tenant.email}`}
                        className={`rounded-xl border p-4 hover:shadow-md transition-all ${
                          isExpiringSoon
                            ? 'bg-gradient-to-r from-amber-50 to-yellow-50 border-amber-200'
                            : 'bg-white border-gray-200 hover:border-blue-200'
                        }`}
                      >
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex items-center gap-3">
                            <div className={`h-12 w-12 rounded-xl flex items-center justify-center text-white font-bold text-lg ${
                              isExpiringSoon
                                ? 'bg-gradient-to-br from-amber-500 to-yellow-500'
                                : 'bg-gradient-to-br from-blue-500 to-indigo-600'
                            }`}>
                              {tenant.tenantName?.charAt(0)?.toUpperCase() || 'T'}
                            </div>
                            <div>
                              <p className="font-semibold text-gray-900">{tenant.tenantName}</p>
                              <p className="text-sm text-gray-500">
                                {propertyName} â€¢ Unit {tenant.unitNumber}
                              </p>
                            </div>
                          </div>
                          <Badge className={
                            tenant.status === 'occupied'
                              ? 'bg-green-100 text-green-700 border-green-200'
                              : 'bg-gray-100 text-gray-700 border-gray-200'
                          }>
                            {tenant.status || "occupied"}
                          </Badge>
                        </div>
                        <div className="mt-3 pt-3 border-t border-gray-100 grid grid-cols-1 sm:grid-cols-3 gap-2">
                          {tenant.email && (
                            <div className="flex items-center gap-2 text-sm text-gray-500">
                              <Send className="h-3 w-3" />
                              <span className="truncate">{tenant.email}</span>
                            </div>
                          )}
                          {tenant.phone && (
                            <div className="flex items-center gap-2 text-sm text-gray-500">
                              <Info className="h-3 w-3" />
                              <span>{tenant.phone}</span>
                            </div>
                          )}
                          {tenant.leaseEnd && (
                            <div className={`flex items-center gap-2 text-sm ${
                              isExpiringSoon ? 'text-amber-600 font-medium' : 'text-gray-500'
                            }`}>
                              <Calendar className="h-3 w-3" />
                              <span>
                                {isExpiringSoon && 'âš ï¸ '}
                                Ends {new Date(tenant.leaseEnd).toLocaleDateString()}
                              </span>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ) : (
              <div className="rounded-xl border-2 border-dashed border-gray-200 p-8 text-center">
                <div className="h-12 w-12 rounded-xl bg-gray-100 flex items-center justify-center mx-auto mb-3">
                  <Users className="h-6 w-6 text-gray-400" />
                </div>
                <p className="text-gray-500 font-medium">No tenant data available</p>
                <p className="text-gray-400 text-sm mt-1">Assign tenants to units to populate this report</p>
              </div>
            )}
          </div>
        );
      }
      default:
        return null;
    }
  };

  const renderReportPreview = () => {
    if (!reportPreview) return null;

    const propertyLabel = reportPreviewPropertyLabel || "All properties";
    const context = { propertyLabel, filters: reportPreview.filters };

    const getReportTypeColors = (type: string) => {
      switch (type) {
        case 'financial':
          return { bg: 'from-green-500 to-emerald-600', icon: DollarSign, badge: 'bg-green-100 text-green-700 border-green-200' };
        case 'occupancy':
          return { bg: 'from-[#7C3AED] to-purple-600', icon: PieChart, badge: 'bg-purple-100 text-[#7C3AED] border-purple-200' };
        case 'maintenance':
          return { bg: 'from-orange-500 to-amber-600', icon: Wrench, badge: 'bg-orange-100 text-orange-700 border-orange-200' };
        case 'tenant':
          return { bg: 'from-blue-500 to-indigo-600', icon: Users, badge: 'bg-blue-100 text-blue-700 border-blue-200' };
        default:
          return { bg: 'from-gray-500 to-gray-600', icon: FileText, badge: 'bg-gray-100 text-gray-700 border-gray-200' };
      }
    };

    if (reportPreview.type === "all") {
      return (
        <div className="space-y-8">
          {ALL_REPORT_TYPES.map((type) => {
            const sectionData = reportPreview.data?.[type];
            if (!sectionData) return null;
            const colors = getReportTypeColors(type);
            const IconComponent = colors.icon;
            return (
              <div key={type} className="rounded-xl border border-gray-200 bg-white overflow-hidden shadow-sm">
                {/* Section Header */}
                <div className={`bg-gradient-to-r ${colors.bg} px-6 py-4`}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <IconComponent className="h-5 w-5 text-white" />
                      </div>
                      <div>
                        <h4 className="text-lg font-bold text-white">
                          {REPORT_TYPE_LABELS[type]} Report
                        </h4>
                        <p className="text-sm text-white/80">
                          Snapshot for {propertyLabel}
                        </p>
                      </div>
                    </div>
                    <Badge className={colors.badge}>
                      {REPORT_TYPE_LABELS[type]}
                    </Badge>
                  </div>
                </div>
                {/* Section Content */}
                <div className="p-6 bg-gray-50/50">
                  {renderReportSection(type, sectionData, context)}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    return renderReportSection(
      reportPreview.type as SingleReportType,
      reportPreview.data,
      context
    );
  };
  const reportPreviewPropertyLabel = reportPreview
    ? reportPreview.filters.propertyId === "all"
      ? "All properties"
      : visibleProperties.find(
          (property) => String(property.id) === reportPreview.filters.propertyId
        )?.name || "Selected property"
    : null;

  const reportPreviewDateRange = reportPreview
    ? formatReportDateRange(
        reportPreview.filters.startDate,
        reportPreview.filters.endDate
      )
    : null;

  const financialTrendCards = useMemo(() => {
    const cards: Array<{
      title: string;
      value: string;
      change: number | null;
      positive: boolean;
      progress: number;
      subtitle?: string;
      tooltip?: string;
    }> = [];

    if (monthlyRevenueData.length) {
      const sortedData = [...monthlyRevenueData];
      const latest = sortedData[sortedData.length - 1];
      const previous =
        sortedData.length > 1 ? sortedData[sortedData.length - 2] : null;
      const change =
        previous && previous.revenue !== 0
          ? ((latest.revenue - previous.revenue) / previous.revenue) * 100
          : null;
      const maxRevenue = Math.max(
        ...sortedData.map((entry) => Number(entry.revenue || 0))
      );
      const progress =
        maxRevenue > 0 ? (Number(latest.revenue || 0) / maxRevenue) * 100 : 0;

      cards.push({
        title: "Revenue Growth",
        value: formatCurrency(Number(latest.revenue || 0), smartBaseCurrency),
        change,
        positive: change == null ? true : change >= 0,
        progress: Math.max(0, Math.min(100, progress)),
        tooltip: previous
          ? `Latest monthly revenue ${formatCurrency(
              Number(latest.revenue || 0),
              smartBaseCurrency
            )} compared to ${formatCurrency(
              Number(previous.revenue || 0),
              smartBaseCurrency
            )} in the prior month.`
          : "Latest recorded monthly revenue.",
      });
    }

    const occupancyPercent = Number.isFinite(portfolioMetrics.avgOccupancy)
      ? portfolioMetrics.avgOccupancy
      : 0;
    cards.push({
      title: "Occupancy Rate",
      value: `${occupancyPercent.toFixed(1)}%`,
      change: null,
      positive: true,
      progress: Math.max(0, Math.min(100, occupancyPercent)),
      tooltip:
        "Portfolio-wide occupancy calculated from all visible properties and their unit counts.",
    });

    const operatingMargin =
      typeof financialStats.operatingMargin === "number"
        ? financialStats.operatingMargin
        : financialStats.gross
        ? (Number(financialStats.net || 0) /
            Number(financialStats.gross || 1)) *
          100
        : 0;
    cards.push({
      title: "Operating Efficiency",
      value: `${operatingMargin.toFixed(1)}%`,
      change: null,
      positive: true,
      progress: Math.max(0, Math.min(100, operatingMargin)),
      tooltip:
        "Operating margin based on Net Operating Income divided by total revenue.",
    });

    if (expenseStats) {
      const maintenanceCategory = expenseStats.byCategory?.find(
        (category: any) => category.category === "maintenance"
      );
      const maintenanceAmount = Number(maintenanceCategory?._sum?.amount ?? 0);
      const totalExpenses = expenseStats.totalAmount || 0;
      const maintenancePercent =
        totalExpenses > 0 ? (maintenanceAmount / totalExpenses) * 100 : 0;
      cards.push({
        title: "Maintenance Costs",
        value: formatCurrency(maintenanceAmount, smartBaseCurrency),
        change: null,
        positive: maintenancePercent <= 50,
        progress: Math.max(0, Math.min(100, maintenancePercent)),
        subtitle:
          totalExpenses > 0
            ? `${maintenancePercent.toFixed(1)}% of total spend`
            : undefined,
        tooltip:
          "Share of maintenance expenses relative to total recorded expenses for the selected period.",
      });
    }

    return cards;
  }, [
    expenseStats,
    financialStats.gross,
    financialStats.net,
    financialStats.operatingMargin,
    monthlyRevenueData,
    portfolioMetrics.avgOccupancy,
    smartBaseCurrency,
  ]);

  const computePropertyFinancialDetails = (property: any) => {
    const propertyExpenses = expenses
      .filter((expense) => expense.propertyId === property.id)
      .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

    const totalExpenses = propertyExpenses.reduce(
      (sum, expense) => sum + Number(expense.amount || 0),
      0
    );

    const monthlyRevenue = Number(property.totalMonthlyIncome || 0);
    const netIncome = monthlyRevenue - totalExpenses;
    const occupancyRate =
      property._count?.units && property._count.units > 0
        ? ((property.occupiedUnits ?? 0) / property._count.units) * 100
        : 0;

    return {
      property,
      monthlyRevenue,
      totalExpenses,
      netIncome,
      occupancyRate,
      propertyExpenses,
    };
  };

  const units = unitsData.map((u) => ({
    id: u.id,
    propertyId: u.propertyId,
    unit: u.unitNumber,
    bedrooms: u.bedrooms,
    bathrooms: u.bathrooms,
    sqft: u.size,
    rent: u.monthlyRent,
    deposit: u.securityDeposit,
    status: u.status,
    tenant: u.leases?.[0]?.users?.name || null,
    leaseStart: u.leases?.[0]?.startDate
      ? new Date(u.leases[0].startDate).toISOString().split("T")[0]
      : null,
    leaseEnd: u.leases?.[0]?.endDate
      ? new Date(u.leases[0].endDate).toISOString().split("T")[0]
      : null,
    moveInDate: u.leases?.[0]?.signedAt
      ? new Date(u.leases[0].signedAt).toISOString().split("T")[0]
      : null,
    phoneNumber: u.leases?.[0]?.users?.phone || null,
    email: u.leases?.[0]?.users?.email || null,
  }));

  const filteredProperties = visibleProperties.filter((property) => {
    const matchesSearch =
      property.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      property.address.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesStatus =
      statusFilter === "all" || property.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "active":
        return <CheckCircle className="h-4 w-4 text-green-600" />;
      case "maintenance":
        return <Wrench className="h-4 w-4 text-yellow-600" />;
      case "vacant":
        return <Home className="h-4 w-4 text-gray-600" />;
      default:
        return <Info className="h-4 w-4 text-gray-600" />;
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "active":
        return "bg-[#10B981]/10 text-[#10B981] border-[#10B981]/30 font-semibold hover:bg-[#10B981]/20";
      case "maintenance":
        return "bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/30 font-semibold hover:bg-[#F59E0B]/20";
      case "vacant":
        return "bg-[#6B7280]/10 text-[#6B7280] border-[#6B7280]/30 font-semibold hover:bg-[#6B7280]/20";
      default:
        return "bg-gray-100 text-gray-600 border-gray-300 font-semibold hover:bg-gray-200";
    }
  };

  const getPriorityBadge = (priority: string) => {
    switch (priority) {
      case "high":
        return "bg-[#EF4444]/10 text-[#EF4444] border-[#EF4444]/30 font-semibold hover:bg-[#EF4444]/20";
      case "medium":
        return "bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/30 font-semibold hover:bg-[#F59E0B]/20";
      case "low":
        return "bg-[#10B981]/10 text-[#10B981] border-[#10B981]/30 font-semibold hover:bg-[#10B981]/20";
      default:
        return "bg-gray-100 text-gray-600 border-gray-300 font-semibold hover:bg-gray-200";
    }
  };

  const getUnitStatusColor = (status: string) => {
    switch (status) {
      case "occupied":
        return "bg-[#10B981]/10 text-[#10B981] border-[#10B981]/30 font-semibold";
      case "vacant":
        return "bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/30 font-semibold";
      case "maintenance":
        return "bg-[#EF4444]/10 text-[#EF4444] border-[#EF4444]/30 font-semibold";
      default:
        return "bg-gray-100 text-gray-600 border-gray-300 font-semibold";
    }
  };

  const handlePropertyAction = async (action: string, propertyId: string) => {
    try {
      switch (action) {
        case "view": {
          if (onViewProperty) {
            onViewProperty(propertyId);
          }
          break;
        }
        case "edit": {
          if (onEditProperty) {
            onEditProperty(propertyId);
          }
          break;
        }
        case "duplicate": {
          const property = properties.find((p) => p.id === propertyId);
          if (property && onAddProperty) {
            const duplicatedProperty = {
              ...property,
              id: Date.now(),
              name: `${property.name} (Copy)`,
              occupiedUnits: 0,
              monthlyRevenue: 0,
              occupancyRate: 0,
            } as any;
            onAddProperty(duplicatedProperty);
            toast.success("Property duplicated successfully");
          }
          break;
        }
        case "archive": {
          // Call backend API to archive property
          const response = await archiveProperty(propertyId);
          if ((response as any).error) {
            throw new Error((response as any).error);
          }
          toast.success("Property archived successfully");

          // Refresh properties list if callback provided
          if (onUpdateProperty) {
            onUpdateProperty(propertyId as any, { status: "archived" });
          }
          break;
        }
        case "delete": {
          // Show confirmation dialog
          const property = properties.find((p) => p.id === propertyId);
          if (property) {
            setPropertyToDelete(property);
            setShowPropertyDeleteDialog(true);
          }
          break;
        }
        default:
          break;
      }
    } catch (e: any) {
      toast.error(e?.message || "Action failed");
    }
  };

  const handleConfirmDeleteProperty = async () => {
    if (!propertyToDelete) return;

    const propertyId = propertyToDelete.id;
    const propertyName = propertyToDelete.name;

    try {
      setIsDeletingProperty(true);

      // Close dialog immediately and show progress toast
      setShowPropertyDeleteDialog(false);
      const toastId = toast.loading(`Deleting "${propertyName}"...`);

      // Immediately remove from UI for instant feedback
      setDeletedPropertyIds((prev) => new Set([...prev, propertyId]));

      const response = await deleteProperty(propertyId);

      if ((response as any).error) {
        // Extract the error message from the error object
        const errorMessage =
          (response as any).error.error ||
          (response as any).error.message ||
          "Failed to delete property";
        throw new Error(errorMessage);
      }

      toast.success(`"${propertyName}" deleted successfully`, { id: toastId });
      setPropertyToDelete(null);

      // Notify parent to refresh the properties list
      if (onPropertyDeleted) {
        onPropertyDeleted(propertyId);
      } else if (onRefreshProperties) {
        onRefreshProperties();
      }
    } catch (e: any) {
      // Revert the UI change on error
      setDeletedPropertyIds((prev) => {
        const newSet = new Set(prev);
        newSet.delete(propertyId);
        return newSet;
      });
      toast.error(e?.message || "Failed to delete property");
    } finally {
      setIsDeletingProperty(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header - Inverted Brand Color (Gray 900) */}
      <header className="bg-[#111827] shadow-lg sticky top-0 z-40">
        <div className="px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <Button
                variant="ghost"
                onClick={onBack}
                className="mr-4 text-white hover:bg-white/10 hover:text-white"
              >
                â† Back to Dashboard
              </Button>
              <h1 className="text-xl font-bold text-white">Properties</h1>
            </div>

            <div className="flex items-center space-x-3">
              <Button
                variant="outline"
                onClick={() => setShowImportDialog(true)}
                className="bg-white/10 border-white/20 text-white hover:bg-white/20 hover:text-white hover:border-white/30"
              >
                <FileSpreadsheet className="h-4 w-4 mr-2" />
                Import
              </Button>
              <Button
                onClick={onNavigateToAddProperty}
                className="bg-gradient-to-r from-[#A855F7] to-[#7C3AED] text-white hover:from-[#9333EA] hover:to-[#6D28D9] font-semibold shadow-lg shadow-purple-500/25"
              >
                <Plus className="h-4 w-4 mr-2" />
                Add Property
              </Button>
            </div>
          </div>
        </div>
      </header>

      <div className="p-4 lg:p-8">
        <div className="max-w-7xl mx-auto">
          <Tabs value={activeTab} onValueChange={setActiveTab}>
            <TabsList className="grid w-full grid-cols-6 bg-white shadow-sm rounded-xl p-1 mb-6">
              <TabsTrigger
                value="overview"
                className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-[#7C3AED] data-[state=active]:to-[#5B21B6] data-[state=active]:text-white data-[state=active]:shadow-lg rounded-lg transition-all"
              >
                Overview
              </TabsTrigger>
              <TabsTrigger
                value="properties"
                className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-[#7C3AED] data-[state=active]:to-[#5B21B6] data-[state=active]:text-white data-[state=active]:shadow-lg rounded-lg transition-all"
              >
                Properties
              </TabsTrigger>
              <TabsTrigger
                value="units"
                className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-[#7C3AED] data-[state=active]:to-[#5B21B6] data-[state=active]:text-white data-[state=active]:shadow-lg rounded-lg transition-all"
              >
                Units
              </TabsTrigger>
              <TabsTrigger
                value="financials"
                className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-[#7C3AED] data-[state=active]:to-[#5B21B6] data-[state=active]:text-white data-[state=active]:shadow-lg rounded-lg transition-all"
              >
                Financials
              </TabsTrigger>
              <TabsTrigger
                value="maintenance"
                className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-[#7C3AED] data-[state=active]:to-[#5B21B6] data-[state=active]:text-white data-[state=active]:shadow-lg rounded-lg transition-all"
              >
                Maintenance
              </TabsTrigger>
              <TabsTrigger
                value="reports"
                className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-[#7C3AED] data-[state=active]:to-[#5B21B6] data-[state=active]:text-white data-[state=active]:shadow-lg rounded-lg transition-all"
              >
                Reports
              </TabsTrigger>
            </TabsList>

            <TabsContent value="overview" className="space-y-6">
              {/* Portfolio Overview Header Card */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] px-6 py-6">
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                    <div>
                      <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <div className="h-10 w-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                          <BarChart3 className="h-5 w-5 text-white" />
                        </div>
                        Portfolio Overview
                      </h2>
                      <p className="text-purple-200 text-sm mt-2">
                        Real-time insights across all your properties
                      </p>
                    </div>

                    {/* Key Stats in Header */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[140px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <Building2 className="h-5 w-5 text-white" />
                          </div>
                          <div>
                            <p className="text-3xl font-bold text-white">{portfolioMetrics.totalProperties}</p>
                            <p className="text-xs text-purple-200">Properties</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[140px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#10B981]/30 flex items-center justify-center">
                            <TrendingUp className="h-5 w-5 text-[#34D399]" />
                          </div>
                          <div>
                            <p className="text-3xl font-bold text-white">{portfolioMetrics.avgOccupancy.toFixed(0)}%</p>
                            <p className="text-xs text-purple-200">Occupancy</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[140px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#3B82F6]/30 flex items-center justify-center">
                            <Home className="h-5 w-5 text-[#60A5FA]" />
                          </div>
                          <div>
                            <p className="text-3xl font-bold text-white">{portfolioMetrics.totalUnits}</p>
                            <p className="text-xs text-purple-200">Total Units</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Occupancy Progress Bar */}
                  <div className="mt-6 bg-white/10 backdrop-blur-sm rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-purple-100">Portfolio Occupancy</span>
                      <span className="text-sm font-bold text-white">
                        {portfolioMetrics.occupiedUnits}/{portfolioMetrics.totalUnits} units
                      </span>
                    </div>
                    <div className="h-3 bg-white/20 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-gradient-to-r from-[#34D399] to-[#10B981] rounded-full transition-all duration-500"
                        style={{ width: `${portfolioMetrics.avgOccupancy}%` }}
                      />
                    </div>
                    <div className="flex items-center justify-between mt-2 text-xs text-purple-200">
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#34D399]"></span>
                        Occupied: {portfolioMetrics.occupiedUnits}
                      </span>
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#FBBF24]"></span>
                        Vacant: {portfolioMetrics.vacantUnits}
                      </span>
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#F87171]"></span>
                        Maintenance: {portfolioMetrics.maintenanceRequests}
                      </span>
                    </div>
                  </div>
                </div>
              </Card>

              {/* Revenue & Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                {/* Monthly Revenue Card */}
                <Card className="border-0 shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
                  <div className="h-1.5 bg-gradient-to-r from-[#10B981] to-[#34D399]"></div>
                  <CardContent className="pt-5">
                    <div className="flex items-start justify-between">
                      <div>
                        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Monthly Revenue</p>
                        <p className="text-2xl font-bold text-gray-900 mt-1">
                          {formatCurrency(Number(portfolioMetrics.totalRevenue) || 0, smartBaseCurrency)}
                        </p>
                        <div className="flex items-center gap-1 mt-2">
                          <div className="flex items-center gap-1 px-2 py-0.5 bg-green-100 rounded-full">
                            <TrendingUp className="h-3 w-3 text-green-600" />
                            <span className="text-xs font-medium text-green-700">+8.2%</span>
                          </div>
                          <span className="text-xs text-gray-400">vs last month</span>
                        </div>
                      </div>
                      <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-[#10B981]/20 to-[#34D399]/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <DollarSign className="h-6 w-6 text-[#10B981]" />
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Occupied Units Card */}
                <Card className="border-0 shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
                  <div className="h-1.5 bg-gradient-to-r from-[#3B82F6] to-[#60A5FA]"></div>
                  <CardContent className="pt-5">
                    <div className="flex items-start justify-between">
                      <div>
                        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Occupied Units</p>
                        <p className="text-2xl font-bold text-gray-900 mt-1">
                          {portfolioMetrics.occupiedUnits}
                        </p>
                        <p className="text-xs text-gray-500 mt-2">
                          of {portfolioMetrics.totalUnits} total units
                        </p>
                      </div>
                      <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-[#3B82F6]/20 to-[#60A5FA]/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <Users className="h-6 w-6 text-[#3B82F6]" />
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Vacant Units Card */}
                <Card className="border-0 shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
                  <div className="h-1.5 bg-gradient-to-r from-[#F59E0B] to-[#FBBF24]"></div>
                  <CardContent className="pt-5">
                    <div className="flex items-start justify-between">
                      <div>
                        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Vacant Units</p>
                        <p className="text-2xl font-bold text-gray-900 mt-1">
                          {portfolioMetrics.vacantUnits}
                        </p>
                        <p className="text-xs text-amber-600 mt-2 font-medium">
                          Available for rent
                        </p>
                      </div>
                      <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-[#F59E0B]/20 to-[#FBBF24]/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <Home className="h-6 w-6 text-[#F59E0B]" />
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Maintenance Card */}
                <Card className="border-0 shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
                  <div className="h-1.5 bg-gradient-to-r from-[#EF4444] to-[#F87171]"></div>
                  <CardContent className="pt-5">
                    <div className="flex items-start justify-between">
                      <div>
                        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Maintenance</p>
                        <p className="text-2xl font-bold text-gray-900 mt-1">
                          {portfolioMetrics.maintenanceRequests}
                        </p>
                        <p className="text-xs text-red-600 mt-2 font-medium">
                          {portfolioMetrics.maintenanceRequests > 0 ? '1 high priority' : 'All clear'}
                        </p>
                      </div>
                      <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-[#EF4444]/20 to-[#F87171]/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <Wrench className="h-6 w-6 text-[#EF4444]" />
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Property Performance & Recent Activity */}
              <div className="grid lg:grid-cols-2 gap-6">
                {/* Property Performance Card */}
                <Card className="border-0 shadow-xl overflow-hidden">
                  <div className="bg-gradient-to-r from-purple-50 to-violet-50 px-6 py-4 border-b border-purple-100">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="h-10 w-10 rounded-xl bg-[#7C3AED]/20 flex items-center justify-center">
                          <BarChart3 className="h-5 w-5 text-[#7C3AED]" />
                        </div>
                        <div>
                          <h3 className="text-lg font-bold text-gray-900">Property Performance</h3>
                          <p className="text-xs text-gray-500">Revenue and occupancy by property</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <CardContent className="p-5">
                    <div className="space-y-3">
                      {visibleProperties.length === 0 ? (
                        <div className="text-center py-8">
                          <div className="mx-auto w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center mb-3">
                            <Building2 className="h-7 w-7 text-[#7C3AED]" />
                          </div>
                          <p className="text-sm text-gray-500">No properties yet</p>
                          <Button
                            onClick={onNavigateToAddProperty}
                            className="mt-3 bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] text-white"
                            size="sm"
                          >
                            <Plus className="h-4 w-4 mr-1" /> Add Property
                          </Button>
                        </div>
                      ) : (
                        visibleProperties.map((property, idx) => {
                          const occupancyRate = (property._count?.units ?? 0) > 0
                            ? ((property.occupiedUnits ?? 0) / (property._count?.units ?? 1)) * 100
                            : 0;
                          return (
                            <div
                              key={property.id}
                              className="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors group cursor-pointer"
                            >
                              <div className="flex items-center gap-4">
                                <div className="h-12 w-12 rounded-xl bg-gradient-to-br from-[#7C3AED] to-[#A855F7] flex items-center justify-center text-white font-bold text-lg">
                                  {idx + 1}
                                </div>
                                <div>
                                  <h4 className="font-semibold text-gray-900 group-hover:text-[#7C3AED] transition-colors">
                                    {property.name}
                                  </h4>
                                  <div className="flex items-center gap-3 mt-1">
                                    <span className="text-xs text-gray-500">
                                      {property.occupiedUnits ?? 0}/{property._count?.units ?? 0} units
                                    </span>
                                    <div className="w-20 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                      <div
                                        className="h-full bg-gradient-to-r from-[#10B981] to-[#34D399] rounded-full"
                                        style={{ width: `${occupancyRate}%` }}
                                      />
                                    </div>
                                    <span className="text-xs font-medium text-gray-600">{occupancyRate.toFixed(0)}%</span>
                                  </div>
                                </div>
                              </div>
                              <div className="text-right">
                                <p className="font-bold text-[#10B981]">
                                  {formatCurrency(Number(property.totalMonthlyIncome) || 0, property.currency || "NGN")}
                                </p>
                                <p className="text-xs text-gray-500">monthly</p>
                              </div>
                            </div>
                          );
                        })
                      )}
                    </div>
                  </CardContent>
                </Card>

                {/* Recent Activity Card */}
                <Card className="border-0 shadow-xl overflow-hidden">
                  <div className="bg-gradient-to-r from-blue-50 to-cyan-50 px-6 py-4 border-b border-blue-100">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="h-10 w-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                          <Activity className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <h3 className="text-lg font-bold text-gray-900">Recent Activity</h3>
                          <p className="text-xs text-gray-500">Latest updates across all properties</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <CardContent className="p-5">
                    <div className="space-y-3 max-h-[320px] overflow-y-auto">
                      {recentActivity.length === 0 ? (
                        <div className="text-center py-8">
                          <div className="mx-auto w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center mb-3">
                            <Clock className="h-7 w-7 text-blue-600" />
                          </div>
                          <p className="text-sm font-medium text-gray-900">No recent activity</p>
                          <p className="text-xs text-gray-500 mt-1">Activity will appear here as you manage properties</p>
                        </div>
                      ) : (
                        recentActivity.map((log: any) => (
                          <div
                            key={log.id}
                            className="flex items-start gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors"
                          >
                            <div className={`h-9 w-9 rounded-lg flex items-center justify-center flex-shrink-0 ${
                              log.action === 'created' ? 'bg-green-100' :
                              log.action === 'updated' ? 'bg-blue-100' :
                              log.action === 'deleted' ? 'bg-red-100' : 'bg-purple-100'
                            }`}>
                              <Activity className={`h-4 w-4 ${
                                log.action === 'created' ? 'text-green-600' :
                                log.action === 'updated' ? 'text-blue-600' :
                                log.action === 'deleted' ? 'text-red-600' : 'text-purple-600'
                              }`} />
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium text-gray-900 truncate">
                                {log.description}
                              </p>
                              <div className="flex items-center gap-2 mt-1">
                                <Badge variant="outline" className="text-[10px] px-2 py-0">
                                  {log.entity}
                                </Badge>
                                <span className="text-xs text-gray-400">
                                  {new Date(log.createdAt).toLocaleDateString()}
                                </span>
                              </div>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Quick Actions */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                  <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-xl bg-gray-200 flex items-center justify-center">
                      <Zap className="h-5 w-5 text-gray-600" />
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-gray-900">Quick Actions</h3>
                      <p className="text-xs text-gray-500">Common property management tasks</p>
                    </div>
                  </div>
                </div>
                <CardContent className="p-6">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button
                      onClick={onNavigateToAddProperty}
                      className="group relative h-28 flex flex-col items-center justify-center rounded-2xl bg-gradient-to-br from-[#7C3AED] to-[#5B21B6] text-white shadow-lg shadow-purple-500/25 hover:shadow-xl hover:shadow-purple-500/30 hover:scale-[1.02] transition-all duration-200"
                    >
                      <div className="absolute inset-0 rounded-2xl bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity" />
                      <div className="h-12 w-12 rounded-xl bg-white/20 flex items-center justify-center mb-2">
                        <Plus className="h-6 w-6" />
                      </div>
                      <span className="text-sm font-semibold">Add Property</span>
                    </button>

                    <button
                      onClick={() => {
                        if (onNavigateToTenants) {
                          onNavigateToTenants();
                        } else {
                          toast.info("Tenant management feature coming soon!");
                        }
                      }}
                      className="group h-28 flex flex-col items-center justify-center rounded-2xl border-2 border-gray-200 bg-white hover:border-[#7C3AED] hover:shadow-lg transition-all duration-200"
                    >
                      <div className="h-12 w-12 rounded-xl bg-gray-100 group-hover:bg-[#7C3AED]/10 flex items-center justify-center mb-2 transition-colors">
                        <Users className="h-6 w-6 text-gray-500 group-hover:text-[#7C3AED] transition-colors" />
                      </div>
                      <span className="text-sm font-semibold text-gray-700 group-hover:text-[#7C3AED] transition-colors">Manage Tenants</span>
                    </button>

                    <button
                      onClick={() => {
                        if (onNavigateToMaintenance) {
                          onNavigateToMaintenance();
                        } else {
                          toast.info("Maintenance scheduling feature coming soon!");
                        }
                      }}
                      className="group h-28 flex flex-col items-center justify-center rounded-2xl border-2 border-gray-200 bg-white hover:border-[#F59E0B] hover:shadow-lg transition-all duration-200"
                    >
                      <div className="h-12 w-12 rounded-xl bg-gray-100 group-hover:bg-[#F59E0B]/10 flex items-center justify-center mb-2 transition-colors">
                        <Wrench className="h-6 w-6 text-gray-500 group-hover:text-[#F59E0B] transition-colors" />
                      </div>
                      <span className="text-sm font-semibold text-gray-700 group-hover:text-[#F59E0B] transition-colors">Maintenance</span>
                    </button>

                    <button
                      onClick={() => setActiveTab("reports")}
                      className="group h-28 flex flex-col items-center justify-center rounded-2xl border-2 border-gray-200 bg-white hover:border-[#3B82F6] hover:shadow-lg transition-all duration-200"
                    >
                      <div className="h-12 w-12 rounded-xl bg-gray-100 group-hover:bg-[#3B82F6]/10 flex items-center justify-center mb-2 transition-colors">
                        <FileText className="h-6 w-6 text-gray-500 group-hover:text-[#3B82F6] transition-colors" />
                      </div>
                      <span className="text-sm font-semibold text-gray-700 group-hover:text-[#3B82F6] transition-colors">Reports</span>
                    </button>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="properties" className="space-y-6">
              {/* Properties Management Header */}
              <Card className="border-0 shadow-xl overflow-hidden">
                {/* Gradient Header */}
                <div className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] px-6 py-6">
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                    <div>
                      <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <div className="h-10 w-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                          <Building2 className="h-5 w-5 text-white" />
                        </div>
                        Property Management
                      </h2>
                      <p className="text-purple-200 text-sm mt-2">
                        Manage all your properties in one place
                      </p>
                    </div>

                    {/* Stats in Header */}
                    <div className="flex items-center gap-3 flex-wrap">
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <Building2 className="h-5 w-5 text-white" />
                          </div>
                          <div>
                            <p className="text-2xl font-bold text-white">{properties.length}</p>
                            <p className="text-xs text-purple-200">Properties</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#10B981]/30 flex items-center justify-center">
                            <CheckCircle className="h-5 w-5 text-[#34D399]" />
                          </div>
                          <div>
                            <p className="text-2xl font-bold text-white">{properties.filter(p => p.status === 'active').length}</p>
                            <p className="text-xs text-purple-200">Active</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#3B82F6]/30 flex items-center justify-center">
                            <DollarSign className="h-5 w-5 text-[#60A5FA]" />
                          </div>
                          <div>
                            <p className="text-lg font-bold text-white">{formatCurrency(Number(portfolioMetrics.totalRevenue) || 0, smartBaseCurrency)}</p>
                            <p className="text-xs text-purple-200">Monthly Revenue</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <Button
                      onClick={onNavigateToAddProperty}
                      className="bg-white text-[#7C3AED] hover:bg-purple-50 shadow-lg font-semibold whitespace-nowrap"
                    >
                      <Plus className="h-4 w-4 mr-2" />
                      Add Property
                    </Button>
                  </div>
                </div>

                {/* Search & Filters */}
                <CardContent className="p-6">
                  <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full lg:w-auto">
                      <div className="relative w-full sm:w-72">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="Search properties..."
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          className="pl-10 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-11"
                        />
                        {searchTerm && (
                          <button
                            onClick={() => setSearchTerm("")}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                          >
                            <X className="h-4 w-4" />
                          </button>
                        )}
                      </div>
                      <Select value={statusFilter} onValueChange={setStatusFilter}>
                        <SelectTrigger className="w-full sm:w-40 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-11">
                          <SelectValue placeholder="All Status" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">All Status</SelectItem>
                          <SelectItem value="active">Active</SelectItem>
                          <SelectItem value="maintenance">Maintenance</SelectItem>
                          <SelectItem value="vacant">Vacant</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="flex items-center gap-3">
                      {/* Results count */}
                      <span className="text-sm text-gray-500">
                        {filteredProperties.length} {filteredProperties.length === 1 ? 'property' : 'properties'}
                      </span>

                      {/* View Toggle */}
                      <div className="flex items-center gap-1 p-1 bg-gray-100 rounded-xl">
                        <button
                          onClick={() => setViewMode("grid")}
                          className={`p-2.5 rounded-lg transition-all ${
                            viewMode === "grid"
                              ? "bg-white text-[#7C3AED] shadow-sm"
                              : "text-gray-500 hover:text-[#7C3AED]"
                          }`}
                          title="Grid View"
                        >
                          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                          </svg>
                        </button>
                        <button
                          onClick={() => setViewMode("list")}
                          className={`p-2.5 rounded-lg transition-all ${
                            viewMode === "list"
                              ? "bg-white text-[#7C3AED] shadow-sm"
                              : "text-gray-500 hover:text-[#7C3AED]"
                          }`}
                          title="List View"
                        >
                          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Active filters */}
                  {(searchTerm || statusFilter !== "all") && (
                    <div className="flex items-center gap-2 mt-4 pt-4 border-t border-gray-100">
                      <span className="text-xs font-medium text-gray-500">Filters:</span>
                      {searchTerm && (
                        <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-medium">
                          <Search className="h-3 w-3" />
                          "{searchTerm}"
                          <button onClick={() => setSearchTerm("")} className="hover:text-purple-900">
                            <X className="h-3 w-3" />
                          </button>
                        </span>
                      )}
                      {statusFilter !== "all" && (
                        <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-medium">
                          Status: {statusFilter}
                          <button onClick={() => setStatusFilter("all")} className="hover:text-blue-900">
                            <X className="h-3 w-3" />
                          </button>
                        </span>
                      )}
                      <button
                        onClick={() => { setSearchTerm(""); setStatusFilter("all"); }}
                        className="text-xs text-gray-500 hover:text-[#7C3AED] ml-2"
                      >
                        Clear all
                      </button>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Properties Grid/List View */}
              {filteredProperties.length === 0 ? (
                <Card className="border-0 shadow-lg">
                  <CardContent className="py-16">
                    <div className="text-center">
                      <div className="h-16 w-16 rounded-2xl bg-purple-100 flex items-center justify-center mx-auto mb-4">
                        <Building2 className="h-8 w-8 text-purple-600" />
                      </div>
                      {properties.length === 0 ? (
                        <>
                          <h3 className="text-lg font-semibold text-gray-900 mb-2">No Properties Yet</h3>
                          <p className="text-gray-500 mb-6 max-w-md mx-auto">
                            Start building your portfolio by adding your first property.
                          </p>
                          <Button
                            onClick={onNavigateToAddProperty}
                            className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg"
                          >
                            <Plus className="h-4 w-4 mr-2" />
                            Add Your First Property
                          </Button>
                        </>
                      ) : (
                        <>
                          <h3 className="text-lg font-semibold text-gray-900 mb-2">No Properties Found</h3>
                          <p className="text-gray-500 mb-4 max-w-md mx-auto">
                            No properties match your current filters. Try adjusting your search.
                          </p>
                          <Button
                            variant="outline"
                            onClick={() => { setSearchTerm(""); setStatusFilter("all"); }}
                            className="border-gray-300 hover:border-[#7C3AED] hover:text-[#7C3AED]"
                          >
                            <X className="h-4 w-4 mr-2" />
                            Clear Filters
                          </Button>
                        </>
                      )}
                    </div>
                  </CardContent>
                </Card>
              ) : viewMode === "grid" ? (
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {filteredProperties.map((property) => (
                    <Card
                      key={property.id}
                      className="overflow-hidden border-0 shadow-lg hover:shadow-xl transition-all duration-300 group"
                    >
                      <div className="h-48 bg-gradient-to-br from-gray-100 to-gray-200 relative overflow-hidden">
                        {Array.isArray(property.images) &&
                        property.images.length > 0 ? (
                          <img
                            src={property.images[0]}
                            alt={property.name}
                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          />
                        ) : (
                          <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100">
                            <Building2 className="h-12 w-12 text-gray-300 mb-2" />
                            <span className="text-sm text-gray-400">
                              No image
                            </span>
                          </div>
                        )}
                        <div className="absolute top-3 right-3">
                          <Badge
                            variant="outline"
                            className={`shadow-lg backdrop-blur-sm ${getStatusBadge(
                              property.status
                            )}`}
                          >
                            {property.status.charAt(0).toUpperCase() +
                              property.status.slice(1)}
                          </Badge>
                        </div>
                        <div className="absolute top-3 left-3">
                          <div className="px-2 py-1 bg-[#111827]/80 backdrop-blur-sm rounded-lg">
                            <span className="text-xs font-medium text-white">
                              {property.propertyType || "Property"}
                            </span>
                          </div>
                        </div>
                      </div>

                      <CardContent className="p-5">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1 min-w-0">
                            <h3 className="font-bold text-lg text-gray-900 truncate">
                              {property.name}
                            </h3>
                            <p className="text-sm text-gray-600 flex items-center mt-1">
                              <MapPin className="h-3.5 w-3.5 mr-1 flex-shrink-0 text-gray-400" />
                              <span className="truncate">
                                {property.address}
                              </span>
                            </p>
                          </div>
                          <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <Button
                                variant="ghost"
                                size="sm"
                                className="ml-2 hover:bg-[#7C3AED]/10 hover:text-[#7C3AED]"
                              >
                                <MoreHorizontal className="h-4 w-4" />
                              </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end" className="w-48">
                              <DropdownMenuItem
                                onClick={() =>
                                  handlePropertyAction("view", property.id)
                                }
                                className="cursor-pointer"
                              >
                                <Eye className="mr-2 h-4 w-4 text-blue-600" />
                                View Details
                              </DropdownMenuItem>
                              <DropdownMenuItem
                                onClick={() =>
                                  handlePropertyAction("edit", property.id)
                                }
                                className="cursor-pointer"
                              >
                                <Edit className="mr-2 h-4 w-4 text-[#7C3AED]" />
                                Edit Property
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem
                                onClick={() =>
                                  handlePropertyAction("duplicate", property.id)
                                }
                                className="cursor-pointer"
                              >
                                <Copy className="mr-2 h-4 w-4 text-gray-600" />
                                Duplicate
                              </DropdownMenuItem>
                              <DropdownMenuItem
                                onClick={() =>
                                  handlePropertyAction("archive", property.id)
                                }
                                className="cursor-pointer"
                              >
                                <Archive className="mr-2 h-4 w-4 text-orange-600" />
                                Archive
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem
                                onClick={() =>
                                  handlePropertyAction("delete", property.id)
                                }
                                className="text-red-600 focus:text-red-600 cursor-pointer"
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                Delete Property
                              </DropdownMenuItem>
                            </DropdownMenuContent>
                          </DropdownMenu>
                        </div>

                        <div className="space-y-2.5 mb-4">
                          <div className="flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg">
                            <span className="text-sm text-gray-600 flex items-center">
                              <Home className="h-3.5 w-3.5 mr-1.5 text-gray-400" />
                              Units
                            </span>
                            <span className="text-sm font-semibold text-gray-900">
                              {property.occupiedUnits ?? 0}/
                              {property._count?.units ?? 0}
                            </span>
                          </div>
                          <div className="flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg">
                            <span className="text-sm text-gray-600 flex items-center">
                              <TrendingUp className="h-3.5 w-3.5 mr-1.5 text-gray-400" />
                              Occupancy
                            </span>
                            <span className="text-sm font-semibold text-[#10B981]">
                              {(
                                property.occupancyRate ??
                                ((property._count?.units ?? 0) > 0
                                  ? ((property.occupiedUnits ?? 0) /
                                      (property._count?.units ?? 1)) *
                                    100
                                  : 0)
                              ).toFixed(1)}
                              %
                            </span>
                          </div>
                          <div className="flex justify-between items-center py-2 px-3 bg-gradient-to-r from-[#10B981]/10 to-[#10B981]/5 rounded-lg border border-[#10B981]/20">
                            <span className="text-sm font-medium text-gray-700 flex items-center">
                              <DollarSign className="h-3.5 w-3.5 mr-1 text-[#10B981]" />
                              Monthly Revenue
                            </span>
                            <span className="text-sm font-bold text-[#10B981]">
                              {formatCurrency(
                                Number(property.totalMonthlyIncome) || 0,
                                property.currency || "NGN"
                              )}
                            </span>
                          </div>
                          <div className="flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg">
                            <span className="text-sm text-gray-600 flex items-center">
                              <Users className="h-3.5 w-3.5 mr-1.5 text-gray-400" />
                              Manager
                            </span>
                            <span className="text-sm font-medium text-gray-900 truncate max-w-[150px]">
                              {property.property_managers?.[0]?.users?.name ??
                                "Unassigned"}
                            </span>
                          </div>
                        </div>

                        {Array.isArray(property.features) &&
                          property.features.length > 0 && (
                            <div className="flex flex-wrap gap-1.5 mb-4">
                              {(Array.isArray(property.features)
                                ? property.features
                                : []
                              )
                                .slice(0, 3)
                                .map((feature: string, index: number) => (
                                  <Badge
                                    key={index}
                                    variant="outline"
                                    className="text-xs bg-[#7C3AED]/5 text-[#7C3AED] border-[#7C3AED]/20"
                                  >
                                    {feature}
                                  </Badge>
                                ))}
                              {(Array.isArray(property.features)
                                ? property.features
                                : []
                              ).length > 3 && (
                                <Badge
                                  variant="outline"
                                  className="text-xs bg-gray-100 text-gray-600 border-gray-300"
                                >
                                  +{(property.features as any[]).length - 3}
                                </Badge>
                              )}
                            </div>
                          )}

                        <div className="flex gap-2">
                          <Button
                            variant="outline"
                            size="sm"
                            className="flex-1 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300"
                            onClick={() =>
                              handlePropertyAction("view", property.id)
                            }
                          >
                            <Eye className="h-4 w-4 mr-1.5" />
                            View
                          </Button>
                          <Button
                            size="sm"
                            className="flex-1 bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-md"
                            onClick={() =>
                              handlePropertyAction("edit", property.id)
                            }
                          >
                            <Edit className="h-4 w-4 mr-1.5" />
                            Edit
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              ) : (
                <Card className="border-0 shadow-lg overflow-hidden">
                  <CardContent className="p-0">
                    <Table>
                      <TableHeader>
                        <TableRow className="bg-gray-50 hover:bg-gray-50 border-b border-gray-200">
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Property
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Location
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Units
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Occupancy
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Revenue
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Manager
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Status
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Actions
                          </TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {filteredProperties.map((property, index) => (
                          <TableRow
                            key={property.id}
                            className={`hover:bg-[#7C3AED]/5 transition-colors ${
                              index % 2 === 0 ? "bg-white" : "bg-gray-50/50"
                            }`}
                          >
                            <TableCell>
                              <div className="flex items-center space-x-3">
                                <div className="h-12 w-12 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 overflow-hidden flex-shrink-0">
                                  {Array.isArray(property.images) &&
                                  property.images.length > 0 ? (
                                    <img
                                      src={property.images[0]}
                                      alt={property.name}
                                      className="w-full h-full object-cover"
                                    />
                                  ) : (
                                    <div className="w-full h-full flex items-center justify-center">
                                      <Building2 className="h-5 w-5 text-gray-400" />
                                    </div>
                                  )}
                                </div>
                                <div className="min-w-0">
                                  <p className="font-semibold text-gray-900 truncate">
                                    {property.name}
                                  </p>
                                  <p className="text-sm text-gray-500">
                                    {property.propertyType}
                                  </p>
                                </div>
                              </div>
                            </TableCell>
                            <TableCell>
                              <div className="min-w-0">
                                <p className="text-sm text-gray-900 truncate">
                                  {property.address}
                                </p>
                                <p className="text-xs text-gray-500">
                                  {property.city}, {property.state}
                                </p>
                              </div>
                            </TableCell>
                            <TableCell>
                              <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-gray-100 text-sm font-medium text-gray-900">
                                {property.occupiedUnits ?? 0}/
                                {property._count?.units ?? 0}
                              </span>
                            </TableCell>
                            <TableCell>
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-semibold text-[#10B981] min-w-[45px]">
                                  {(property._count?.units ?? 0) > 0
                                    ? (
                                        ((property.occupiedUnits ?? 0) /
                                          (property._count?.units ?? 1)) *
                                        100
                                      ).toFixed(1)
                                    : "0.0"}
                                  %
                                </span>
                                <Progress
                                  value={
                                    (property._count?.units ?? 0) > 0
                                      ? ((property.occupiedUnits ?? 0) /
                                          (property._count?.units ?? 1)) *
                                        100
                                      : 0
                                  }
                                  className="w-20 h-2 bg-gray-200"
                                />
                              </div>
                            </TableCell>
                            <TableCell>
                              <span className="inline-flex items-center px-3 py-1.5 rounded-lg bg-gradient-to-r from-[#10B981]/10 to-[#10B981]/5 border border-[#10B981]/20">
                                <span className="text-sm font-bold text-[#10B981]">
                                  {formatCurrency(
                                    Number(property.totalMonthlyIncome) || 0,
                                    property.currency || "NGN"
                                  )}
                                </span>
                              </span>
                            </TableCell>
                            <TableCell>
                              <div className="min-w-0">
                                <p className="text-sm font-medium text-gray-900 truncate">
                                  {property.manager || "Unassigned"}
                                </p>
                                {property.managerPhone && (
                                  <p className="text-xs text-gray-500 truncate">
                                    {property.managerPhone}
                                  </p>
                                )}
                              </div>
                            </TableCell>
                            <TableCell>
                              <div className="flex items-center space-x-2">
                                <div className="p-1 rounded-lg bg-gray-100">
                                  {getStatusIcon(property.status)}
                                </div>
                                <Badge
                                  variant="outline"
                                  className={getStatusBadge(property.status)}
                                >
                                  {property.status.charAt(0).toUpperCase() +
                                    property.status.slice(1)}
                                </Badge>
                              </div>
                            </TableCell>
                            <TableCell>
                              <div className="flex items-center space-x-1.5">
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() =>
                                    handlePropertyAction("view", property.id)
                                  }
                                  className="hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300"
                                >
                                  <Eye className="h-4 w-4" />
                                </Button>
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() =>
                                    handlePropertyAction("edit", property.id)
                                  }
                                  className="hover:bg-[#7C3AED]/10 hover:text-[#7C3AED] hover:border-[#7C3AED]/30"
                                >
                                  <Edit className="h-4 w-4" />
                                </Button>
                                <DropdownMenu>
                                  <DropdownMenuTrigger asChild>
                                    <Button
                                      variant="outline"
                                      size="sm"
                                      className="hover:bg-gray-100"
                                    >
                                      <MoreHorizontal className="h-4 w-4" />
                                    </Button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent
                                    align="end"
                                    className="w-48"
                                  >
                                    <DropdownMenuItem
                                      onClick={() =>
                                        handlePropertyAction(
                                          "duplicate",
                                          property.id
                                        )
                                      }
                                      className="cursor-pointer"
                                    >
                                      <Copy className="mr-2 h-4 w-4 text-gray-600" />
                                      Duplicate
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      onClick={() =>
                                        handlePropertyAction(
                                          "archive",
                                          property.id
                                        )
                                      }
                                      className="cursor-pointer"
                                    >
                                      <Archive className="mr-2 h-4 w-4 text-orange-600" />
                                      Archive
                                    </DropdownMenuItem>
                                    <DropdownMenuSeparator />
                                    <DropdownMenuItem
                                      onClick={() =>
                                        handlePropertyAction(
                                          "delete",
                                          property.id
                                        )
                                      }
                                      className="text-red-600 focus:text-red-600 cursor-pointer"
                                    >
                                      <Trash2 className="mr-2 h-4 w-4" />
                                      Delete Property
                                    </DropdownMenuItem>
                                  </DropdownMenuContent>
                                </DropdownMenu>
                              </div>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </CardContent>
                </Card>
              )}
            </TabsContent>

            {/* Other tabs with full implementation */}
            <TabsContent value="units" className="space-y-6">
              {/* Units Management - Unified Design */}
              <Card className="border-0 shadow-xl overflow-hidden">
                {/* Gradient Header with Stats */}
                <div className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] px-6 py-6">
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                    <div>
                      <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Home className="h-5 w-5" />
                        Unit Management
                      </h2>
                      <p className="text-purple-200 text-sm mt-1">
                        Manage and monitor all units across your properties
                      </p>
                    </div>

                    {/* Compact Stats in Header */}
                    <div className="flex items-center gap-3 flex-wrap">
                      <div className="flex items-center gap-2 bg-white/15 backdrop-blur-sm rounded-xl px-4 py-2.5">
                        <div className="h-8 w-8 rounded-lg bg-white/20 flex items-center justify-center">
                          <Home className="h-4 w-4 text-white" />
                        </div>
                        <div>
                          <p className="text-[10px] font-medium text-purple-200 uppercase tracking-wider">Total</p>
                          <p className="text-lg font-bold text-white leading-tight">{portfolioMetrics.totalUnits}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 bg-white/15 backdrop-blur-sm rounded-xl px-4 py-2.5">
                        <div className="h-8 w-8 rounded-lg bg-[#10B981]/30 flex items-center justify-center">
                          <Users className="h-4 w-4 text-[#34D399]" />
                        </div>
                        <div>
                          <p className="text-[10px] font-medium text-purple-200 uppercase tracking-wider">Occupied</p>
                          <p className="text-lg font-bold text-white leading-tight">{portfolioMetrics.occupiedUnits}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 bg-white/15 backdrop-blur-sm rounded-xl px-4 py-2.5">
                        <div className="h-8 w-8 rounded-lg bg-[#F59E0B]/30 flex items-center justify-center">
                          <Home className="h-4 w-4 text-[#FBBF24]" />
                        </div>
                        <div>
                          <p className="text-[10px] font-medium text-purple-200 uppercase tracking-wider">Vacant</p>
                          <p className="text-lg font-bold text-white leading-tight">{portfolioMetrics.vacantUnits}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 bg-white/15 backdrop-blur-sm rounded-xl px-4 py-2.5">
                        <div className="h-8 w-8 rounded-lg bg-[#EF4444]/30 flex items-center justify-center">
                          <Wrench className="h-4 w-4 text-[#F87171]" />
                        </div>
                        <div>
                          <p className="text-[10px] font-medium text-purple-200 uppercase tracking-wider">Maintenance</p>
                          <p className="text-lg font-bold text-white leading-tight">{units.filter(u => u.status === 'maintenance').length}</p>
                        </div>
                      </div>
                    </div>

                    <Button
                      onClick={() => setShowAddUnitDialog(true)}
                      className="bg-white text-[#7C3AED] hover:bg-purple-50 shadow-lg font-semibold whitespace-nowrap"
                    >
                      <Plus className="h-4 w-4 mr-2" />
                      Add New Unit
                    </Button>
                  </div>

                  {/* Occupancy Progress Bar in Header */}
                  <div className="mt-5 bg-white/10 backdrop-blur-sm rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-purple-100">Portfolio Occupancy</span>
                      <span className="text-sm font-bold text-white">
                        {units.length > 0 ? ((units.filter(u => u.status === 'occupied').length / units.length) * 100).toFixed(1) : 0}%
                      </span>
                    </div>
                    <div className="h-2.5 bg-white/20 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-gradient-to-r from-[#34D399] to-[#10B981] rounded-full transition-all duration-500"
                        style={{ width: `${units.length > 0 ? (units.filter(u => u.status === 'occupied').length / units.length) * 100 : 0}%` }}
                      />
                    </div>
                    <div className="flex items-center gap-4 mt-2.5 text-xs text-purple-200">
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#34D399]"></span>
                        Occupied: {units.filter(u => u.status === 'occupied').length}
                      </span>
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#FBBF24]"></span>
                        Vacant: {units.filter(u => u.status === 'vacant').length}
                      </span>
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#F87171]"></span>
                        Maintenance: {units.filter(u => u.status === 'maintenance').length}
                      </span>
                      {unitsData.length > 0 && (
                        <span className="ml-auto flex items-center gap-1.5">
                          <DollarSign className="h-3 w-3" />
                          Avg Rent: {(() => {
                            const getRentFrequency = (unit: any): string => {
                              let features = unit.features;
                              if (typeof features === "string") {
                                try { features = JSON.parse(features); } catch { features = {}; }
                              }
                              return features?.nigeria?.rentFrequency || features?.rentFrequency || unit.rentFrequency || "monthly";
                            };
                            const frequencies = unitsData.map(u => getRentFrequency(u));
                            const allAnnual = frequencies.every(f => f === "annual");
                            const avgRent = unitsData.reduce((sum, u) => sum + (u.monthlyRent || 0), 0) / unitsData.length;
                            return formatCurrency(avgRent, smartBaseCurrency) + (allAnnual ? '/yr' : '/mo');
                          })()}
                        </span>
                      )}
                    </div>
                  </div>
                </div>

                <CardContent className="p-6">

                  {/* Search and Filters */}
                  <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-6">
                    <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full lg:w-auto">
                      <div className="relative w-full sm:w-72">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="Search by unit, tenant, property..."
                          value={unitsSearchTerm}
                          onChange={(e) => {
                            setUnitsSearchTerm(e.target.value);
                            setUnitsCurrentPage(1); // Reset to first page on search
                          }}
                          className="pl-10 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl"
                        />
                        {unitsSearchTerm && (
                          <button
                            onClick={() => {
                              setUnitsSearchTerm("");
                              setUnitsCurrentPage(1);
                            }}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 hover:text-gray-600"
                          >
                            <X className="h-4 w-4" />
                          </button>
                        )}
                      </div>
                      <Select
                        value={unitsPropertyFilter}
                        onValueChange={(value) => {
                          setUnitsPropertyFilter(value);
                          setUnitsCurrentPage(1); // Reset to first page on filter change
                        }}
                      >
                        <SelectTrigger className="w-full sm:w-44 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl">
                          <SelectValue placeholder="Filter by Property" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">All Properties</SelectItem>
                          {properties.map((property) => (
                            <SelectItem key={property.id} value={property.id}>
                              {property.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="flex items-center gap-3">
                      {/* Status Filter Tabs */}
                      <div className="flex items-center gap-1 p-1 bg-gray-100 rounded-xl">
                        {(["all", "occupied", "vacant", "maintenance"] as const).map((status) => (
                          <button
                            key={status}
                            onClick={() => {
                              setUnitsStatusFilter(status);
                              setUnitsCurrentPage(1); // Reset to first page on filter change
                            }}
                            className={`px-4 py-2 text-sm font-medium rounded-lg transition-all ${
                              unitsStatusFilter === status
                                ? "bg-white text-[#7C3AED] shadow-sm"
                                : "text-gray-600 hover:text-[#7C3AED] hover:bg-white/50"
                            }`}
                          >
                            {status.charAt(0).toUpperCase() + status.slice(1)}
                          </button>
                        ))}
                      </div>

                      {/* View Toggle */}
                      <div className="flex items-center gap-1 p-1 bg-gray-100 rounded-xl">
                        <button
                          onClick={() => setUnitsViewMode("grid")}
                          className={`p-2 rounded-lg transition-all ${
                            unitsViewMode === "grid"
                              ? "bg-white text-[#7C3AED] shadow-sm"
                              : "text-gray-500 hover:text-[#7C3AED]"
                          }`}
                          title="Grid View"
                        >
                          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                          </svg>
                        </button>
                        <button
                          onClick={() => setUnitsViewMode("list")}
                          className={`p-2 rounded-lg transition-all ${
                            unitsViewMode === "list"
                              ? "bg-white text-[#7C3AED] shadow-sm"
                              : "text-gray-500 hover:text-[#7C3AED]"
                          }`}
                          title="List View"
                        >
                          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Units Grid/List View */}
                  {(() => {
                    // Filter units based on search, property, and status
                    const filteredUnits = units.filter((unit) => {
                      // Property filter
                      if (unitsPropertyFilter !== "all" && unit.propertyId !== unitsPropertyFilter) {
                        return false;
                      }

                      // Status filter
                      if (unitsStatusFilter !== "all" && unit.status !== unitsStatusFilter) {
                        return false;
                      }

                      // Search filter
                      if (unitsSearchTerm) {
                        const searchLower = unitsSearchTerm.toLowerCase();
                        const property = properties.find((p) => p.id === unit.propertyId);
                        const unitName = (unit.unit || "").toLowerCase();
                        const tenantName = (unit.tenant || "").toLowerCase();
                        const propertyName = (property?.name || "").toLowerCase();
                        const unitType = (unit.type || "").toLowerCase();

                        if (!unitName.includes(searchLower) &&
                            !tenantName.includes(searchLower) &&
                            !propertyName.includes(searchLower) &&
                            !unitType.includes(searchLower)) {
                          return false;
                        }
                      }

                      return true;
                    });

                    // Pagination calculations
                    const totalPages = Math.ceil(filteredUnits.length / UNITS_PER_PAGE);
                    const startIndex = (unitsCurrentPage - 1) * UNITS_PER_PAGE;
                    const endIndex = startIndex + UNITS_PER_PAGE;
                    const paginatedUnits = filteredUnits.slice(startIndex, endIndex);

                    // Show empty state if no units exist at all
                    if (units.length === 0) {
                      return (
                        <div className="text-center py-16 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
                          <div className="h-16 w-16 rounded-2xl bg-purple-100 flex items-center justify-center mx-auto mb-4">
                            <Home className="h-8 w-8 text-purple-600" />
                          </div>
                          <h3 className="text-lg font-semibold text-gray-900 mb-2">No Units Yet</h3>
                          <p className="text-gray-500 mb-6 max-w-md mx-auto">
                            Start by adding your first unit to one of your properties.
                            Units help you track individual rental spaces, tenants, and rent collection.
                          </p>
                          <Button
                            onClick={() => setShowAddUnitDialog(true)}
                            className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg"
                          >
                            <Plus className="h-4 w-4 mr-2" />
                            Add Your First Unit
                          </Button>
                        </div>
                      );
                    }

                    // Show "no results" state if filters return no units
                    if (filteredUnits.length === 0) {
                      return (
                        <div className="text-center py-12 bg-gray-50 rounded-2xl border border-gray-200">
                          <div className="h-14 w-14 rounded-2xl bg-amber-100 flex items-center justify-center mx-auto mb-4">
                            <Search className="h-7 w-7 text-amber-600" />
                          </div>
                          <h3 className="text-lg font-semibold text-gray-900 mb-2">No Units Found</h3>
                          <p className="text-gray-500 mb-4 max-w-md mx-auto">
                            No units match your current filters. Try adjusting your search or filters.
                          </p>
                          <div className="flex items-center justify-center gap-3">
                            {(unitsSearchTerm || unitsPropertyFilter !== "all" || unitsStatusFilter !== "all") && (
                              <Button
                                variant="outline"
                                onClick={() => {
                                  setUnitsSearchTerm("");
                                  setUnitsPropertyFilter("all");
                                  setUnitsStatusFilter("all");
                                  setUnitsCurrentPage(1);
                                }}
                                className="border-gray-300 hover:border-[#7C3AED] hover:text-[#7C3AED]"
                              >
                                <X className="h-4 w-4 mr-2" />
                                Clear Filters
                              </Button>
                            )}
                          </div>
                          {/* Active filters display */}
                          <div className="flex items-center justify-center gap-2 mt-4 flex-wrap">
                            {unitsSearchTerm && (
                              <span className="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                Search: "{unitsSearchTerm}"
                                <button onClick={() => { setUnitsSearchTerm(""); setUnitsCurrentPage(1); }} className="hover:text-purple-900">
                                  <X className="h-3 w-3" />
                                </button>
                              </span>
                            )}
                            {unitsPropertyFilter !== "all" && (
                              <span className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                Property: {properties.find(p => p.id === unitsPropertyFilter)?.name || unitsPropertyFilter}
                                <button onClick={() => { setUnitsPropertyFilter("all"); setUnitsCurrentPage(1); }} className="hover:text-blue-900">
                                  <X className="h-3 w-3" />
                                </button>
                              </span>
                            )}
                            {unitsStatusFilter !== "all" && (
                              <span className="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                Status: {unitsStatusFilter.charAt(0).toUpperCase() + unitsStatusFilter.slice(1)}
                                <button onClick={() => { setUnitsStatusFilter("all"); setUnitsCurrentPage(1); }} className="hover:text-green-900">
                                  <X className="h-3 w-3" />
                                </button>
                              </span>
                            )}
                          </div>
                        </div>
                      );
                    }

                    return (
                      <>
                        {/* Active Filters Bar */}
                        {(unitsSearchTerm || unitsPropertyFilter !== "all" || unitsStatusFilter !== "all") && (
                          <div className="flex items-center justify-between bg-purple-50 border border-purple-200 rounded-xl px-4 py-3 mb-4">
                            <div className="flex items-center gap-2 flex-wrap">
                              <span className="text-sm font-medium text-purple-700">Active filters:</span>
                              {unitsSearchTerm && (
                                <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-white border border-purple-200 text-purple-700 rounded-lg text-xs font-medium shadow-sm">
                                  <Search className="h-3 w-3" />
                                  "{unitsSearchTerm}"
                                  <button
                                    onClick={() => { setUnitsSearchTerm(""); setUnitsCurrentPage(1); }}
                                    className="ml-1 hover:text-purple-900"
                                  >
                                    <X className="h-3 w-3" />
                                  </button>
                                </span>
                              )}
                              {unitsPropertyFilter !== "all" && (
                                <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-white border border-blue-200 text-blue-700 rounded-lg text-xs font-medium shadow-sm">
                                  <Building2 className="h-3 w-3" />
                                  {properties.find(p => p.id === unitsPropertyFilter)?.name || "Property"}
                                  <button
                                    onClick={() => { setUnitsPropertyFilter("all"); setUnitsCurrentPage(1); }}
                                    className="ml-1 hover:text-blue-900"
                                  >
                                    <X className="h-3 w-3" />
                                  </button>
                                </span>
                              )}
                              {unitsStatusFilter !== "all" && (
                                <span className={`inline-flex items-center gap-1.5 px-3 py-1 bg-white rounded-lg text-xs font-medium shadow-sm ${
                                  unitsStatusFilter === "occupied" ? "border border-green-200 text-green-700" :
                                  unitsStatusFilter === "vacant" ? "border border-amber-200 text-amber-700" :
                                  "border border-red-200 text-red-700"
                                }`}>
                                  {unitsStatusFilter === "occupied" ? <Users className="h-3 w-3" /> :
                                   unitsStatusFilter === "vacant" ? <Home className="h-3 w-3" /> :
                                   <Wrench className="h-3 w-3" />}
                                  {unitsStatusFilter.charAt(0).toUpperCase() + unitsStatusFilter.slice(1)}
                                  <button
                                    onClick={() => { setUnitsStatusFilter("all"); setUnitsCurrentPage(1); }}
                                    className="ml-1 hover:opacity-70"
                                  >
                                    <X className="h-3 w-3" />
                                  </button>
                                </span>
                              )}
                            </div>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => {
                                setUnitsSearchTerm("");
                                setUnitsPropertyFilter("all");
                                setUnitsStatusFilter("all");
                                setUnitsCurrentPage(1);
                              }}
                              className="text-purple-600 hover:text-purple-800 hover:bg-purple-100"
                            >
                              Clear all
                            </Button>
                          </div>
                        )}

                        {unitsViewMode === "grid" ? (
                          /* Grid View */
                          <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
                            {paginatedUnits.map((unit) => {
                        const property = properties.find((p) => p.id === unit.propertyId);
                        const isOccupied = unit.status === 'occupied';
                        const isVacant = unit.status === 'vacant';
                        const isMaintenance = unit.status === 'maintenance';

                        return (
                          <div
                            key={unit.id}
                            className="group bg-white rounded-2xl border border-gray-200 hover:border-[#7C3AED]/30 hover:shadow-lg transition-all duration-300 overflow-hidden"
                          >
                            {/* Unit Header with Status Color */}
                            <div className={`h-1.5 ${
                              isOccupied ? 'bg-gradient-to-r from-[#10B981] to-[#34D399]' :
                              isVacant ? 'bg-gradient-to-r from-[#F59E0B] to-[#FBBF24]' :
                              'bg-gradient-to-r from-[#EF4444] to-[#F87171]'
                            }`} />

                            <div className="p-5">
                              {/* Top Row: Unit Badge & Status */}
                              <div className="flex items-start justify-between mb-4">
                                <div>
                                  <span className="inline-flex items-center px-3 py-1.5 rounded-xl bg-gradient-to-r from-[#7C3AED]/10 to-[#A855F7]/10 text-sm font-bold text-[#7C3AED] border border-[#7C3AED]/20">
                                    {unit.unit}
                                  </span>
                                  <p className="text-sm text-gray-500 mt-2 flex items-center gap-1">
                                    <MapPin className="h-3.5 w-3.5" />
                                    {property?.name || 'Unknown Property'}
                                  </p>
                                </div>
                                <Badge
                                  variant="outline"
                                  className={`${
                                    isOccupied ? 'bg-green-50 text-green-700 border-green-200' :
                                    isVacant ? 'bg-amber-50 text-amber-700 border-amber-200' :
                                    'bg-red-50 text-red-700 border-red-200'
                                  } font-semibold`}
                                >
                                  {unit.status.charAt(0).toUpperCase() + unit.status.slice(1)}
                                </Badge>
                              </div>

                              {/* Unit Details */}
                              <div className="flex items-center gap-2 mb-4">
                                <div className="flex items-center gap-1.5 px-2.5 py-1.5 bg-gray-100 rounded-lg">
                                  <Bed className="h-4 w-4 text-gray-600" />
                                  <span className="text-sm font-medium text-gray-900">{unit.bedrooms}</span>
                                </div>
                                <div className="flex items-center gap-1.5 px-2.5 py-1.5 bg-gray-100 rounded-lg">
                                  <Bath className="h-4 w-4 text-gray-600" />
                                  <span className="text-sm font-medium text-gray-900">{unit.bathrooms}</span>
                                </div>
                                {unit.sqft && (
                                  <div className="flex items-center gap-1.5 px-2.5 py-1.5 bg-gray-100 rounded-lg">
                                    <Maximize className="h-4 w-4 text-gray-600" />
                                    <span className="text-sm font-medium text-gray-900">{unit.sqft} sqft</span>
                                  </div>
                                )}
                              </div>

                              {/* Rent Display */}
                              <div className="p-3 bg-gradient-to-r from-[#10B981]/5 to-[#10B981]/10 rounded-xl border border-[#10B981]/20 mb-4">
                                <p className="text-xs text-gray-500 mb-1">Monthly Rent</p>
                                <p className="text-xl font-bold text-[#10B981]">
                                  {formatCurrency(unit.rent, property?.currency || "USD")}
                                </p>
                              </div>

                              {/* Tenant Info or Vacant State */}
                              {unit.tenant ? (
                                <div className="p-3 bg-gray-50 rounded-xl mb-4">
                                  <div className="flex items-center gap-3">
                                    <div className="h-10 w-10 rounded-full bg-gradient-to-br from-[#7C3AED] to-[#A855F7] flex items-center justify-center text-white font-bold text-sm">
                                      {unit.tenant.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-900">{unit.tenant}</p>
                                      <p className="text-xs text-gray-500">{unit.phoneNumber || 'No phone'}</p>
                                    </div>
                                  </div>
                                  {unit.leaseEnd && (
                                    <div className="mt-3 pt-3 border-t border-gray-200 flex items-center gap-2 text-xs text-gray-500">
                                      <Calendar className="h-3.5 w-3.5" />
                                      <span>Lease expires: <span className="font-medium text-gray-700">{unit.leaseEnd}</span></span>
                                    </div>
                                  )}
                                </div>
                              ) : (
                                <div className="p-3 bg-amber-50 rounded-xl mb-4 border border-amber-100">
                                  <div className="flex items-center gap-2">
                                    <div className="h-8 w-8 rounded-full bg-amber-100 flex items-center justify-center">
                                      <Users className="h-4 w-4 text-amber-600" />
                                    </div>
                                    <div>
                                      <p className="text-sm font-medium text-amber-800">Vacant Unit</p>
                                      <p className="text-xs text-amber-600">Available for new tenant</p>
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Action Buttons */}
                              <div className="flex items-center gap-2">
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() => handleViewUnit(unit)}
                                  className="flex-1 border-gray-200 hover:border-[#7C3AED] hover:text-[#7C3AED] transition-colors"
                                >
                                  <Eye className="h-4 w-4 mr-1.5" />
                                  View
                                </Button>
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() => handleEditUnit(unit)}
                                  className="flex-1 border-gray-200 hover:border-[#7C3AED] hover:text-[#7C3AED] transition-colors"
                                >
                                  <Edit className="h-4 w-4 mr-1.5" />
                                  Edit
                                </Button>
                                <DropdownMenu>
                                  <DropdownMenuTrigger asChild>
                                    <Button
                                      variant="outline"
                                      size="sm"
                                      className="border-gray-200 hover:border-[#7C3AED] hover:text-[#7C3AED] px-2"
                                    >
                                      <MoreHorizontal className="h-4 w-4" />
                                    </Button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent align="end" className="w-48">
                                    <DropdownMenuLabel className="font-semibold text-gray-900">
                                      More Actions
                                    </DropdownMenuLabel>
                                    <DropdownMenuSeparator />
                                    <DropdownMenuItem
                                      onClick={() => {
                                        setUnitToDelete(unit);
                                        setShowDeleteDialog(true);
                                      }}
                                      className="text-red-600 focus:text-red-600 focus:bg-red-50 cursor-pointer"
                                    >
                                      <Trash2 className="h-4 w-4 mr-2" />
                                      Delete Unit
                                    </DropdownMenuItem>
                                  </DropdownMenuContent>
                                </DropdownMenu>
                              </div>
                            </div>
                          </div>
                        );
                            })}
                          </div>
                        ) : (
                          /* List View */
                          <div className="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                            {/* List Header */}
                            <div className="grid grid-cols-12 gap-4 px-6 py-3 bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                              <div className="col-span-2">Unit</div>
                              <div className="col-span-2">Property</div>
                              <div className="col-span-1">Type</div>
                              <div className="col-span-2">Tenant</div>
                              <div className="col-span-2">Rent</div>
                              <div className="col-span-1">Status</div>
                              <div className="col-span-2 text-right">Actions</div>
                            </div>

                            {/* List Items */}
                            <div className="divide-y divide-gray-100">
                              {paginatedUnits.map((unit) => {
                          const property = properties.find((p) => p.id === unit.propertyId);
                          const isOccupied = unit.status === 'occupied';
                          const isVacant = unit.status === 'vacant';
                          const isMaintenance = unit.status === 'maintenance';

                          return (
                            <div
                              key={unit.id}
                              className="grid grid-cols-12 gap-4 px-6 py-4 items-center hover:bg-gray-50 transition-colors group"
                            >
                              {/* Unit */}
                              <div className="col-span-2">
                                <div className="flex items-center gap-3">
                                  <div className={`h-10 w-10 rounded-xl flex items-center justify-center ${
                                    isOccupied ? 'bg-green-100' :
                                    isVacant ? 'bg-amber-100' :
                                    'bg-red-100'
                                  }`}>
                                    <Home className={`h-5 w-5 ${
                                      isOccupied ? 'text-green-600' :
                                      isVacant ? 'text-amber-600' :
                                      'text-red-600'
                                    }`} />
                                  </div>
                                  <div>
                                    <p className="font-bold text-gray-900">{unit.unit}</p>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                      <span className="flex items-center gap-1">
                                        <Bed className="h-3 w-3" /> {unit.bedrooms}
                                      </span>
                                      <span className="flex items-center gap-1">
                                        <Bath className="h-3 w-3" /> {unit.bathrooms}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {/* Property */}
                              <div className="col-span-2">
                                <p className="text-sm font-medium text-gray-900 truncate">
                                  {property?.name || 'Unknown'}
                                </p>
                                <p className="text-xs text-gray-500 truncate">
                                  {property?.address || '-'}
                                </p>
                              </div>

                              {/* Type */}
                              <div className="col-span-1">
                                <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-purple-50 text-xs font-medium text-purple-700">
                                  {unit.type || 'Unit'}
                                </span>
                              </div>

                              {/* Tenant */}
                              <div className="col-span-2">
                                {unit.tenant ? (
                                  <div className="flex items-center gap-2">
                                    <div className="h-8 w-8 rounded-full bg-gradient-to-br from-[#7C3AED] to-[#A855F7] flex items-center justify-center text-white font-bold text-xs">
                                      {unit.tenant.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                      <p className="text-sm font-medium text-gray-900 truncate">{unit.tenant}</p>
                                      <p className="text-xs text-gray-500">{unit.phoneNumber || 'No phone'}</p>
                                    </div>
                                  </div>
                                ) : (
                                  <span className="text-sm text-gray-400 italic">No tenant</span>
                                )}
                              </div>

                              {/* Rent */}
                              <div className="col-span-2">
                                <p className="text-sm font-bold text-[#10B981]">
                                  {formatCurrency(unit.rent, property?.currency || "USD")}
                                </p>
                                <p className="text-xs text-gray-500">per month</p>
                              </div>

                              {/* Status */}
                              <div className="col-span-1">
                                <Badge
                                  variant="outline"
                                  className={`${
                                    isOccupied ? 'bg-green-50 text-green-700 border-green-200' :
                                    isVacant ? 'bg-amber-50 text-amber-700 border-amber-200' :
                                    'bg-red-50 text-red-700 border-red-200'
                                  } font-semibold text-xs`}
                                >
                                  {unit.status.charAt(0).toUpperCase() + unit.status.slice(1)}
                                </Badge>
                              </div>

                              {/* Actions */}
                              <div className="col-span-2 flex items-center justify-end gap-1">
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => handleViewUnit(unit)}
                                  className="h-8 w-8 p-0 text-gray-400 hover:text-[#7C3AED] hover:bg-purple-50"
                                >
                                  <Eye className="h-4 w-4" />
                                </Button>
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => handleEditUnit(unit)}
                                  className="h-8 w-8 p-0 text-gray-400 hover:text-[#7C3AED] hover:bg-purple-50"
                                >
                                  <Edit className="h-4 w-4" />
                                </Button>
                                <DropdownMenu>
                                  <DropdownMenuTrigger asChild>
                                    <Button
                                      variant="ghost"
                                      size="sm"
                                      className="h-8 w-8 p-0 text-gray-400 hover:text-[#7C3AED] hover:bg-purple-50"
                                    >
                                      <MoreHorizontal className="h-4 w-4" />
                                    </Button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent align="end" className="w-48">
                                    <DropdownMenuLabel className="font-semibold text-gray-900">
                                      More Actions
                                    </DropdownMenuLabel>
                                    <DropdownMenuSeparator />
                                    <DropdownMenuItem
                                      onClick={() => {
                                        setUnitToDelete(unit);
                                        setShowDeleteDialog(true);
                                      }}
                                      className="text-red-600 focus:text-red-600 focus:bg-red-50 cursor-pointer"
                                    >
                                      <Trash2 className="h-4 w-4 mr-2" />
                                      Delete Unit
                                    </DropdownMenuItem>
                                  </DropdownMenuContent>
                                </DropdownMenu>
                                </div>
                              </div>
                            );
                          })}
                            </div>
                          </div>
                        )}

                        {/* Pagination Controls */}
                        {totalPages > 1 && (
                          <div className="flex items-center justify-between mt-6 pt-6 border-t border-gray-200">
                            <div className="text-sm text-gray-600">
                              Showing <span className="font-semibold text-gray-900">{startIndex + 1}</span> to{' '}
                              <span className="font-semibold text-gray-900">{Math.min(endIndex, filteredUnits.length)}</span> of{' '}
                              <span className="font-semibold text-gray-900">{filteredUnits.length}</span> units
                              {filteredUnits.length !== units.length && (
                                <span className="text-gray-400 ml-1">(filtered from {units.length})</span>
                              )}
                            </div>

                            <div className="flex items-center gap-2">
                              {/* Previous Button */}
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => setUnitsCurrentPage(prev => Math.max(1, prev - 1))}
                                disabled={unitsCurrentPage === 1}
                                className="border-gray-200 hover:border-[#7C3AED] hover:text-[#7C3AED] disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                <svg className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                </svg>
                                Previous
                              </Button>

                              {/* Page Numbers */}
                              <div className="flex items-center gap-1">
                                {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => {
                                  // Show first page, last page, current page, and pages around current
                                  const showPage = page === 1 ||
                                    page === totalPages ||
                                    Math.abs(page - unitsCurrentPage) <= 1;

                                  // Show ellipsis
                                  const showEllipsisBefore = page === unitsCurrentPage - 2 && unitsCurrentPage > 3;
                                  const showEllipsisAfter = page === unitsCurrentPage + 2 && unitsCurrentPage < totalPages - 2;

                                  if (showEllipsisBefore || showEllipsisAfter) {
                                    return (
                                      <span key={page} className="px-2 text-gray-400">...</span>
                                    );
                                  }

                                  if (!showPage) return null;

                                  return (
                                    <button
                                      key={page}
                                      onClick={() => setUnitsCurrentPage(page)}
                                      className={`h-8 w-8 rounded-lg text-sm font-medium transition-all ${
                                        page === unitsCurrentPage
                                          ? 'bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] text-white shadow-md'
                                          : 'text-gray-600 hover:bg-purple-50 hover:text-[#7C3AED]'
                                      }`}
                                    >
                                      {page}
                                    </button>
                                  );
                                })}
                              </div>

                              {/* Next Button */}
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => setUnitsCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                disabled={unitsCurrentPage === totalPages}
                                className="border-gray-200 hover:border-[#7C3AED] hover:text-[#7C3AED] disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                Next
                                <svg className="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                              </Button>
                            </div>
                          </div>
                        )}
                      </>
                    );
                  })()}
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="financials" className="space-y-6">
              {/* Financial Overview Header */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-[#10B981] to-[#059669] px-6 py-6">
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                    <div>
                      <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <div className="h-10 w-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                          <DollarSign className="h-5 w-5 text-white" />
                        </div>
                        Financial Overview
                      </h2>
                      <p className="text-green-100 text-sm mt-2">
                        Track your portfolio's financial performance
                      </p>
                    </div>

                    {/* Key Financial Stats in Header */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <TooltipProvider>
                        <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[160px]">
                          <Tooltip>
                            <TooltipTrigger asChild>
                              <div className="flex items-center gap-3 cursor-help">
                                <div className="h-10 w-10 rounded-xl bg-white/20 flex items-center justify-center">
                                  <TrendingUp className="h-5 w-5 text-white" />
                                </div>
                                <div>
                                  <p className="text-xl font-bold text-white">{formatCurrency(Number(financialStats.gross) || 0, smartBaseCurrency)}</p>
                                  <p className="text-xs text-green-100">Gross Income</p>
                                </div>
                              </div>
                            </TooltipTrigger>
                            <TooltipContent className="max-w-xs">
                              <p className="font-semibold mb-1">Gross Income</p>
                              <p className="text-xs">Sum of all monthly rent from occupied units across all properties.</p>
                            </TooltipContent>
                          </Tooltip>
                        </div>

                        <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[160px]">
                          <Tooltip>
                            <TooltipTrigger asChild>
                              <div className="flex items-center gap-3 cursor-help">
                                <div className="h-10 w-10 rounded-xl bg-[#3B82F6]/40 flex items-center justify-center">
                                  <DollarSign className="h-5 w-5 text-white" />
                                </div>
                                <div>
                                  <p className="text-xl font-bold text-white">{formatCurrency(Number(financialStats.net) || 0, smartBaseCurrency)}</p>
                                  <p className="text-xs text-green-100">Net Income</p>
                                </div>
                              </div>
                            </TooltipTrigger>
                            <TooltipContent className="max-w-xs">
                              <p className="font-semibold mb-1">Net Income (NOI)</p>
                              <p className="text-xs">Gross Income minus Operating Expenses.</p>
                            </TooltipContent>
                          </Tooltip>
                        </div>

                        <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[160px]">
                          <Tooltip>
                            <TooltipTrigger asChild>
                              <div className="flex items-center gap-3 cursor-help">
                                <div className="h-10 w-10 rounded-xl bg-[#EF4444]/40 flex items-center justify-center">
                                  <TrendingDown className="h-5 w-5 text-white" />
                                </div>
                                <div>
                                  <p className="text-xl font-bold text-white">{formatCurrency(Number(financialStats.expenses) || 0, smartBaseCurrency)}</p>
                                  <p className="text-xs text-green-100">Expenses</p>
                                </div>
                              </div>
                            </TooltipTrigger>
                            <TooltipContent className="max-w-xs">
                              <p className="font-semibold mb-1">Operating Expenses</p>
                              <p className="text-xs">Estimated at 30% of Gross Income including maintenance, fees, and utilities.</p>
                            </TooltipContent>
                          </Tooltip>
                        </div>

                        <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[120px]">
                          <Tooltip>
                            <TooltipTrigger asChild>
                              <div className="flex items-center gap-3 cursor-help">
                                <div className="h-10 w-10 rounded-xl bg-[#7C3AED]/40 flex items-center justify-center">
                                  <Percent className="h-5 w-5 text-white" />
                                </div>
                                <div>
                                  <p className="text-xl font-bold text-white">{(Number(financialStats.capRate) || 0).toLocaleString()}%</p>
                                  <p className="text-xs text-green-100">Cap Rate</p>
                                </div>
                              </div>
                            </TooltipTrigger>
                            <TooltipContent className="max-w-xs">
                              <p className="font-semibold mb-1">Capitalization Rate</p>
                              <p className="text-xs">Annual NOI Ã· Total Property Value. Higher rates = better returns.</p>
                            </TooltipContent>
                          </Tooltip>
                        </div>
                      </TooltipProvider>
                    </div>
                  </div>

                  {/* Profit Margin Bar */}
                  <div className="mt-6 bg-white/10 backdrop-blur-sm rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-green-100">Profit Margin</span>
                      <span className="text-sm font-bold text-white">
                        {Number(financialStats.gross) > 0
                          ? ((Number(financialStats.net) / Number(financialStats.gross)) * 100).toFixed(1)
                          : 0}%
                      </span>
                    </div>
                    <div className="h-2.5 bg-white/20 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-white rounded-full transition-all duration-500"
                        style={{ width: `${Number(financialStats.gross) > 0 ? (Number(financialStats.net) / Number(financialStats.gross)) * 100 : 0}%` }}
                      />
                    </div>
                    <div className="flex items-center justify-between mt-2 text-xs text-green-200">
                      <span>Income: {formatCurrency(Number(financialStats.gross) || 0, smartBaseCurrency)}</span>
                      <span>Expenses: {formatCurrency(Number(financialStats.expenses) || 0, smartBaseCurrency)}</span>
                      <span>Net: {formatCurrency(Number(financialStats.net) || 0, smartBaseCurrency)}</span>
                    </div>
                  </div>
                </div>
              </Card>

              {/* Property Financial Performance */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-purple-50 to-violet-50 px-6 py-4 border-b border-purple-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-[#7C3AED]/20 flex items-center justify-center">
                        <BarChart3 className="h-5 w-5 text-[#7C3AED]" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Property Financial Performance</h3>
                        <p className="text-xs text-gray-500">Revenue, expenses, and profitability by property</p>
                      </div>
                    </div>
                  </div>
                </div>
                <CardContent className="p-0">
                  <div className="overflow-hidden">
                    <Table>
                      <TableHeader>
                        <TableRow className="bg-gray-50 hover:bg-gray-50 border-b border-gray-200">
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Property
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Gross Rent
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Expenses
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Net Income
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Cap Rate
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Cash Flow
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Actions
                          </TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {visibleProperties.map((property, index) => (
                          <TableRow
                            key={property.id}
                            className={`hover:bg-[#7C3AED]/5 transition-colors ${
                              index % 2 === 0 ? "bg-white" : "bg-gray-50/50"
                            }`}
                          >
                            <TableCell>
                              <div>
                                <p className="font-semibold text-gray-900">
                                  {property.name}
                                </p>
                                <p className="text-sm text-gray-500">
                                  {property._count?.units ?? 0} units
                                </p>
                              </div>
                            </TableCell>
                            <TableCell>
                              <span className="inline-flex items-center px-3 py-1.5 rounded-lg bg-gradient-to-r from-[#10B981]/10 to-[#10B981]/5 border border-[#10B981]/20">
                                <span className="text-sm font-bold text-[#10B981]">
                                  {formatCurrency(
                                    Number(property.totalMonthlyIncome) || 0,
                                    property.currency || "NGN"
                                  )}
                                </span>
                              </span>
                            </TableCell>
                            <TableCell>
                              <span className="inline-flex items-center px-3 py-1.5 rounded-lg bg-[#EF4444]/10 border border-[#EF4444]/20">
                                <span className="text-sm font-bold text-[#EF4444]">
                                  {formatCurrency(
                                    0,
                                    property.currency || "NGN"
                                  )}
                                </span>
                              </span>
                            </TableCell>
                            <TableCell>
                              <span className="text-sm font-semibold text-gray-900">
                                {formatCurrency(
                                  Number(property.totalMonthlyIncome) || 0,
                                  property.currency || "NGN"
                                )}
                              </span>
                            </TableCell>
                            <TableCell>
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-semibold text-gray-900">
                                  {0}%
                                </span>
                                {false ? (
                                  <div className="p-1 bg-[#10B981]/10 rounded-lg">
                                    <ArrowUpRight className="h-4 w-4 text-[#10B981]" />
                                  </div>
                                ) : (
                                  <div className="p-1 bg-[#EF4444]/10 rounded-lg">
                                    <ArrowDownRight className="h-4 w-4 text-[#EF4444]" />
                                  </div>
                                )}
                              </div>
                            </TableCell>
                            <TableCell>
                              <span className="inline-flex items-center px-3 py-1.5 rounded-lg bg-[#3B82F6]/10 border border-[#3B82F6]/20">
                                <span className="text-sm font-bold text-[#3B82F6]">
                                  {(
                                    Number(property.totalMonthlyIncome) || 0
                                  ).toLocaleString()}
                                </span>
                              </span>
                            </TableCell>
                            <TableCell>
                              <Button
                                size="sm"
                                onClick={() =>
                                  handleOpenFinancialDetails(property)
                                }
                                className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-md hover:shadow-lg transition-all"
                              >
                                <FileText className="h-4 w-4 mr-2" />
                                Details
                              </Button>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>
                </CardContent>
              </Card>

              {/* Expense Breakdown - Enhanced Design */}
              <div className="grid lg:grid-cols-2 gap-6">
                <Card className="border-0 shadow-xl overflow-hidden">
                  <div className="bg-gradient-to-r from-red-50 to-rose-50 px-6 py-4 border-b border-red-100">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-[#EF4444]/20 flex items-center justify-center">
                        <TrendingDown className="h-5 w-5 text-[#EF4444]" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Expense Categories</h3>
                        <p className="text-xs text-gray-500">Monthly operating expenses breakdown</p>
                      </div>
                    </div>
                  </div>
                  <CardContent className="p-5">
                    <div className="space-y-3">
                      {expenseCategoryBreakdown.items.length ? (
                        expenseCategoryBreakdown.items.map((item, idx) => (
                          <div
                            key={item.key}
                            className="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors group"
                          >
                            <div className="flex items-center gap-4">
                              <div className="h-10 w-10 rounded-xl bg-gradient-to-br from-[#7C3AED] to-[#A855F7] flex items-center justify-center text-white font-bold text-sm">
                                {idx + 1}
                              </div>
                              <div>
                                <span className="font-semibold text-gray-900 group-hover:text-[#7C3AED] transition-colors">
                                  {item.label}
                                </span>
                                <div className="flex items-center gap-2 mt-1">
                                  <div className="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div
                                      className="h-full bg-gradient-to-r from-[#EF4444] to-[#F87171] rounded-full"
                                      style={{ width: `${item.percent}%` }}
                                    />
                                  </div>
                                  <span className="text-xs text-gray-500">{item.percent.toFixed(1)}%</span>
                                </div>
                              </div>
                            </div>
                            <span className="font-bold text-[#EF4444]">
                              {formatCurrency(item.amount, smartBaseCurrency)}
                            </span>
                          </div>
                        ))
                      ) : (
                        <div className="text-center py-10">
                          <div className="mx-auto w-14 h-14 bg-red-100 rounded-2xl flex items-center justify-center mb-3">
                            <FileText className="h-7 w-7 text-[#EF4444]" />
                          </div>
                          <p className="text-sm font-medium text-gray-900">No expense data</p>
                          <p className="text-xs text-gray-500 mt-1">Expenses will appear once recorded</p>
                        </div>
                      )}

                      {expenseCategoryBreakdown.items.length > 0 && (
                        <div className="flex items-center justify-between p-4 bg-gradient-to-r from-[#EF4444]/10 to-[#F87171]/5 rounded-xl border border-[#EF4444]/20 mt-4">
                          <span className="font-bold text-gray-900">Total Monthly Expenses</span>
                          <span className="text-lg font-bold text-[#EF4444]">
                            {formatCurrency(expenseCategoryBreakdown.total, smartBaseCurrency)}
                          </span>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>

                <Card className="border-0 shadow-xl overflow-hidden">
                  <div className="bg-gradient-to-r from-blue-50 to-cyan-50 px-6 py-4 border-b border-blue-100">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                        <LineChart className="h-5 w-5 text-blue-600" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Financial Trends</h3>
                        <p className="text-xs text-gray-500">6-month performance overview</p>
                      </div>
                    </div>
                  </div>
                  <CardContent className="p-5">
                    <TooltipProvider>
                      <div className="space-y-3">
                        {financialTrendCards.length ? (
                          financialTrendCards.map((card) => (
                            <div
                              key={card.title}
                              className="p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200"
                            >
                              <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-2">
                                  <span className="text-sm font-semibold text-gray-900">
                                    {card.title}
                                  </span>
                                  {card.tooltip && (
                                    <Tooltip delayDuration={150}>
                                      <TooltipTrigger asChild>
                                        <Info className="h-3.5 w-3.5 text-gray-400 cursor-help hover:text-[#7C3AED] transition-colors" />
                                      </TooltipTrigger>
                                      <TooltipContent className="max-w-xs text-xs">
                                        <p>{card.tooltip}</p>
                                      </TooltipContent>
                                    </Tooltip>
                                  )}
                                </div>
                                {card.change !== null && (
                                  <div
                                    className={`flex items-center gap-1 px-2.5 py-1 rounded-lg ${
                                      card.positive
                                        ? "bg-[#10B981]/10 text-[#10B981]"
                                        : "bg-[#EF4444]/10 text-[#EF4444]"
                                    }`}
                                  >
                                    {card.positive ? (
                                      <ArrowUpRight className="h-3.5 w-3.5" />
                                    ) : (
                                      <ArrowDownRight className="h-3.5 w-3.5" />
                                    )}
                                    <span className="text-xs font-bold">
                                      {card.change > 0 ? "+" : ""}
                                      {card.change.toFixed(1)}%
                                    </span>
                                  </div>
                                )}
                              </div>
                              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div
                                  className={`h-full rounded-full transition-all duration-500 ${
                                    card.positive
                                      ? 'bg-gradient-to-r from-[#10B981] to-[#34D399]'
                                      : 'bg-gradient-to-r from-[#3B82F6] to-[#60A5FA]'
                                  }`}
                                  style={{ width: `${card.progress}%` }}
                                />
                              </div>
                              <div className="flex items-center justify-between mt-2">
                                <p className="text-sm font-bold text-gray-900">{card.value}</p>
                                {card.subtitle && (
                                  <p className="text-xs text-gray-500">{card.subtitle}</p>
                                )}
                              </div>
                            </div>
                          ))
                        ) : (
                          <div className="text-center py-10">
                            <div className="mx-auto w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center mb-3">
                              <LineChart className="h-7 w-7 text-blue-600" />
                            </div>
                            <p className="text-sm font-medium text-gray-900">No trend data yet</p>
                            <p className="text-xs text-gray-500 mt-1">Data will appear once transactions are recorded</p>
                          </div>
                        )}
                      </div>
                    </TooltipProvider>
                  </CardContent>
                </Card>
              </div>

              {/* Expense Management Section */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-amber-50 to-yellow-50 px-6 py-4 border-b border-amber-100 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-xl bg-[#F59E0B]/20 flex items-center justify-center">
                      <FileText className="h-5 w-5 text-[#F59E0B]" />
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-gray-900">Expense Management</h3>
                      <p className="text-xs text-gray-500">Track and manage property expenses</p>
                    </div>
                  </div>
                  <Button
                    onClick={handleAddExpense}
                    className="bg-gradient-to-r from-[#F59E0B] to-[#D97706] hover:from-[#D97706] hover:to-[#B45309] text-white shadow-lg"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Add Expense
                  </Button>
                </div>
                <CardContent>
                  {/* Expense Statistics */}
                  {expenseStats && (
                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium">
                            Total Expenses
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">
                            {formatCurrency(
                              expenseStats.totalAmount || 0,
                              smartBaseCurrency
                            )}
                          </div>
                          <p className="text-xs text-muted-foreground">
                            {expenseStats.totalCount || 0} transactions
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium">
                            Paid
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-green-600">
                            {formatCurrency(
                              expenseStats.byStatus?.find(
                                (s: any) => s.status === "paid"
                              )?._sum?.amount || 0,
                              smartBaseCurrency
                            )}
                          </div>
                          <p className="text-xs text-muted-foreground">
                            {expenseStats.byStatus?.find(
                              (s: any) => s.status === "paid"
                            )?._count || 0}{" "}
                            expenses
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium">
                            Pending
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-yellow-600">
                            {formatCurrency(
                              expenseStats.byStatus?.find(
                                (s: any) => s.status === "pending"
                              )?._sum?.amount || 0,
                              smartBaseCurrency
                            )}
                          </div>
                          <p className="text-xs text-muted-foreground">
                            {expenseStats.byStatus?.find(
                              (s: any) => s.status === "pending"
                            )?._count || 0}{" "}
                            expenses
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium">
                            Top Category
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">
                            {expenseStats.byCategory &&
                            expenseStats.byCategory.length > 0
                              ? EXPENSE_CATEGORIES.find(
                                  (c) =>
                                    c.value ===
                                    expenseStats.byCategory[0].category
                                )?.label || expenseStats.byCategory[0].category
                              : "N/A"}
                          </div>
                          <p className="text-xs text-muted-foreground">
                            {expenseStats.byCategory &&
                            expenseStats.byCategory.length > 0
                              ? formatCurrency(
                                  expenseStats.byCategory[0]._sum?.amount || 0,
                                  smartBaseCurrency
                                )
                              : "-"}
                          </p>
                        </CardContent>
                      </Card>
                    </div>
                  )}

                  {/* Expense Table */}
                  <div className="rounded-md border">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Date</TableHead>
                          <TableHead>Property</TableHead>
                          <TableHead>Category</TableHead>
                          <TableHead>Description</TableHead>
                          <TableHead>Amount</TableHead>
                          <TableHead>Status</TableHead>
                          <TableHead className="text-right">Actions</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {expenses.length === 0 ? (
                          <TableRow>
                            <TableCell
                              colSpan={7}
                              className="text-center text-muted-foreground py-8"
                            >
                              No expenses recorded yet. Click "Add Expense" to
                              get started.
                            </TableCell>
                          </TableRow>
                        ) : (
                          expenses.map((expense) => (
                            <TableRow key={expense.id}>
                              <TableCell>
                                {new Date(expense.date).toLocaleDateString()}
                              </TableCell>
                              <TableCell>
                                <div>
                                  <p className="font-medium">
                                    {expense.property?.name || "Unknown"}
                                  </p>
                                  {expense.unit && (
                                    <p className="text-xs text-muted-foreground">
                                      Unit {expense.unit.unitNumber}
                                    </p>
                                  )}
                                </div>
                              </TableCell>
                              <TableCell>
                                <Badge variant="outline">
                                  {EXPENSE_CATEGORIES.find(
                                    (c) => c.value === expense.category
                                  )?.label || expense.category}
                                </Badge>
                              </TableCell>
                              <TableCell className="max-w-[200px] truncate">
                                {expense.description}
                              </TableCell>
                              <TableCell className="font-medium">
                                {formatCurrency(
                                  expense.amount,
                                  expense.currency
                                )}
                              </TableCell>
                              <TableCell>
                                <Badge
                                  variant={
                                    expense.status === "paid"
                                      ? "default"
                                      : expense.status === "pending"
                                      ? "secondary"
                                      : expense.status === "overdue"
                                      ? "destructive"
                                      : "outline"
                                  }
                                >
                                  {expense.status}
                                </Badge>
                              </TableCell>
                              <TableCell className="text-right">
                                <DropdownMenu>
                                  <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" size="sm">
                                      <MoreHorizontal className="h-4 w-4" />
                                    </Button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent align="end">
                                    <DropdownMenuItem
                                      onClick={() => handleEditExpense(expense)}
                                    >
                                      <Edit className="h-4 w-4 mr-2" />
                                      Edit
                                    </DropdownMenuItem>
                                    <DropdownMenuSeparator />
                                    <DropdownMenuItem
                                      className="text-red-600"
                                      onClick={() => {
                                        setExpenseToDelete(expense);
                                        setShowExpenseDeleteDialog(true);
                                      }}
                                    >
                                      <Trash2 className="h-4 w-4 mr-2" />
                                      Delete
                                    </DropdownMenuItem>
                                  </DropdownMenuContent>
                                </DropdownMenu>
                              </TableCell>
                            </TableRow>
                          ))
                        )}
                      </TableBody>
                    </Table>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="maintenance" className="space-y-6">
              {/* Maintenance Overview Header */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-[#F59E0B] to-[#D97706] px-6 py-6">
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                    <div>
                      <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <div className="h-10 w-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                          <Wrench className="h-5 w-5 text-white" />
                        </div>
                        Maintenance Management
                      </h2>
                      <p className="text-amber-100 text-sm mt-2">
                        Track and manage property maintenance requests
                      </p>
                    </div>

                    {/* Key Stats in Header */}
                    <div className="flex items-center gap-4 flex-wrap">
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[130px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <Wrench className="h-5 w-5 text-white" />
                          </div>
                          <div>
                            <p className="text-2xl font-bold text-white">{maintenanceStatsAggregates.total}</p>
                            <p className="text-xs text-amber-100">Active</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[130px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#EF4444]/40 flex items-center justify-center">
                            <AlertTriangle className="h-5 w-5 text-white" />
                          </div>
                          <div>
                            <p className="text-2xl font-bold text-white">{maintenanceStatsAggregates.highPriority}</p>
                            <p className="text-xs text-amber-100">High Priority</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[130px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#10B981]/40 flex items-center justify-center">
                            <DollarSign className="h-5 w-5 text-white" />
                          </div>
                          <div>
                            <p className="text-xl font-bold text-white">{formatCurrency(maintenanceStatsAggregates.avgCost, smartBaseCurrency)}</p>
                            <p className="text-xs text-amber-100">Avg Cost</p>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white/15 backdrop-blur-sm rounded-2xl px-5 py-3 min-w-[130px]">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-xl bg-[#3B82F6]/40 flex items-center justify-center">
                            <Clock className="h-5 w-5 text-white" />
                          </div>
                          <div>
                            <p className="text-2xl font-bold text-white">
                              {maintenanceStatsAggregates.avgResponseHours !== null
                                ? `${maintenanceStatsAggregates.avgResponseHours.toFixed(1)}h`
                                : "â€”"}
                            </p>
                            <p className="text-xs text-amber-100">Response</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <Button
                      onClick={() => {
                        resetMaintenanceForm();
                        setShowAddMaintenanceDialog(true);
                      }}
                      className="bg-white text-[#D97706] hover:bg-amber-50 shadow-lg font-semibold whitespace-nowrap"
                    >
                      <Plus className="h-4 w-4 mr-2" />
                      Add Request
                    </Button>
                  </div>

                  {/* Priority Breakdown Bar */}
                  <div className="mt-6 bg-white/10 backdrop-blur-sm rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-amber-100">Request Status Breakdown</span>
                      <span className="text-sm font-bold text-white">{maintenanceStatsAggregates.total} total requests</span>
                    </div>
                    <div className="h-2.5 bg-white/20 rounded-full overflow-hidden flex">
                      <div className="h-full bg-[#EF4444]" style={{ width: `${maintenanceStatsAggregates.total > 0 ? (maintenanceStatsAggregates.highPriority / maintenanceStatsAggregates.total) * 100 : 0}%` }} />
                      <div className="h-full bg-[#3B82F6]" style={{ width: '30%' }} />
                      <div className="h-full bg-[#10B981]" style={{ width: '20%' }} />
                    </div>
                    <div className="flex items-center justify-between mt-2 text-xs text-amber-200">
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#EF4444]"></span>
                        High: {maintenanceStatsAggregates.highPriority}
                      </span>
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#3B82F6]"></span>
                        In Progress
                      </span>
                      <span className="flex items-center gap-1.5">
                        <span className="h-2 w-2 rounded-full bg-[#10B981]"></span>
                        Completed
                      </span>
                    </div>
                  </div>
                </div>
              </Card>

              {/* Maintenance Requests */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-purple-50 to-violet-50 px-6 py-4 border-b border-purple-100">
                  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-[#7C3AED]/20 flex items-center justify-center">
                        <Wrench className="h-5 w-5 text-[#7C3AED]" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Maintenance Requests</h3>
                        <p className="text-xs text-gray-500">Track and manage requests across your portfolio</p>
                      </div>
                    </div>

                    {/* Search & Filters */}
                    <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="Search requests..."
                          className="pl-10 w-full sm:w-56 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-10"
                        />
                      </div>
                      <Select defaultValue="all">
                        <SelectTrigger className="w-full sm:w-36 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-10">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">All Status</SelectItem>
                          <SelectItem value="pending">Pending</SelectItem>
                          <SelectItem value="in-progress">In Progress</SelectItem>
                          <SelectItem value="scheduled">Scheduled</SelectItem>
                          <SelectItem value="completed">Completed</SelectItem>
                        </SelectContent>
                      </Select>
                      <Select defaultValue="all">
                        <SelectTrigger className="w-full sm:w-36 bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-10">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">All Priority</SelectItem>
                          <SelectItem value="high">High</SelectItem>
                          <SelectItem value="medium">Medium</SelectItem>
                          <SelectItem value="low">Low</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>
                </div>
                <CardContent className="p-0">
                  <div className="overflow-hidden">
                    <Table>
                      <TableHeader>
                        <TableRow className="bg-gray-50 hover:bg-gray-50 border-b border-gray-200">
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Property & Unit
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Issue
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Tenant
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Priority
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Status
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Assigned To
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Cost
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Date
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Actions
                          </TableHead>
                        </TableRow>
                      </TableHeader>
                        <TableBody>
                          {maintenanceRequests.map(
                            (request: any, index: number) => (
                              <TableRow
                                key={request.id}
                                className={`hover:bg-[#7C3AED]/5 transition-colors ${
                                  index % 2 === 0 ? "bg-white" : "bg-gray-50/50"
                                }`}
                              >
                                <TableCell>
                                  <div>
                                    <p className="font-semibold text-gray-900">
                                      {request.property?.name || "â€”"}
                                    </p>
                                    <p className="text-sm text-gray-500">
                                      Unit {request.unit?.unitNumber || "â€”"}
                                    </p>
                                  </div>
                                </TableCell>
                                <TableCell>
                                  <span className="font-medium text-gray-900">
                                    {request.title}
                                  </span>
                                </TableCell>
                                <TableCell>
                                  <span className="text-sm text-gray-900">
                                    {request.reportedBy?.name || "â€”"}
                                  </span>
                                </TableCell>
                                <TableCell>
                                  <Badge
                                    variant="outline"
                                    className={getPriorityBadge(
                                      request.priority
                                    )}
                                  >
                                    {request.priority.charAt(0).toUpperCase() +
                                      request.priority.slice(1)}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <Badge
                                    variant="outline"
                                    className={
                                      request.status === "completed"
                                        ? "bg-[#10B981]/10 text-[#10B981] border-[#10B981]/30 font-semibold"
                                        : request.status === "in-progress"
                                        ? "bg-[#3B82F6]/10 text-[#3B82F6] border-[#3B82F6]/30 font-semibold"
                                        : request.status === "scheduled"
                                        ? "bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/30 font-semibold"
                                        : "bg-gray-100 text-gray-600 border-gray-300 font-semibold"
                                    }
                                  >
                                    {request.status.charAt(0).toUpperCase() +
                                      request.status.slice(1).replace("-", " ")}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  {request.assignedTo ? (
                                    <span className="text-sm font-medium text-gray-900">
                                      {request.assignedTo?.name}
                                    </span>
                                  ) : (
                                    <span className="inline-flex items-center px-2 py-1 rounded-lg bg-gray-100 text-sm text-gray-500">
                                      Unassigned
                                    </span>
                                  )}
                                </TableCell>
                                <TableCell>
                                  {request.estimatedCost ? (
                                    <span className="inline-flex items-center px-3 py-1.5 rounded-lg bg-[#10B981]/10 border border-[#10B981]/20">
                                      <span className="text-sm font-bold text-[#10B981]">
                                        ${request.estimatedCost}
                                      </span>
                                    </span>
                                  ) : (
                                    <span className="inline-flex items-center px-2 py-1 rounded-lg bg-gray-100 text-sm text-gray-500">
                                      TBD
                                    </span>
                                  )}
                                </TableCell>
                                <TableCell>
                                  <span className="text-sm text-gray-600">
                                    {request.createdAt
                                      ? new Date(
                                          request.createdAt
                                        ).toLocaleDateString()
                                      : "â€”"}
                                  </span>
                                </TableCell>
                                <TableCell>
                                  <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                      <Button
                                        variant="ghost"
                                        size="icon"
                                        className="hover:bg-[#7C3AED]/10 hover:text-[#7C3AED]"
                                      >
                                        <MoreVertical className="h-4 w-4" />
                                      </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent
                                      align="end"
                                      className="w-48"
                                    >
                                      <DropdownMenuItem
                                        onClick={() =>
                                          handleMaintenanceView(request)
                                        }
                                        className="cursor-pointer"
                                      >
                                        <Eye className="h-4 w-4 mr-2 text-blue-600" />
                                        View Details
                                      </DropdownMenuItem>
                                      <DropdownMenuItem
                                        onClick={() =>
                                          handleMaintenanceEdit(request)
                                        }
                                        className="cursor-pointer"
                                      >
                                        <Edit className="h-4 w-4 mr-2 text-[#7C3AED]" />
                                        Edit Request
                                      </DropdownMenuItem>
                                      <DropdownMenuSeparator />
                                      <DropdownMenuItem
                                        className="text-red-600 focus:text-red-600 cursor-pointer"
                                        onClick={() =>
                                          handleMaintenanceDelete(request)
                                        }
                                      >
                                        <Trash2 className="h-4 w-4 mr-2" />
                                        Delete Request
                                      </DropdownMenuItem>
                                    </DropdownMenuContent>
                                  </DropdownMenu>
                                </TableCell>
                              </TableRow>
                            )
                          )}
                        </TableBody>
                      </Table>
                    </div>
                </CardContent>
              </Card>

              {/* Scheduled Maintenance */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-blue-50 to-cyan-50 px-6 py-4 border-b border-blue-100">
                  <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                      <Calendar className="h-5 w-5 text-blue-600" />
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-gray-900">Scheduled Maintenance</h3>
                      <p className="text-xs text-gray-500">Upcoming preventive maintenance and inspections</p>
                    </div>
                  </div>
                </div>
                <CardContent className="p-5">
                  <div className="space-y-3">
                    {scheduledMaintenanceList.length ? (
                      scheduledMaintenanceList.map((request: any, idx: number) => (
                        <div
                          key={request.id}
                          className="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors group"
                        >
                          <div className="flex items-center gap-4">
                            <div className="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                              {new Date(request.scheduledDate || Date.now()).getDate()}
                            </div>
                            <div>
                              <h4 className="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors">{request.title}</h4>
                              <p className="text-sm text-gray-600">
                                {request.property?.name || "Unassigned property"}
                              </p>
                              <p className="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                <Clock className="h-3 w-3" />
                                {request.scheduledDate
                                  ? new Date(request.scheduledDate).toLocaleString()
                                  : "No schedule date"}
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <Badge
                              variant="outline"
                              className={`${
                                request.status === 'completed'
                                  ? 'bg-green-50 text-green-700 border-green-200'
                                  : request.status === 'in-progress'
                                  ? 'bg-blue-50 text-blue-700 border-blue-200'
                                  : 'bg-amber-50 text-amber-700 border-amber-200'
                              } font-semibold`}
                            >
                              {(request.status || "scheduled").toString().replace(/_/g, " ")}
                            </Badge>
                            <Button
                              variant="outline"
                              size="sm"
                              className="border-gray-200 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50"
                            >
                              <Eye className="h-4 w-4 mr-1" />
                              View
                            </Button>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center py-10">
                        <div className="mx-auto w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center mb-3">
                          <Calendar className="h-7 w-7 text-blue-600" />
                        </div>
                        <p className="text-sm font-medium text-gray-900">No scheduled maintenance</p>
                        <p className="text-xs text-gray-500 mt-1">Requests scheduled in advance will appear here</p>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="reports" className="space-y-6">
              {/* Report Analytics Header Card */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-[#7C3AED] via-purple-600 to-[#5B21B6] px-6 py-6">
                  <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div className="flex items-center gap-4">
                      <div className="h-14 w-14 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <FileText className="h-7 w-7 text-white" />
                      </div>
                      <div>
                        <h2 className="text-2xl font-bold text-white">Reports & Analytics</h2>
                        <p className="text-purple-100 text-sm mt-0.5">Generate insights from your portfolio data</p>
                      </div>
                    </div>
                    <div className="flex flex-wrap items-center gap-3">
                      <div className="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
                        <p className="text-purple-100 text-xs">This Month</p>
                        <p className="text-white font-bold text-lg">47 Reports</p>
                      </div>
                      <div className="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
                        <p className="text-purple-100 text-xs">Scheduled</p>
                        <p className="text-white font-bold text-lg">2 Active</p>
                      </div>
                      <div className="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
                        <p className="text-purple-100 text-xs">Downloads</p>
                        <p className="text-white font-bold text-lg">156</p>
                      </div>
                    </div>
                  </div>

                  {/* Report Type Distribution */}
                  <div className="mt-5 bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-purple-100 text-sm">Report Type Distribution</span>
                      <span className="text-white font-semibold text-sm">47 Total</span>
                    </div>
                    <div className="flex gap-1 h-3 rounded-full overflow-hidden">
                      <div className="bg-green-400 w-[30%]" title="Financial: 12"></div>
                      <div className="bg-purple-300 w-[20%]" title="Occupancy: 8"></div>
                      <div className="bg-orange-400 w-[35%]" title="Maintenance: 15"></div>
                      <div className="bg-blue-400 w-[15%]" title="Tenant: 12"></div>
                    </div>
                    <div className="flex flex-wrap items-center gap-4 mt-3">
                      <span className="flex items-center gap-1.5 text-xs text-purple-100">
                        <span className="h-2 w-2 rounded-full bg-green-400"></span>
                        Financial (12)
                      </span>
                      <span className="flex items-center gap-1.5 text-xs text-purple-100">
                        <span className="h-2 w-2 rounded-full bg-purple-300"></span>
                        Occupancy (8)
                      </span>
                      <span className="flex items-center gap-1.5 text-xs text-purple-100">
                        <span className="h-2 w-2 rounded-full bg-orange-400"></span>
                        Maintenance (15)
                      </span>
                      <span className="flex items-center gap-1.5 text-xs text-purple-100">
                        <span className="h-2 w-2 rounded-full bg-blue-400"></span>
                        Tenant (12)
                      </span>
                    </div>
                  </div>
                </div>
              </Card>

              {/* Report Category Stats */}
              <div className="grid md:grid-cols-4 gap-4">
                {/* Financial Reports Card */}
                <Card className="border-0 shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
                  <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-5">
                    <div className="flex items-center justify-between">
                      <div className="h-12 w-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <DollarSign className="h-6 w-6 text-white" />
                      </div>
                      <Badge className="bg-white/20 text-white border-0 backdrop-blur-sm">
                        <TrendingUp className="h-3 w-3 mr-1" />
                        +15%
                      </Badge>
                    </div>
                    <div className="mt-4">
                      <p className="text-green-100 text-xs font-medium">Financial Reports</p>
                      <p className="text-3xl font-bold text-white mt-1">12</p>
                      <p className="text-green-100 text-xs mt-2">P&L, Revenue, Expenses</p>
                    </div>
                    <div className="mt-3 pt-3 border-t border-white/20">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-green-100">Last generated</span>
                        <span className="text-white font-medium">2 days ago</span>
                      </div>
                    </div>
                  </div>
                </Card>

                {/* Occupancy Reports Card */}
                <Card className="border-0 shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
                  <div className="bg-gradient-to-br from-[#7C3AED] to-purple-700 p-5">
                    <div className="flex items-center justify-between">
                      <div className="h-12 w-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <PieChart className="h-6 w-6 text-white" />
                      </div>
                      <Badge className="bg-white/20 text-white border-0 backdrop-blur-sm">
                        <Activity className="h-3 w-3 mr-1" />
                        Weekly
                      </Badge>
                    </div>
                    <div className="mt-4">
                      <p className="text-purple-100 text-xs font-medium">Occupancy Reports</p>
                      <p className="text-3xl font-bold text-white mt-1">8</p>
                      <p className="text-purple-100 text-xs mt-2">Vacancy, Turnover rates</p>
                    </div>
                    <div className="mt-3 pt-3 border-t border-white/20">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-purple-100">Last generated</span>
                        <span className="text-white font-medium">Today</span>
                      </div>
                    </div>
                  </div>
                </Card>

                {/* Maintenance Reports Card */}
                <Card className="border-0 shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
                  <div className="bg-gradient-to-br from-orange-500 to-amber-600 p-5">
                    <div className="flex items-center justify-between">
                      <div className="h-12 w-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <Wrench className="h-6 w-6 text-white" />
                      </div>
                      <Badge className="bg-white/20 text-white border-0 backdrop-blur-sm">
                        <TrendingDown className="h-3 w-3 mr-1" />
                        -8%
                      </Badge>
                    </div>
                    <div className="mt-4">
                      <p className="text-orange-100 text-xs font-medium">Maintenance Reports</p>
                      <p className="text-3xl font-bold text-white mt-1">15</p>
                      <p className="text-orange-100 text-xs mt-2">Work orders, Costs</p>
                    </div>
                    <div className="mt-3 pt-3 border-t border-white/20">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-orange-100">Last generated</span>
                        <span className="text-white font-medium">Yesterday</span>
                      </div>
                    </div>
                  </div>
                </Card>

                {/* Tenant Reports Card */}
                <Card className="border-0 shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
                  <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-5">
                    <div className="flex items-center justify-between">
                      <div className="h-12 w-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <Users className="h-6 w-6 text-white" />
                      </div>
                      <Badge className="bg-white/20 text-white border-0 backdrop-blur-sm">
                        <TrendingUp className="h-3 w-3 mr-1" />
                        +5%
                      </Badge>
                    </div>
                    <div className="mt-4">
                      <p className="text-blue-100 text-xs font-medium">Tenant Reports</p>
                      <p className="text-3xl font-bold text-white mt-1">12</p>
                      <p className="text-blue-100 text-xs mt-2">Leases, Payments</p>
                    </div>
                    <div className="mt-3 pt-3 border-t border-white/20">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-blue-100">Last generated</span>
                        <span className="text-white font-medium">3 days ago</span>
                      </div>
                    </div>
                  </div>
                </Card>
              </div>

              {/* Interactive Report Generation */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-indigo-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-gradient-to-br from-[#7C3AED] to-purple-600 flex items-center justify-center">
                        <Zap className="h-5 w-5 text-white" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Generate Reports</h3>
                        <p className="text-xs text-gray-500">Use live portfolio data with filters to view detailed reports</p>
                      </div>
                    </div>
                    <Badge className="bg-purple-100 text-[#7C3AED] border-purple-200">
                      <Activity className="h-3 w-3 mr-1" />
                      Real-time
                    </Badge>
                  </div>
                </div>
                <CardContent className="p-6">
                  <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                    <div className="space-y-2">
                      <Label htmlFor="report-type" className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <FileText className="h-4 w-4 text-gray-400" />
                        Report Type
                      </Label>
                      <Select
                        value={reportType}
                        onValueChange={(value) =>
                          setReportType(value as ReportType)
                        }
                      >
                        <SelectTrigger id="report-type" className="bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-11">
                          <SelectValue placeholder="Select report type" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">All report types</SelectItem>
                          <SelectItem value="financial">Financial</SelectItem>
                          <SelectItem value="occupancy">Occupancy</SelectItem>
                          <SelectItem value="maintenance">Maintenance</SelectItem>
                          <SelectItem value="tenant">Tenant</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="report-property" className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <Building2 className="h-4 w-4 text-gray-400" />
                        Property
                      </Label>
                      <Select
                        value={reportPropertyFilter}
                        onValueChange={setReportPropertyFilter}
                      >
                        <SelectTrigger id="report-property" className="bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-11">
                          <SelectValue placeholder="All properties" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">All properties</SelectItem>
                          {visibleProperties.map((property) => (
                            <SelectItem
                              key={property.id}
                              value={String(property.id)}
                            >
                              {property.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="report-start" className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <Calendar className="h-4 w-4 text-gray-400" />
                        Start Date
                      </Label>
                      <Input
                        id="report-start"
                        type="date"
                        value={reportStartDate}
                        onChange={(e) => setReportStartDate(e.target.value)}
                        className="bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-11"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="report-end" className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <Calendar className="h-4 w-4 text-gray-400" />
                        End Date
                      </Label>
                      <Input
                        id="report-end"
                        type="date"
                        value={reportEndDate}
                        onChange={(e) => setReportEndDate(e.target.value)}
                        className="bg-white border-gray-200 focus:border-[#7C3AED] focus:ring-[#7C3AED] rounded-xl h-11"
                      />
                    </div>
                  </div>

                  <div className="flex flex-wrap items-center justify-between gap-4 mt-6 pt-5 border-t border-gray-100">
                    <div className="flex items-center gap-2 text-sm text-gray-500">
                      <Info className="h-4 w-4" />
                      <span>Reports generated from live dashboard data</span>
                    </div>
                    <div className="flex items-center gap-3">
                      <Button
                        variant="outline"
                        onClick={handleResetReportFilters}
                        disabled={reportGenerating && !reportPreview}
                        className="border-gray-200 text-gray-700 hover:bg-gray-50 rounded-xl h-10"
                      >
                        <X className="h-4 w-4 mr-2" />
                        Reset
                      </Button>
                      <Button
                        onClick={handleGenerateReport}
                        disabled={reportGenerating}
                        className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg shadow-purple-500/25 rounded-xl h-10 px-6"
                      >
                        {reportGenerating ? (
                          <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Generating...
                          </>
                        ) : (
                          <>
                            <BarChart3 className="mr-2 h-4 w-4" />
                            Generate Report
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {reportPreview && (
                <Card className="border-0 shadow-xl overflow-hidden">
                  <div className="bg-gradient-to-r from-[#7C3AED] via-purple-600 to-[#5B21B6] px-6 py-5">
                    <div className="flex flex-wrap items-start justify-between gap-4">
                      <div className="flex items-start gap-4">
                        <div className="h-12 w-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                          <BarChart3 className="h-6 w-6 text-white" />
                        </div>
                        <div>
                          <div className="flex flex-wrap items-center gap-3 mb-1">
                            <h3 className="text-xl font-bold text-white">
                              {REPORT_TYPE_LABELS[reportPreview.type]} Report
                            </h3>
                            <Badge className="bg-green-400/20 text-green-100 border-green-400/30">
                              <CheckCircle className="h-3 w-3 mr-1" />
                              Live Preview
                            </Badge>
                          </div>
                          <div className="flex flex-wrap items-center gap-2 text-purple-100 text-sm">
                            <span className="flex items-center gap-1">
                              <Clock className="h-3 w-3" />
                              {new Date(reportPreview.generatedAt).toLocaleString()}
                            </span>
                            <span className="text-white/40">â€¢</span>
                            <span className="flex items-center gap-1">
                              <Building2 className="h-3 w-3" />
                              {reportPreviewPropertyLabel}
                            </span>
                            {reportPreviewDateRange && (
                              <>
                                <span className="text-white/40">â€¢</span>
                                <span className="flex items-center gap-1">
                                  <Calendar className="h-3 w-3" />
                                  {reportPreviewDateRange}
                                </span>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={handleDownloadReport}
                          className="bg-white/10 border-white/20 text-white hover:bg-white/20 rounded-lg"
                        >
                          <Download className="mr-2 h-4 w-4" />
                          Download
                        </Button>
                        <Button
                          size="sm"
                          onClick={handleEmailReport}
                          className="bg-white text-[#7C3AED] hover:bg-white/90 shadow-lg rounded-lg"
                        >
                          <Send className="mr-2 h-4 w-4" />
                          Send to Email
                        </Button>
                      </div>
                    </div>
                  </div>
                  <CardContent className="p-6 bg-gray-50/50">
                    <div ref={reportPreviewRef}>{renderReportPreview()}</div>
                  </CardContent>
                </Card>
              )}

              {/* Recent Reports */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-blue-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                        <Archive className="h-5 w-5 text-blue-600" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Recent Reports</h3>
                        <p className="text-xs text-gray-500">Previously generated reports and downloads</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge className="bg-blue-100 text-blue-700 border-blue-200">
                        <FileText className="h-3 w-3 mr-1" />
                        3 Reports
                      </Badge>
                    </div>
                  </div>
                </div>
                <CardContent className="p-0">
                  <div className="overflow-hidden">
                    <Table>
                      <TableHeader>
                        <TableRow className="bg-gray-50 hover:bg-gray-50 border-b border-gray-200">
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Report Name</TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Type</TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Property</TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Generated</TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Size</TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Actions</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        <TableRow className="bg-white hover:bg-purple-50/50 transition-colors border-b border-gray-100">
                          <TableCell>
                            <div className="flex items-center gap-3">
                              <div className="h-9 w-9 rounded-lg bg-green-100 flex items-center justify-center">
                                <DollarSign className="h-4 w-4 text-green-600" />
                              </div>
                              <span className="font-semibold text-gray-900">March 2024 Financial Report</span>
                            </div>
                          </TableCell>
                          <TableCell>
                            <Badge className="bg-green-100 text-green-700 hover:bg-green-100 border-green-200">Financial</Badge>
                          </TableCell>
                          <TableCell className="text-gray-700">All Properties</TableCell>
                          <TableCell className="text-gray-600">March 21, 2024</TableCell>
                          <TableCell className="text-gray-600">2.3 MB</TableCell>
                          <TableCell>
                            <div className="flex items-center justify-end space-x-2">
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() =>
                                  toast.success("Downloading report...")
                                }
                                className="border-gray-200 text-gray-700 hover:bg-gray-100 rounded-lg h-8 w-8 p-0"
                              >
                                <Download className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() =>
                                  toast.info("Opening report in new tab...")
                                }
                                className="border-gray-200 text-gray-700 hover:bg-gray-100 rounded-lg h-8 w-8 p-0"
                              >
                                <ExternalLink className="h-4 w-4" />
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>

                        <TableRow className="bg-gray-50/50 hover:bg-purple-50/50 transition-colors border-b border-gray-100">
                          <TableCell>
                            <div className="flex items-center gap-3">
                              <div className="h-9 w-9 rounded-lg bg-purple-100 flex items-center justify-center">
                                <PieChart className="h-4 w-4 text-[#7C3AED]" />
                              </div>
                              <span className="font-semibold text-gray-900">Q1 2024 Occupancy Analysis</span>
                            </div>
                          </TableCell>
                          <TableCell>
                            <Badge className="bg-purple-100 text-[#7C3AED] hover:bg-purple-100 border-purple-200">Occupancy</Badge>
                          </TableCell>
                          <TableCell className="text-gray-700">Portfolio</TableCell>
                          <TableCell className="text-gray-600">March 20, 2024</TableCell>
                          <TableCell className="text-gray-600">1.8 MB</TableCell>
                          <TableCell>
                            <div className="flex items-center justify-end space-x-2">
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() =>
                                  toast.success("Downloading report...")
                                }
                                className="border-gray-200 text-gray-700 hover:bg-gray-100 rounded-lg h-8 w-8 p-0"
                              >
                                <Download className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() =>
                                  toast.info("Opening report in new tab...")
                                }
                                className="border-gray-200 text-gray-700 hover:bg-gray-100 rounded-lg h-8 w-8 p-0"
                              >
                                <ExternalLink className="h-4 w-4" />
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>

                        <TableRow className="bg-white hover:bg-purple-50/50 transition-colors">
                          <TableCell>
                            <div className="flex items-center gap-3">
                              <div className="h-9 w-9 rounded-lg bg-orange-100 flex items-center justify-center">
                                <Wrench className="h-4 w-4 text-orange-600" />
                              </div>
                              <span className="font-semibold text-gray-900">Sunset Apartments Maintenance</span>
                            </div>
                          </TableCell>
                          <TableCell>
                            <Badge className="bg-orange-100 text-orange-700 hover:bg-orange-100 border-orange-200">Maintenance</Badge>
                          </TableCell>
                          <TableCell className="text-gray-700">Sunset Apartments</TableCell>
                          <TableCell className="text-gray-600">March 19, 2024</TableCell>
                          <TableCell className="text-gray-600">0.9 MB</TableCell>
                          <TableCell>
                            <div className="flex items-center justify-end space-x-2">
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() =>
                                  toast.success("Downloading report...")
                                }
                                className="border-gray-200 text-gray-700 hover:bg-gray-100 rounded-lg h-8 w-8 p-0"
                              >
                                <Download className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() =>
                                  toast.info("Opening report in new tab...")
                                }
                                className="border-gray-200 text-gray-700 hover:bg-gray-100 rounded-lg h-8 w-8 p-0"
                              >
                                <ExternalLink className="h-4 w-4" />
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>
                      </TableBody>
                    </Table>
                  </div>
                </CardContent>
              </Card>

              {/* Scheduled Reports */}
              <Card className="border-0 shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-amber-50 to-yellow-50 px-6 py-4 border-b border-amber-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 rounded-xl bg-amber-500/20 flex items-center justify-center">
                        <Clock className="h-5 w-5 text-amber-600" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Scheduled Reports</h3>
                        <p className="text-xs text-gray-500">Automatically generate and deliver reports</p>
                      </div>
                    </div>
                    <Button
                      onClick={() =>
                        toast.info("Report scheduling coming soon...")
                      }
                      className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg shadow-purple-500/25 rounded-xl"
                    >
                      <Plus className="h-4 w-4 mr-2" />
                      Schedule Report
                    </Button>
                  </div>
                </div>
                <CardContent className="p-5">
                  <div className="space-y-3">
                    {/* Monthly Financial Report */}
                    <div className="group flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 hover:shadow-md hover:border-blue-200 transition-all duration-200">
                      <div className="flex items-center gap-4">
                        <div className="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                          <Calendar className="h-6 w-6 text-white" />
                        </div>
                        <div>
                          <div className="flex items-center gap-2">
                            <h4 className="font-bold text-gray-900">Monthly Financial Report</h4>
                            <Badge className="bg-green-100 text-green-700 border-green-200">
                              <CheckCircle className="h-3 w-3 mr-1" />
                              Active
                            </Badge>
                          </div>
                          <p className="text-sm text-gray-500 mt-0.5">Generated on the 1st of each month</p>
                          <div className="flex items-center gap-4 mt-2">
                            <span className="text-xs text-gray-400 flex items-center gap-1">
                              <Send className="h-3 w-3" />
                              Sent to owner@company.com
                            </span>
                            <span className="text-xs text-gray-400 flex items-center gap-1">
                              <Clock className="h-3 w-3" />
                              Next: Apr 1, 2024
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <Button variant="outline" size="sm" className="border-gray-200 text-gray-700 hover:bg-white rounded-lg h-9">
                          <Edit className="h-4 w-4 mr-1" />
                          Edit
                        </Button>
                        <Button variant="outline" size="sm" className="border-gray-200 text-gray-700 hover:bg-white rounded-lg h-9 w-9 p-0">
                          <Settings className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>

                    {/* Weekly Occupancy Update */}
                    <div className="group flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 border border-green-100 hover:shadow-md hover:border-green-200 transition-all duration-200">
                      <div className="flex items-center gap-4">
                        <div className="h-12 w-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center shadow-lg shadow-green-500/30">
                          <Activity className="h-6 w-6 text-white" />
                        </div>
                        <div>
                          <div className="flex items-center gap-2">
                            <h4 className="font-bold text-gray-900">Weekly Occupancy Update</h4>
                            <Badge className="bg-green-100 text-green-700 border-green-200">
                              <CheckCircle className="h-3 w-3 mr-1" />
                              Active
                            </Badge>
                          </div>
                          <p className="text-sm text-gray-500 mt-0.5">Generated every Monday at 9:00 AM</p>
                          <div className="flex items-center gap-4 mt-2">
                            <span className="text-xs text-gray-400 flex items-center gap-1">
                              <Send className="h-3 w-3" />
                              Sent to team@company.com
                            </span>
                            <span className="text-xs text-gray-400 flex items-center gap-1">
                              <Clock className="h-3 w-3" />
                              Next: Monday, Mar 25
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <Button variant="outline" size="sm" className="border-gray-200 text-gray-700 hover:bg-white rounded-lg h-9">
                          <Edit className="h-4 w-4 mr-1" />
                          Edit
                        </Button>
                        <Button variant="outline" size="sm" className="border-gray-200 text-gray-700 hover:bg-white rounded-lg h-9 w-9 p-0">
                          <Settings className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>

                    {/* Add More Hint */}
                    <div className="flex items-center justify-center p-4 rounded-xl border-2 border-dashed border-gray-200 hover:border-[#7C3AED]/40 hover:bg-purple-50/30 transition-all cursor-pointer group"
                      onClick={() => toast.info("Report scheduling coming soon...")}
                    >
                      <div className="flex items-center gap-3 text-gray-400 group-hover:text-[#7C3AED] transition-colors">
                        <Plus className="h-5 w-5" />
                        <span className="font-medium">Add another scheduled report</span>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        </div>
      </div>

      {/* Add Maintenance Request Dialog - Brand Styled */}
      <Dialog
        open={showAddMaintenanceDialog}
        onOpenChange={(open) => {
          setShowAddMaintenanceDialog(open);
          if (!open) {
            resetMaintenanceForm();
          }
        }}
      >
        <DialogContent className="max-w-2xl border-0 shadow-2xl">
          <DialogHeader className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] text-white -mx-6 -mt-6 px-6 py-4 rounded-t-lg mb-4">
            <DialogTitle className="text-xl font-bold">Create Maintenance Request</DialogTitle>
            <DialogDescription className="text-purple-100">
              Log a new maintenance ticket for one of your properties.
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-5 px-1">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label className="text-sm font-semibold text-gray-700">Property *</Label>
                <Select
                  value={maintenanceForm.propertyId}
                  onValueChange={(value) =>
                    setMaintenanceForm((prev) => ({
                      ...prev,
                      propertyId: value,
                      unitId: "none",
                    }))
                  }
                >
                  <SelectTrigger className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]">
                    <SelectValue placeholder="Select property" />
                  </SelectTrigger>
                  <SelectContent>
                    {visibleProperties.map((property) => (
                      <SelectItem key={property.id} value={property.id}>
                        {property.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label className="text-sm font-semibold text-gray-700">Unit</Label>
                <Select
                  value={maintenanceForm.unitId}
                  onValueChange={(value) =>
                    setMaintenanceForm((prev) => ({ ...prev, unitId: value }))
                  }
                  disabled={!maintenanceForm.propertyId}
                >
                  <SelectTrigger className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]">
                    <SelectValue placeholder="Property-wide" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">Property-wide</SelectItem>
                    {maintenanceForm.propertyId &&
                      getPropertyUnitsForExpense(
                        maintenanceForm.propertyId
                      ).map((unit) => (
                        <SelectItem key={unit.id} value={unit.id}>
                          Unit {unit.unitNumber}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label className="text-sm font-semibold text-gray-700">Priority</Label>
                <Select
                  value={maintenanceForm.priority}
                  onValueChange={(value) =>
                    setMaintenanceForm((prev) => ({ ...prev, priority: value }))
                  }
                >
                  <SelectTrigger className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="high">High</SelectItem>
                    <SelectItem value="medium">Medium</SelectItem>
                    <SelectItem value="low">Low</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label className="text-sm font-semibold text-gray-700">Category</Label>
                <Select
                  value={maintenanceForm.category}
                  onValueChange={(value) =>
                    setMaintenanceForm((prev) => ({ ...prev, category: value }))
                  }
                >
                  <SelectTrigger className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {MAINTENANCE_CATEGORIES.map((category) => (
                      <SelectItem key={category.value} value={category.value}>
                        {category.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label className="text-sm font-semibold text-gray-700">Title *</Label>
                <Input
                  value={maintenanceForm.title}
                  onChange={(e) =>
                    setMaintenanceForm((prev) => ({
                      ...prev,
                      title: e.target.value,
                    }))
                  }
                  placeholder="Short summary"
                  className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                />
              </div>
              <div className="space-y-2">
                <Label className="text-sm font-semibold text-gray-700">Preferred Date</Label>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      className="w-full justify-start text-left font-medium border-gray-300 hover:border-[#7C3AED] focus:border-[#7C3AED] focus:ring-[#7C3AED] transition-colors"
                    >
                      <Calendar className="mr-2 h-4 w-4 text-[#7C3AED]" />
                      {maintenanceForm.scheduledDate ? (
                        <span className="text-gray-900">
                          {(() => {
                            const date = new Date(maintenanceForm.scheduledDate);
                            return date.toLocaleDateString('en-US', {
                              year: 'numeric',
                              month: 'short',
                              day: 'numeric',
                            }) + ' at ' + date.toLocaleTimeString('en-US', {
                              hour: '2-digit',
                              minute: '2-digit',
                              hour12: true
                            });
                          })()}
                        </span>
                      ) : (
                        <span className="text-gray-500">Pick a date and time</span>
                      )}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0 border-[#7C3AED] shadow-lg bg-white" align="start">
                    <div className="px-4 py-3 bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] text-white">
                      <p className="text-sm font-semibold">Select Date & Time</p>
                    </div>
                    <div className="p-4 bg-white">
                      <CalendarComponent
                        mode="single"
                        selected={maintenanceForm.scheduledDate ? new Date(maintenanceForm.scheduledDate) : undefined}
                        onSelect={(date) => {
                          if (date) {
                            // Preserve existing time or set to 9:00 AM default
                            let hours = 9;
                            let minutes = 0;
                            if (maintenanceForm.scheduledDate) {
                              const existingDate = new Date(maintenanceForm.scheduledDate);
                              hours = existingDate.getHours();
                              minutes = existingDate.getMinutes();
                            }
                            date.setHours(hours, minutes, 0, 0);
                            setMaintenanceForm((prev) => ({
                              ...prev,
                              scheduledDate: date.toISOString(),
                            }));
                          }
                        }}
                        className="rounded-md border-0 mx-auto"
                        classNames={{
                          months: "flex flex-col space-y-4",
                          month: "space-y-4 w-full",
                          caption: "flex justify-center pt-1 relative items-center mb-2",
                          caption_label: "text-sm font-semibold text-gray-900",
                          nav: "space-x-1 flex items-center",
                          nav_button: "h-7 w-7 bg-transparent p-0 border border-gray-300 rounded-md hover:bg-purple-50 hover:border-[#7C3AED] hover:text-[#7C3AED] transition-colors",
                          nav_button_previous: "absolute left-1",
                          nav_button_next: "absolute right-1",
                          table: "w-full border-collapse space-y-1",
                          head_row: "flex w-full mb-1",
                          head_cell: "text-gray-500 rounded-md w-9 font-semibold text-xs uppercase",
                          row: "flex w-full mt-1",
                          cell: "relative p-0 text-center text-sm h-9 w-9 focus-within:relative focus-within:z-20",
                          day: "h-9 w-9 p-0 font-medium text-gray-700 rounded-md hover:bg-[#7C3AED]/10 hover:text-[#7C3AED] transition-colors inline-flex items-center justify-center",
                          day_selected: "bg-[#7C3AED] text-white hover:bg-[#6D28D9] focus:bg-[#6D28D9] font-bold shadow-md",
                          day_today: "bg-purple-100 text-[#7C3AED] font-bold border-2 border-[#7C3AED]",
                          day_outside: "text-gray-400 opacity-50",
                          day_disabled: "text-gray-400 opacity-50 cursor-not-allowed",
                          day_hidden: "invisible",
                        }}
                      />
                      <div className="mt-4 pt-4 border-t border-gray-200">
                        <Label className="text-xs font-semibold text-gray-700 mb-2 block">Time</Label>
                        <Input
                          type="time"
                          value={(() => {
                            if (!maintenanceForm.scheduledDate) return "09:00";
                            const date = new Date(maintenanceForm.scheduledDate);
                            const hours = date.getHours().toString().padStart(2, '0');
                            const mins = date.getMinutes().toString().padStart(2, '0');
                            return `${hours}:${mins}`;
                          })()}
                          onChange={(e) => {
                            const timeValue = e.target.value;
                            if (!timeValue) return;
                            const [hours, minutes] = timeValue.split(':').map(Number);
                            const date = maintenanceForm.scheduledDate
                              ? new Date(maintenanceForm.scheduledDate)
                              : new Date();
                            date.setHours(hours, minutes, 0, 0);
                            setMaintenanceForm((prev) => ({
                              ...prev,
                              scheduledDate: date.toISOString(),
                            }));
                          }}
                          className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                        />
                      </div>
                    </div>
                  </PopoverContent>
                </Popover>
              </div>
            </div>

            <div className="space-y-2">
              <Label className="text-sm font-semibold text-gray-700">Description *</Label>
              <Textarea
                value={maintenanceForm.description}
                onChange={(e) =>
                  setMaintenanceForm((prev) => ({
                    ...prev,
                    description: e.target.value,
                  }))
                }
                rows={4}
                placeholder="Provide more context for this maintenance issue..."
                className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED] resize-none"
              />
            </div>

            <div className="flex items-center justify-between rounded-xl border border-gray-300 bg-gradient-to-br from-gray-50 to-white p-4 hover:border-[#7C3AED] transition-colors">
              <div>
                <p className="text-sm font-semibold text-gray-900">Notify tenant</p>
                <p className="text-xs text-gray-600 mt-0.5">
                  Sends an email letting them know we're on it.
                </p>
              </div>
              <Switch
                checked={maintenanceForm.notifyTenant}
                onCheckedChange={(checked) =>
                  setMaintenanceForm((prev) => ({
                    ...prev,
                    notifyTenant: checked,
                  }))
                }
                className="data-[state=checked]:bg-[#7C3AED]"
              />
            </div>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 -mx-6 px-6 -mb-6 pb-6">
            <Button
              variant="outline"
              onClick={() => {
                setShowAddMaintenanceDialog(false);
                resetMaintenanceForm();
              }}
              disabled={maintenanceSaving}
              className="border-gray-300 text-gray-700 hover:bg-gray-100"
            >
              Cancel
            </Button>
            <Button
              onClick={handleSaveMaintenance}
              disabled={maintenanceSaving}
              className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg shadow-purple-500/25"
            >
              {maintenanceSaving ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Saving...
                </>
              ) : maintenanceEditingId ? (
                "Update Request"
              ) : (
                "Create Request"
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Maintenance Request View Dialog */}
      <Dialog
        open={showMaintenanceViewDialog}
        onOpenChange={(open) => {
          setShowMaintenanceViewDialog(open);
          if (!open) {
            setSelectedMaintenanceRequest(null);
          }
        }}
      >
        <DialogContent className="max-w-2xl max-h-[85vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              Maintenance Request â€“{" "}
              {selectedMaintenanceRequest?.ticketNumber || "Details"}
            </DialogTitle>
            <DialogDescription>
              {selectedMaintenanceRequest?.title}
            </DialogDescription>
          </DialogHeader>

          {selectedMaintenanceRequest ? (
            <div className="space-y-4">
              <div className="grid md:grid-cols-2 gap-4">
                <div className="border rounded-lg p-3 space-y-1 text-sm">
                  <p className="text-gray-500">Property</p>
                  <p className="font-medium">
                    {selectedMaintenanceRequest.property?.name || "â€”"}
                  </p>
                  <p className="text-xs text-gray-500">
                    Unit {selectedMaintenanceRequest.unit?.unitNumber || "â€”"}
                  </p>
                </div>
                <div className="border rounded-lg p-3 space-y-1 text-sm">
                  <p className="text-gray-500">Priority & Status</p>
                  <div className="flex items-center space-x-2">
                    <Badge
                      variant="outline"
                      className={getPriorityBadge(
                        selectedMaintenanceRequest.priority
                      )}
                    >
                      {selectedMaintenanceRequest.priority}
                    </Badge>
                    <Badge
                      variant={
                        selectedMaintenanceRequest.status === "completed"
                          ? "default"
                          : "secondary"
                      }
                    >
                      {selectedMaintenanceRequest.status}
                    </Badge>
                  </div>
                </div>
              </div>

              <div className="border rounded-lg p-3 text-sm space-y-2">
                <p className="text-gray-500">Description</p>
                <p className="text-gray-700">
                  {selectedMaintenanceRequest.description || "No description"}
                </p>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div className="border rounded-lg p-3 text-sm space-y-1">
                  <p className="text-gray-500">Reported By</p>
                  <p className="font-medium">
                    {selectedMaintenanceRequest.reportedBy?.name || "â€”"}
                  </p>
                  <p className="text-xs text-gray-500">
                    {selectedMaintenanceRequest.reportedBy?.email || ""}
                  </p>
                </div>
                <div className="border rounded-lg p-3 text-sm space-y-1">
                  <p className="text-gray-500">Assigned To</p>
                  <p className="font-medium">
                    {selectedMaintenanceRequest.assignedTo?.name ||
                      "Unassigned"}
                  </p>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div className="border rounded-lg p-3 text-sm space-y-1">
                  <p className="text-gray-500">Created On</p>
                  <p className="font-medium">
                    {selectedMaintenanceRequest.createdAt
                      ? new Date(
                          selectedMaintenanceRequest.createdAt
                        ).toLocaleString()
                      : "â€”"}
                  </p>
                </div>
                <div className="border rounded-lg p-3 text-sm space-y-1">
                  <p className="text-gray-500">Scheduled Date</p>
                  <p className="font-medium">
                    {selectedMaintenanceRequest.scheduledDate
                      ? new Date(
                          selectedMaintenanceRequest.scheduledDate
                        ).toLocaleString()
                      : "Not scheduled"}
                  </p>
                </div>
              </div>

              <div className="flex items-center justify-between rounded-md border p-3 text-sm">
                <span className="text-gray-500">Estimated Cost</span>
                <span className="font-medium">
                  {selectedMaintenanceRequest.estimatedCost
                    ? formatCurrency(
                        selectedMaintenanceRequest.estimatedCost,
                        smartBaseCurrency
                      )
                    : "TBD"}
                </span>
              </div>

              {selectedMaintenanceRequest.images?.length ? (
                <div className="space-y-2">
                  <p className="text-sm font-medium">Attachments</p>
                  <div className="grid grid-cols-3 gap-2">
                    {selectedMaintenanceRequest.images.map(
                      (image: string, index: number) => (
                        <img
                          key={index}
                          src={image}
                          alt={`Maintenance attachment ${index + 1}`}
                          className="w-full h-24 object-cover rounded-md border"
                        />
                      )
                    )}
                  </div>
                </div>
              ) : null}
            </div>
          ) : (
            <p className="text-sm text-gray-500">
              Select a maintenance request to view details.
            </p>
          )}

          <div className="flex justify-end gap-2 pt-4">
            <Button
              variant="outline"
              onClick={() => setShowMaintenanceViewDialog(false)}
            >
              Close
            </Button>
            <Button
              onClick={() => handleMaintenanceEdit(selectedMaintenanceRequest)}
            >
              <Edit className="h-4 w-4 mr-2" />
              Edit
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Delete Unit Confirmation Dialog */}
      <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Delete Unit</DialogTitle>
            <DialogDescription>
              Are you sure you want to delete this unit? This action cannot be
              undone.
            </DialogDescription>
          </DialogHeader>

          {unitToDelete && (
            <div className="space-y-4">
              <div className="bg-gray-50 border rounded-lg p-4 space-y-2">
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Unit Number
                  </span>
                  <span className="font-medium">{unitToDelete.unit}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Property
                  </span>
                  <span className="font-medium">
                    {properties.find((p) => p.id === unitToDelete.propertyId)
                      ?.name || "N/A"}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Status
                  </span>
                  <Badge
                    variant={
                      unitToDelete.status === "occupied"
                        ? "default"
                        : "secondary"
                    }
                  >
                    {unitToDelete.status}
                  </Badge>
                </div>
                {unitToDelete.tenant && (
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium text-gray-500">
                      Tenant
                    </span>
                    <span className="font-medium">{unitToDelete.tenant}</span>
                  </div>
                )}
              </div>

              {unitToDelete.status === "occupied" && (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div className="flex items-start space-x-2">
                    <AlertTriangle className="h-5 w-5 text-yellow-600 mt-0.5" />
                    <div className="text-sm text-yellow-800">
                      <p className="font-medium">Warning: Unit is occupied</p>
                      <p className="mt-1">
                        This unit has an active tenant. Make sure to handle the
                        lease properly before deleting.
                      </p>
                    </div>
                  </div>
                </div>
              )}

              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="flex items-start space-x-2">
                  <Trash2 className="h-5 w-5 text-red-600 mt-0.5" />
                  <div className="text-sm text-red-800">
                    <p className="font-medium">This action is permanent</p>
                    <p className="mt-1">
                      All unit data, including history and records, will be
                      permanently deleted.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="flex justify-end space-x-2 mt-4">
            <Button
              variant="outline"
              onClick={() => {
                setShowDeleteDialog(false);
                setUnitToDelete(null);
              }}
              disabled={isDeleting}
            >
              Cancel
            </Button>
            <Button
              variant="destructive"
              onClick={handleDeleteUnit}
              disabled={isDeleting}
            >
              {isDeleting ? (
                <>
                  <Clock className="h-4 w-4 mr-2 animate-spin" />
                  Deleting...
                </>
              ) : (
                <>
                  <Trash2 className="h-4 w-4 mr-2" />
                  Delete Unit
                </>
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* View Unit Details Dialog - Enhanced Design */}
      <Dialog open={showViewUnitDialog} onOpenChange={setShowViewUnitDialog}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-hidden p-0 border-0 shadow-2xl">
          {selectedUnit && (
            <>
              {/* Gradient Header */}
              <div className={`px-6 py-6 ${
                selectedUnit.status === "occupied"
                  ? "bg-gradient-to-r from-[#10B981] to-[#059669]"
                  : selectedUnit.status === "vacant"
                  ? "bg-gradient-to-r from-[#F59E0B] to-[#D97706]"
                  : "bg-gradient-to-r from-[#EF4444] to-[#DC2626]"
              }`}>
                <div className="flex items-start justify-between">
                  <div className="flex items-center gap-4">
                    <div className="h-16 w-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                      <Home className="h-8 w-8 text-white" />
                    </div>
                    <div>
                      <div className="flex items-center gap-3">
                        <h2 className="text-2xl font-bold text-white">{selectedUnit.unitNumber}</h2>
                        <Badge className={`${
                          selectedUnit.status === "occupied"
                            ? "bg-white/20 text-white border-white/30"
                            : selectedUnit.status === "vacant"
                            ? "bg-white/20 text-white border-white/30"
                            : "bg-white/20 text-white border-white/30"
                        } font-semibold uppercase text-xs`}>
                          {selectedUnit.status}
                        </Badge>
                      </div>
                      <div className="flex items-center gap-2 mt-2 text-white/90">
                        <MapPin className="h-4 w-4" />
                        <span className="text-sm font-medium">{selectedUnit?.properties?.name || "Unknown Property"}</span>
                      </div>
                      {selectedUnit.type && (
                        <span className="inline-flex items-center mt-2 px-3 py-1 bg-white/15 rounded-lg text-xs font-medium text-white">
                          {selectedUnit.type}
                        </span>
                      )}
                    </div>
                  </div>

                  {/* Quick Stats */}
                  <div className="flex items-center gap-3">
                    <div className="text-center px-4 py-2 bg-white/15 backdrop-blur-sm rounded-xl">
                      <div className="flex items-center justify-center gap-1">
                        <Bed className="h-4 w-4 text-white/80" />
                        <span className="text-xl font-bold text-white">{selectedUnit.bedrooms || 0}</span>
                      </div>
                      <span className="text-xs text-white/70">Beds</span>
                    </div>
                    <div className="text-center px-4 py-2 bg-white/15 backdrop-blur-sm rounded-xl">
                      <div className="flex items-center justify-center gap-1">
                        <Bath className="h-4 w-4 text-white/80" />
                        <span className="text-xl font-bold text-white">{selectedUnit.bathrooms || 0}</span>
                      </div>
                      <span className="text-xs text-white/70">Baths</span>
                    </div>
                    {selectedUnit.size && (
                      <div className="text-center px-4 py-2 bg-white/15 backdrop-blur-sm rounded-xl">
                        <div className="flex items-center justify-center gap-1">
                          <Maximize className="h-4 w-4 text-white/80" />
                          <span className="text-xl font-bold text-white">{selectedUnit.size}</span>
                        </div>
                        <span className="text-xs text-white/70">Sqft</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Content */}
              <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">

                  {/* Rent & Financial Highlights */}
                  <div className="lg:col-span-2">
                    <div className="bg-gradient-to-r from-[#10B981]/10 to-[#10B981]/5 border border-[#10B981]/20 rounded-2xl p-5">
                      <div className="flex items-center gap-3 mb-4">
                        <div className="h-10 w-10 rounded-xl bg-[#10B981]/20 flex items-center justify-center">
                          <DollarSign className="h-5 w-5 text-[#10B981]" />
                        </div>
                        <div>
                          <h3 className="text-lg font-bold text-gray-900">Monthly Rent</h3>
                          <p className="text-xs text-gray-500">Primary rental amount</p>
                        </div>
                        <div className="ml-auto">
                          <span className="text-3xl font-bold text-[#10B981]">
                            {formatCurrency(selectedUnit.monthlyRent || 0, selectedUnitCurrency)}
                          </span>
                        </div>
                      </div>

                      {/* Quick Financial Stats */}
                      <div className="grid grid-cols-3 gap-4 pt-4 border-t border-[#10B981]/20">
                        <div className="text-center">
                          <p className="text-sm font-semibold text-gray-900">
                            {formatCurrency(selectedUnit.securityDeposit || selectedUnit.properties?.securityDeposit || 0, selectedUnitCurrency)}
                          </p>
                          <p className="text-xs text-gray-500">Security Deposit</p>
                        </div>
                        <div className="text-center">
                          <p className="text-sm font-semibold text-gray-900">
                            {formatCurrency((selectedUnitNigeria as any).serviceCharge ?? selectedUnit.properties?.serviceCharge ?? 0, selectedUnitCurrency)}
                          </p>
                          <p className="text-xs text-gray-500">Service Charge</p>
                        </div>
                        <div className="text-center">
                          <p className="text-sm font-semibold text-gray-900">
                            {selectedUnit.floor || "N/A"}
                          </p>
                          <p className="text-xs text-gray-500">Floor Level</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Fees Section */}
                  <div className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
                    <div className="bg-gradient-to-r from-purple-50 to-violet-50 px-5 py-4 border-b border-gray-200">
                      <div className="flex items-center gap-2">
                        <div className="h-8 w-8 rounded-lg bg-[#7C3AED]/20 flex items-center justify-center">
                          <FileText className="h-4 w-4 text-[#7C3AED]" />
                        </div>
                        <h3 className="text-sm font-bold text-gray-900 uppercase tracking-wide">Fees & Charges</h3>
                      </div>
                    </div>
                    <div className="p-5 space-y-3">
                      {[
                        { label: "Application Fee", value: (selectedUnitNigeria as any).applicationFee ?? selectedUnit.properties?.applicationFee ?? 0 },
                        { label: "Legal Fee", value: (selectedUnitNigeria as any).legalFee ?? selectedUnit.properties?.legalFee ?? 0 },
                        { label: "Agent Commission", value: (selectedUnitNigeria as any).agentCommission ?? selectedUnit.properties?.agentCommission ?? 0 },
                        { label: "Agreement Fee", value: (selectedUnitNigeria as any).agreementFee ?? selectedUnit.properties?.agreementFee ?? 0 },
                      ].map((fee, idx) => (
                        <div key={idx} className="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                          <span className="text-sm text-gray-600">{fee.label}</span>
                          <span className="text-sm font-semibold text-gray-900">
                            {formatCurrency(fee.value, selectedUnitCurrency)}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Utilities Section */}
                  <div className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 px-5 py-4 border-b border-gray-200">
                      <div className="flex items-center gap-2">
                        <div className="h-8 w-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                          <Zap className="h-4 w-4 text-blue-600" />
                        </div>
                        <h3 className="text-sm font-bold text-gray-900 uppercase tracking-wide">Utilities & Amenities</h3>
                      </div>
                    </div>
                    <div className="p-5 space-y-3">
                      <div className="flex items-center justify-between py-2 border-b border-gray-100">
                        <span className="text-sm text-gray-600">Waste Management</span>
                        <span className="text-sm font-semibold text-gray-900">
                          {formatCurrency((selectedUnitNigeria as any).wasteFee || 0, selectedUnitCurrency)}
                        </span>
                      </div>
                      <div className="flex items-center justify-between py-2 border-b border-gray-100">
                        <span className="text-sm text-gray-600">Estate Dues</span>
                        <span className="text-sm font-semibold text-gray-900">
                          {formatCurrency((selectedUnitNigeria as any).estateDues || 0, selectedUnitCurrency)}
                        </span>
                      </div>
                      <div className="flex items-center justify-between py-2 border-b border-gray-100">
                        <span className="text-sm text-gray-600">Electricity Meter</span>
                        <span className="text-sm font-semibold text-gray-900">
                          {(selectedUnitNigeria as any).electricityMeter || "N/A"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between py-2 border-b border-gray-100">
                        <span className="text-sm text-gray-600">Prepaid Meter</span>
                        <Badge variant="outline" className={`${(selectedUnitNigeria as any).prepaidMeter ? "bg-green-50 text-green-700 border-green-200" : "bg-gray-50 text-gray-600 border-gray-200"}`}>
                          {(selectedUnitNigeria as any).prepaidMeter ? "Yes" : "No"}
                        </Badge>
                      </div>
                      <div className="flex items-center justify-between py-2 border-b border-gray-100">
                        <span className="text-sm text-gray-600">Water Source</span>
                        <span className="text-sm font-semibold text-gray-900">
                          {(selectedUnitNigeria as any).waterSource || "Not specified"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between py-2">
                        <span className="text-sm text-gray-600">Parking Available</span>
                        <Badge variant="outline" className={`${(selectedUnitNigeria as any).parkingAvailable ? "bg-green-50 text-green-700 border-green-200" : "bg-gray-50 text-gray-600 border-gray-200"}`}>
                          {(selectedUnitNigeria as any).parkingAvailable ? "Yes" : "No"}
                        </Badge>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              {/* Footer Actions */}
              <div className="bg-gray-50 px-6 py-4 flex items-center justify-end gap-3 border-t border-gray-200">
                <Button
                  variant="outline"
                  onClick={() => {
                    setShowViewUnitDialog(false);
                    setSelectedUnit(null);
                  }}
                  className="border-gray-300 text-gray-700 hover:bg-gray-100 rounded-xl px-5"
                >
                  Close
                </Button>
                <Button
                  onClick={() => {
                    setShowViewUnitDialog(false);
                    handleEditUnit(selectedUnit);
                  }}
                  className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg shadow-purple-500/25 rounded-xl px-6"
                >
                  <Edit className="h-4 w-4 mr-2" />
                  Edit Unit
                </Button>
              </div>
            </>
          )}
        </DialogContent>
      </Dialog>

      {/* Edit Unit Dialog */}
      <Dialog open={showEditUnitDialog} onOpenChange={setShowEditUnitDialog}>
        <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Edit Unit</DialogTitle>
            <DialogDescription>Update unit information</DialogDescription>
          </DialogHeader>

          <div className="grid gap-4">
            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editUnitNumber">
                  Unit Number
                </label>
                <Input
                  id="editUnitNumber"
                  value={unitForm.unitNumber}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, unitNumber: e.target.value })
                  }
                  placeholder="A101"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editType">
                  Type
                </label>
                <Input
                  id="editType"
                  value={unitForm.type}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, type: e.target.value })
                  }
                  placeholder="Apartment, Studio, etc."
                />
              </div>
            </div>

            <div className="grid grid-cols-3 gap-3">
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editFloor">
                  Floor
                </label>
                <Input
                  id="editFloor"
                  type="number"
                  value={unitForm.floor}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, floor: e.target.value })
                  }
                  placeholder="1"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editBedrooms">
                  Bedrooms
                </label>
                <Input
                  id="editBedrooms"
                  type="number"
                  value={unitForm.bedrooms}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, bedrooms: e.target.value })
                  }
                  placeholder="2"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editBathrooms">
                  Bathrooms
                </label>
                <Input
                  id="editBathrooms"
                  type="number"
                  value={unitForm.bathrooms}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, bathrooms: e.target.value })
                  }
                  placeholder="1"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editSize">
                  Size (sqft)
                </label>
                <Input
                  id="editSize"
                  type="number"
                  value={unitForm.size}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, size: e.target.value })
                  }
                  placeholder="850"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editStatus">
                  Status
                </label>
                <Select
                  value={unitForm.status}
                  onValueChange={(v) => setUnitForm({ ...unitForm, status: v })}
                >
                  <SelectTrigger id="editStatus">
                    <SelectValue placeholder="Select status" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="vacant">Vacant</SelectItem>
                    <SelectItem value="occupied">Occupied</SelectItem>
                    <SelectItem value="maintenance">Maintenance</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <div className="flex items-center justify-between">
                  <label
                    className="text-sm font-medium"
                    htmlFor="editMonthlyRent"
                  >
                    Rent
                  </label>
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-gray-600">Frequency</span>
                    <Select
                      value={unitForm.rentFrequency}
                      onValueChange={(v) =>
                        setUnitForm({ ...unitForm, rentFrequency: v })
                      }
                    >
                      <SelectTrigger className="h-8 w-28">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="monthly">Monthly</SelectItem>
                        <SelectItem value="annual">Annual</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <Input
                  id="editMonthlyRent"
                  type="number"
                  value={unitForm.monthlyRent}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, monthlyRent: e.target.value })
                  }
                  placeholder={
                    unitForm.rentFrequency === "annual"
                      ? "Enter annual rent"
                      : "Enter monthly rent"
                  }
                />
              </div>
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="editSecurityDeposit"
                >
                  Security Deposit
                </label>
                <Input
                  id="editSecurityDeposit"
                  type="number"
                  value={unitForm.securityDeposit}
                  onChange={(e) =>
                    setUnitForm({
                      ...unitForm,
                      securityDeposit: e.target.value,
                    })
                  }
                  placeholder="2400"
                />
              </div>
            </div>

            {/* Additional Fees & Utilities - mirror Add Unit fields */}
            <div className="grid gap-2">
              <label
                className="text-sm font-medium"
                htmlFor="editServiceCharge"
              >
                Service Charge
              </label>
              <Input
                id="editServiceCharge"
                type="number"
                value={unitForm.serviceCharge}
                onChange={(e) =>
                  setUnitForm({ ...unitForm, serviceCharge: e.target.value })
                }
                placeholder="0"
              />
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editLegalFee">
                  Legal Fee
                </label>
                <Input
                  id="editLegalFee"
                  type="number"
                  value={unitForm.legalFee}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, legalFee: e.target.value })
                  }
                  placeholder="0"
                />
              </div>
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="editAgentCommission"
                >
                  Agency Fee
                </label>
                <Input
                  id="editAgentCommission"
                  type="number"
                  value={unitForm.agentCommission}
                  onChange={(e) =>
                    setUnitForm({
                      ...unitForm,
                      agentCommission: e.target.value,
                    })
                  }
                  placeholder="0"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="editAgreementFee"
                >
                  Agreement Fee
                </label>
                <Input
                  id="editAgreementFee"
                  type="number"
                  value={unitForm.agreementFee}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, agreementFee: e.target.value })
                  }
                  placeholder="0"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editWasteFee">
                  Waste Management
                </label>
                <Input
                  id="editWasteFee"
                  type="number"
                  value={unitForm.wasteFee}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, wasteFee: e.target.value })
                  }
                  placeholder="0"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="editEstateDues">
                  Estate Dues
                </label>
                <Input
                  id="editEstateDues"
                  type="number"
                  value={unitForm.estateDues}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, estateDues: e.target.value })
                  }
                  placeholder="0"
                />
              </div>
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="editElectricityMeter"
                >
                  Electricity Meter No.
                </label>
                <Input
                  id="editElectricityMeter"
                  value={unitForm.electricityMeter}
                  onChange={(e) =>
                    setUnitForm({
                      ...unitForm,
                      electricityMeter: e.target.value,
                    })
                  }
                  placeholder="Prepaid meter no."
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div className="flex items-center justify-between">
                <label className="text-sm font-medium">Prepaid Meter</label>
                <Switch
                  checked={unitForm.prepaidMeter}
                  onCheckedChange={(v) =>
                    setUnitForm({ ...unitForm, prepaidMeter: v })
                  }
                />
              </div>
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="editWaterSource"
                >
                  Water Source
                </label>
                <Select
                  value={unitForm.waterSource}
                  onValueChange={(v) =>
                    setUnitForm({ ...unitForm, waterSource: v })
                  }
                >
                  <SelectTrigger id="editWaterSource">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="public">Public</SelectItem>
                    <SelectItem value="borehole">Borehole</SelectItem>
                    <SelectItem value="well">Well</SelectItem>
                    <SelectItem value="tanker">Tanker Supply</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <label className="text-sm font-medium">Parking Available</label>
              <Switch
                checked={unitForm.parkingAvailable}
                onCheckedChange={(v) =>
                  setUnitForm({ ...unitForm, parkingAvailable: v })
                }
              />
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button
                variant="outline"
                onClick={() => {
                  setShowEditUnitDialog(false);
                  setSelectedUnit(null);
                }}
                disabled={editingUnit}
              >
                Cancel
              </Button>
              <Button onClick={handleSaveEditedUnit} disabled={editingUnit}>
                {editingUnit ? (
                  <>
                    <Clock className="h-4 w-4 mr-2 animate-spin" />
                    Saving...
                  </>
                ) : (
                  <>
                    <Edit className="h-4 w-4 mr-2" />
                    Save Changes
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Delete Property Confirmation Dialog */}
      <Dialog
        open={showPropertyDeleteDialog}
        onOpenChange={setShowPropertyDeleteDialog}
      >
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Delete Property</DialogTitle>
            <DialogDescription>
              Are you sure you want to permanently delete this property? This
              action cannot be undone.
            </DialogDescription>
          </DialogHeader>

          {propertyToDelete && (
            <div className="space-y-4">
              <div className="bg-gray-50 border rounded-lg p-4 space-y-2">
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Property Name
                  </span>
                  <span className="font-medium">{propertyToDelete.name}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Location
                  </span>
                  <span className="font-medium">
                    {propertyToDelete.city}, {propertyToDelete.state}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Total Units
                  </span>
                  <span className="font-medium">
                    {propertyToDelete._count?.units ?? 0}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-gray-500">
                    Status
                  </span>
                  <Badge
                    variant={
                      propertyToDelete.status === "active"
                        ? "default"
                        : "secondary"
                    }
                  >
                    {propertyToDelete.status}
                  </Badge>
                </div>
              </div>

              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="flex items-start">
                  <AlertTriangle className="h-5 w-5 text-red-600 mt-0.5 mr-3 flex-shrink-0" />
                  <div className="text-sm text-red-800">
                    <p className="font-medium mb-1">Warning:</p>
                    <ul className="list-disc list-inside space-y-1 text-xs">
                      <li>
                        All units associated with this property will be deleted
                      </li>
                      <li>All lease records will be removed</li>
                      <li>All maintenance requests will be deleted</li>
                      <li>This action is permanent and cannot be reversed</li>
                    </ul>
                    <p className="mt-2 text-xs font-medium">
                      Note: Properties with active leases cannot be deleted.
                      Please end all active leases first.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="flex justify-end space-x-3">
            <Button
              variant="outline"
              onClick={() => {
                setShowPropertyDeleteDialog(false);
                setPropertyToDelete(null);
              }}
              disabled={isDeleting}
            >
              Cancel
            </Button>
            <Button
              variant="destructive"
              onClick={handleConfirmDeleteProperty}
              disabled={isDeleting}
            >
              {isDeleting ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Deleting...
                </>
              ) : (
                <>
                  <Trash2 className="h-4 w-4 mr-2" />
                  Delete Property
                </>
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Add/Edit Expense Dialog */}
      <Dialog open={showExpenseDialog} onOpenChange={setShowExpenseDialog}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingExpense ? "Edit Expense" : "Add New Expense"}
            </DialogTitle>
            <DialogDescription>
              {editingExpense
                ? "Update expense details"
                : "Record a new property expense"}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="expense-property">Property *</Label>
                <Select
                  value={expenseForm.propertyId}
                  onValueChange={(value) => {
                    const property = properties.find((p) => p.id === value);
                    setExpenseForm({
                      ...expenseForm,
                      propertyId: value,
                      currency: property?.currency || "NGN",
                      unitId: "", // Reset unit when property changes
                    });
                  }}
                >
                  <SelectTrigger id="expense-property">
                    <SelectValue placeholder="Select property" />
                  </SelectTrigger>
                  <SelectContent>
                    {visibleProperties.map((property) => (
                      <SelectItem key={property.id} value={property.id}>
                        {property.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="expense-unit">Unit (Optional)</Label>
                <Select
                  value={expenseForm.unitId}
                  onValueChange={(value) =>
                    setExpenseForm({ ...expenseForm, unitId: value })
                  }
                >
                  <SelectTrigger id="expense-unit">
                    <SelectValue placeholder="Select unit" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">None (Property-wide)</SelectItem>
                    {getPropertyUnitsForExpense(expenseForm.propertyId).map(
                      (unit) => (
                        <SelectItem key={unit.id} value={unit.id}>
                          Unit {unit.unitNumber}
                        </SelectItem>
                      )
                    )}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="expense-category">Category *</Label>
                <Select
                  value={expenseForm.category}
                  onValueChange={(value) =>
                    setExpenseForm({ ...expenseForm, category: value })
                  }
                >
                  <SelectTrigger id="expense-category">
                    <SelectValue placeholder="Select category" />
                  </SelectTrigger>
                  <SelectContent>
                    {EXPENSE_CATEGORIES.map((category) => (
                      <SelectItem key={category.value} value={category.value}>
                        {category.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="expense-amount">Amount *</Label>
                <div className="flex gap-2">
                  <Input
                    id="expense-amount"
                    type="number"
                    step="0.01"
                    value={expenseForm.amount}
                    onChange={(e) =>
                      setExpenseForm({ ...expenseForm, amount: e.target.value })
                    }
                    placeholder="0.00"
                    className="flex-1"
                  />
                  <span className="flex items-center px-3 border rounded-md bg-muted text-sm">
                    {expenseForm.currency}
                  </span>
                </div>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="expense-description">Description *</Label>
              <Textarea
                id="expense-description"
                value={expenseForm.description}
                onChange={(e) =>
                  setExpenseForm({
                    ...expenseForm,
                    description: e.target.value,
                  })
                }
                placeholder="Enter expense description"
                rows={3}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="expense-date">Date *</Label>
                <Input
                  id="expense-date"
                  type="date"
                  value={expenseForm.date}
                  onChange={(e) =>
                    setExpenseForm({ ...expenseForm, date: e.target.value })
                  }
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="expense-due-date">Due Date (Optional)</Label>
                <Input
                  id="expense-due-date"
                  type="date"
                  value={expenseForm.dueDate}
                  onChange={(e) =>
                    setExpenseForm({ ...expenseForm, dueDate: e.target.value })
                  }
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="expense-status">Status *</Label>
                <Select
                  value={expenseForm.status}
                  onValueChange={(value) =>
                    setExpenseForm({ ...expenseForm, status: value })
                  }
                >
                  <SelectTrigger id="expense-status">
                    <SelectValue placeholder="Select status" />
                  </SelectTrigger>
                  <SelectContent>
                    {EXPENSE_STATUSES.map((status) => (
                      <SelectItem key={status.value} value={status.value}>
                        {status.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="expense-payment-method">Payment Method</Label>
                <Select
                  value={expenseForm.paymentMethod}
                  onValueChange={(value) =>
                    setExpenseForm({ ...expenseForm, paymentMethod: value })
                  }
                >
                  <SelectTrigger id="expense-payment-method">
                    <SelectValue placeholder="Select method" />
                  </SelectTrigger>
                  <SelectContent>
                    {PAYMENT_METHODS.map((method) => (
                      <SelectItem key={method.value} value={method.value}>
                        {method.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="expense-notes">Notes (Optional)</Label>
              <Textarea
                id="expense-notes"
                value={expenseForm.notes}
                onChange={(e) =>
                  setExpenseForm({ ...expenseForm, notes: e.target.value })
                }
                placeholder="Add any additional notes"
                rows={2}
              />
            </div>
          </div>

          <div className="flex justify-end gap-2">
            <Button
              variant="outline"
              onClick={() => setShowExpenseDialog(false)}
            >
              Cancel
            </Button>
            <Button onClick={handleSaveExpense} disabled={expenseSaving}>
              {expenseSaving ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Saving...
                </>
              ) : (
                <>{editingExpense ? "Update Expense" : "Add Expense"}</>
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Delete Expense Confirmation Dialog */}
      <Dialog
        open={showExpenseDeleteDialog}
        onOpenChange={setShowExpenseDeleteDialog}
      >
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Delete Expense</DialogTitle>
            <DialogDescription>
              Are you sure you want to delete this expense? This action cannot
              be undone.
            </DialogDescription>
          </DialogHeader>

          {expenseToDelete && (
            <div className="py-4 space-y-2">
              <div className="flex justify-between">
                <span className="text-sm text-muted-foreground">Property:</span>
                <span className="text-sm font-medium">
                  {expenseToDelete.property?.name}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-sm text-muted-foreground">Category:</span>
                <span className="text-sm font-medium">
                  {
                    EXPENSE_CATEGORIES.find(
                      (c) => c.value === expenseToDelete.category
                    )?.label
                  }
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-sm text-muted-foreground">Amount:</span>
                <span className="text-sm font-medium">
                  {formatCurrency(
                    expenseToDelete.amount,
                    expenseToDelete.currency
                  )}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-sm text-muted-foreground">
                  Description:
                </span>
                <span className="text-sm font-medium">
                  {expenseToDelete.description}
                </span>
              </div>
            </div>
          )}

          <div className="flex justify-end gap-2">
            <Button
              variant="outline"
              onClick={() => setShowExpenseDeleteDialog(false)}
            >
              Cancel
            </Button>
            <Button
              variant="destructive"
              onClick={handleDeleteExpense}
              disabled={isDeleting}
            >
              {isDeleting ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Deleting...
                </>
              ) : (
                <>
                  <Trash2 className="h-4 w-4 mr-2" />
                  Delete Expense
                </>
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Property Financial Detail Dialog */}
      <Dialog
        open={showFinancialDetailDialog}
        onOpenChange={(open) => {
          setShowFinancialDetailDialog(open);
          if (!open) {
            setFinancialDetailProperty(null);
          }
        }}
      >
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto border-0 shadow-2xl">
          <DialogHeader className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] text-white -mx-6 -mt-6 px-6 py-4 rounded-t-lg mb-6">
            <DialogTitle className="text-xl font-bold">Property Financial Summary</DialogTitle>
            <DialogDescription className="text-purple-100">
              {financialDetailProperty?.property?.name}
            </DialogDescription>
          </DialogHeader>

          {financialDetailProperty ? (
            <div className="space-y-6 px-1">
              <div className="grid gap-4 md:grid-cols-2">
                <div className="border-0 rounded-xl p-5 bg-gradient-to-br from-green-50 to-green-100/50 shadow-sm hover:shadow-md transition-all">
                  <div className="flex items-center justify-between mb-3">
                    <p className="text-sm font-semibold text-gray-700">Monthly Revenue</p>
                    <div className="p-2 bg-green-500 rounded-lg">
                      <TrendingUp className="h-4 w-4 text-white" />
                    </div>
                  </div>
                  <p className="text-3xl font-bold text-gray-900">
                    {formatCurrency(
                      financialDetailProperty.monthlyRevenue,
                      financialDetailProperty.property.currency ||
                        smartBaseCurrency
                    )}
                  </p>
                </div>
                <div className="border-0 rounded-xl p-5 bg-gradient-to-br from-red-50 to-red-100/50 shadow-sm hover:shadow-md transition-all">
                  <div className="flex items-center justify-between mb-3">
                    <p className="text-sm font-semibold text-gray-700">Monthly Expenses</p>
                    <div className="p-2 bg-red-500 rounded-lg">
                      <TrendingDown className="h-4 w-4 text-white" />
                    </div>
                  </div>
                  <p className="text-3xl font-bold text-[#EF4444]">
                    {formatCurrency(
                      financialDetailProperty.totalExpenses,
                      financialDetailProperty.property.currency ||
                        smartBaseCurrency
                    )}
                  </p>
                </div>
                <div className="border-0 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-blue-100/50 shadow-sm hover:shadow-md transition-all">
                  <div className="flex items-center justify-between mb-3">
                    <p className="text-sm font-semibold text-gray-700">Net Income</p>
                    <div className="p-2 bg-blue-500 rounded-lg">
                      <DollarSign className="h-4 w-4 text-white" />
                    </div>
                  </div>
                  <p className="text-3xl font-bold text-[#10B981]">
                    {formatCurrency(
                      financialDetailProperty.netIncome,
                      financialDetailProperty.property.currency ||
                        smartBaseCurrency
                    )}
                  </p>
                </div>
                <div className="border-0 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-purple-100/50 shadow-sm hover:shadow-md transition-all">
                  <div className="flex items-center justify-between mb-3">
                    <p className="text-sm font-semibold text-gray-700">Occupancy Rate</p>
                    <div className="p-2 bg-[#7C3AED] rounded-lg">
                      <Users className="h-4 w-4 text-white" />
                    </div>
                  </div>
                  <p className="text-3xl font-bold text-gray-900">
                    {financialDetailProperty.occupancyRate.toFixed(1)}%
                  </p>
                </div>
              </div>

              <div className="border-0 rounded-xl p-5 bg-white shadow-md">
                <h4 className="text-lg font-bold text-gray-900 mb-4 flex items-center">
                  <FileText className="h-5 w-5 mr-2 text-[#7C3AED]" />
                  Recent Expenses
                </h4>
                {financialDetailProperty.propertyExpenses.length ? (
                  <div className="rounded-xl overflow-hidden border-0 shadow-sm">
                    <Table>
                      <TableHeader>
                        <TableRow className="bg-gray-50 hover:bg-gray-50 border-b border-gray-200">
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Date
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Description
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Unit
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Category
                          </TableHead>
                          <TableHead className="text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">
                            Amount
                          </TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {financialDetailProperty.propertyExpenses
                          .slice(0, 5)
                          .map((expense, idx) => (
                            <TableRow
                              key={expense.id}
                              className={`hover:bg-[#7C3AED]/5 transition-colors ${
                                idx % 2 === 0 ? "bg-white" : "bg-gray-50/50"
                              }`}
                            >
                              <TableCell className="font-medium text-gray-900">
                                {new Date(expense.date).toLocaleDateString()}
                              </TableCell>
                              <TableCell className="max-w-[220px] truncate text-gray-700">
                                {expense.description}
                              </TableCell>
                              <TableCell className="text-gray-700">
                                {expense.unit?.unitNumber
                                  ? `Unit ${expense.unit.unitNumber}`
                                  : "Property-wide"}
                              </TableCell>
                              <TableCell>
                                <Badge className="bg-gray-100 text-gray-700 hover:bg-gray-100 border-gray-200">
                                  {formatCategoryLabel(expense.category)}
                                </Badge>
                              </TableCell>
                              <TableCell className="text-right font-bold text-gray-900">
                                {formatCurrency(
                                  expense.amount,
                                  expense.currency || smartBaseCurrency
                                )}
                              </TableCell>
                            </TableRow>
                          ))}
                      </TableBody>
                    </Table>
                  </div>
                ) : (
                  <p className="text-sm text-gray-500 text-center py-4">
                    No expenses recorded for this property yet.
                  </p>
                )}
              </div>
            </div>
          ) : (
            <p className="text-sm text-gray-500 text-center py-8">
              Select a property to view details.
            </p>
          )}
        </DialogContent>
      </Dialog>

      {/* Add New Unit Dialog - Brand Styled */}
      <Dialog open={showAddUnitDialog} onOpenChange={setShowAddUnitDialog}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto border-0 shadow-2xl">
          <DialogHeader className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] text-white -mx-6 -mt-6 px-6 py-4 rounded-t-lg mb-4">
            <DialogTitle className="text-xl font-bold">Add New Unit</DialogTitle>
            <DialogDescription className="text-purple-100">
              Create a unit under one of your properties.
            </DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-2 px-1">
            <div className="grid gap-2">
              <label
                className="text-sm font-semibold text-gray-700"
                htmlFor="dialog-propertyId"
              >
                Property *
              </label>
              <Select
                value={unitForm.propertyId}
                onValueChange={(v) =>
                  setUnitForm({ ...unitForm, propertyId: v })
                }
              >
                <SelectTrigger id="dialog-propertyId" className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]">
                  <SelectValue placeholder="Select property" />
                </SelectTrigger>
                <SelectContent>
                  {visibleProperties.map((p: any) => (
                    <SelectItem key={p.id} value={String(p.id)}>
                      {p.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label
                  className="text-sm font-semibold text-gray-700"
                  htmlFor="dialog-unitNumber"
                >
                  Unit Number *
                </label>
                <Input
                  id="dialog-unitNumber"
                  value={unitForm.unitNumber}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, unitNumber: e.target.value })
                  }
                  placeholder="A101"
                  className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-semibold text-gray-700" htmlFor="dialog-type">
                  Type *
                </label>
                <Input
                  id="dialog-type"
                  value={unitForm.type}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, type: e.target.value })
                  }
                  placeholder="2-bedroom"
                  className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                />
              </div>
            </div>
            <div className="grid grid-cols-3 gap-3">
              <div className="grid gap-2">
                <label
                  className="text-sm font-semibold text-gray-700"
                  htmlFor="dialog-bedrooms"
                >
                  Bedrooms
                </label>
                <Input
                  id="dialog-bedrooms"
                  type="number"
                  value={unitForm.bedrooms}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, bedrooms: e.target.value })
                  }
                  placeholder="2"
                  className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                />
              </div>
              <div className="grid gap-2">
                <label
                  className="text-sm font-semibold text-gray-700"
                  htmlFor="dialog-bathrooms"
                >
                  Bathrooms
                </label>
                <Input
                  id="dialog-bathrooms"
                  type="number"
                  value={unitForm.bathrooms}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, bathrooms: e.target.value })
                  }
                  placeholder="1"
                  className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-semibold text-gray-700" htmlFor="dialog-floor">
                  Floor
                </label>
                <Input
                  id="dialog-floor"
                  type="number"
                  value={unitForm.floor}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, floor: e.target.value })
                  }
                  placeholder="3"
                  className="border-gray-300 focus:border-[#7C3AED] focus:ring-[#7C3AED]"
                />
              </div>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="dialog-size">
                  Size (sqft)
                </label>
                <Input
                  id="dialog-size"
                  type="number"
                  value={unitForm.size}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, size: e.target.value })
                  }
                  placeholder="900"
                />
              </div>
              <div className="grid gap-2">
                <div className="flex items-center justify-between">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-monthlyRent"
                  >
                    Rent *
                  </label>
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-gray-600">Frequency</span>
                    <Select
                      value={unitForm.rentFrequency}
                      onValueChange={(v) =>
                        setUnitForm({ ...unitForm, rentFrequency: v })
                      }
                    >
                      <SelectTrigger className="h-8 w-28">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="monthly">Monthly</SelectItem>
                        <SelectItem value="annual">Annual</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <Input
                  id="dialog-monthlyRent"
                  type="number"
                  value={unitForm.monthlyRent}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, monthlyRent: e.target.value })
                  }
                  placeholder="1200000"
                />
              </div>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="dialog-securityDeposit"
                >
                  Security Deposit
                </label>
                <Input
                  id="dialog-securityDeposit"
                  type="number"
                  value={unitForm.securityDeposit}
                  onChange={(e) =>
                    setUnitForm({
                      ...unitForm,
                      securityDeposit: e.target.value,
                    })
                  }
                  placeholder="500"
                />
              </div>
              <div className="grid gap-2">
                <label className="text-sm font-medium" htmlFor="dialog-status">
                  Status
                </label>
                <Select
                  value={unitForm.status}
                  onValueChange={(v) => setUnitForm({ ...unitForm, status: v })}
                >
                  <SelectTrigger id="dialog-status">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="vacant">Vacant</SelectItem>
                    <SelectItem value="occupied">Occupied</SelectItem>
                    <SelectItem value="maintenance">Maintenance</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Additional Fees Section - Brand Styled */}
            <div className="border-t border-gray-200 pt-5 mt-4">
              <h4 className="text-base font-bold text-gray-900 mb-4 flex items-center">
                <DollarSign className="h-5 w-5 mr-2 text-[#7C3AED]" />
                Additional Fees & Utilities
              </h4>
              <div className="grid gap-2">
                <label
                  className="text-sm font-medium"
                  htmlFor="dialog-serviceCharge"
                >
                  Service Charge
                </label>
                <Input
                  id="dialog-serviceCharge"
                  type="number"
                  value={unitForm.serviceCharge}
                  onChange={(e) =>
                    setUnitForm({ ...unitForm, serviceCharge: e.target.value })
                  }
                  placeholder="0"
                />
              </div>
              <div className="grid grid-cols-2 gap-3 mt-3">
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-legalFee"
                  >
                    Legal Fee
                  </label>
                  <Input
                    id="dialog-legalFee"
                    type="number"
                    value={unitForm.legalFee}
                    onChange={(e) =>
                      setUnitForm({ ...unitForm, legalFee: e.target.value })
                    }
                    placeholder="0"
                  />
                </div>
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-agentCommission"
                  >
                    Agency Fee
                  </label>
                  <Input
                    id="dialog-agentCommission"
                    type="number"
                    value={unitForm.agentCommission}
                    onChange={(e) =>
                      setUnitForm({
                        ...unitForm,
                        agentCommission: e.target.value,
                      })
                    }
                    placeholder="0"
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3 mt-3">
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-agreementFee"
                  >
                    Agreement Fee
                  </label>
                  <Input
                    id="dialog-agreementFee"
                    type="number"
                    value={unitForm.agreementFee}
                    onChange={(e) =>
                      setUnitForm({ ...unitForm, agreementFee: e.target.value })
                    }
                    placeholder="0"
                  />
                </div>
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-wasteFee"
                  >
                    Waste Management
                  </label>
                  <Input
                    id="dialog-wasteFee"
                    type="number"
                    value={unitForm.wasteFee}
                    onChange={(e) =>
                      setUnitForm({ ...unitForm, wasteFee: e.target.value })
                    }
                    placeholder="0"
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3 mt-3">
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-estateDues"
                  >
                    Estate Dues
                  </label>
                  <Input
                    id="dialog-estateDues"
                    type="number"
                    value={unitForm.estateDues}
                    onChange={(e) =>
                      setUnitForm({ ...unitForm, estateDues: e.target.value })
                    }
                    placeholder="0"
                  />
                </div>
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-electricityMeter"
                  >
                    Electricity Meter No.
                  </label>
                  <Input
                    id="dialog-electricityMeter"
                    value={unitForm.electricityMeter}
                    onChange={(e) =>
                      setUnitForm({
                        ...unitForm,
                        electricityMeter: e.target.value,
                      })
                    }
                    placeholder="Prepaid meter no."
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3 mt-3">
                <div className="flex items-center justify-between p-4 bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl hover:border-[#7C3AED] transition-colors">
                  <label className="text-sm font-semibold text-gray-900">Prepaid Meter</label>
                  <Switch
                    checked={unitForm.prepaidMeter}
                    onCheckedChange={(v) =>
                      setUnitForm({ ...unitForm, prepaidMeter: v })
                    }
                    className="data-[state=checked]:bg-[#7C3AED]"
                  />
                </div>
                <div className="grid gap-2">
                  <label
                    className="text-sm font-medium"
                    htmlFor="dialog-waterSource"
                  >
                    Water Source
                  </label>
                  <Select
                    value={unitForm.waterSource}
                    onValueChange={(v) =>
                      setUnitForm({ ...unitForm, waterSource: v })
                    }
                  >
                    <SelectTrigger id="dialog-waterSource">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="public">Public</SelectItem>
                      <SelectItem value="borehole">Borehole</SelectItem>
                      <SelectItem value="well">Well</SelectItem>
                      <SelectItem value="tanker">Tanker Supply</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="flex items-center justify-between p-4 bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl hover:border-[#7C3AED] transition-colors mt-3">
                <label className="text-sm font-semibold text-gray-900">Parking Available</label>
                <Switch
                  checked={unitForm.parkingAvailable}
                  onCheckedChange={(v) =>
                    setUnitForm({ ...unitForm, parkingAvailable: v })
                  }
                  className="data-[state=checked]:bg-[#7C3AED]"
                />
              </div>
            </div>
          </div>
          <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 -mx-6 px-6 -mb-6 pb-6">
            <Button
              variant="outline"
              onClick={() => setShowAddUnitDialog(false)}
              className="border-gray-300 text-gray-700 hover:bg-gray-100"
            >
              Cancel
            </Button>
            <Button
              disabled={unitSaving}
              className="bg-gradient-to-r from-[#7C3AED] to-[#5B21B6] hover:from-[#6D28D9] hover:to-[#4C1D95] text-white shadow-lg shadow-purple-500/25"
              onClick={async () => {
                try {
                  if (
                    !unitForm.propertyId ||
                    !unitForm.unitNumber ||
                    !unitForm.type ||
                    !unitForm.monthlyRent
                  ) {
                    toast.error(
                      "Please fill required fields (Property, Unit Number, Type, Rent)"
                    );
                    return;
                  }
                  setUnitSaving(true);
                  const payload: any = {
                    propertyId: unitForm.propertyId,
                    unitNumber: unitForm.unitNumber,
                    type: unitForm.type,
                    floor: unitForm.floor ? Number(unitForm.floor) : undefined,
                    bedrooms: unitForm.bedrooms
                      ? Number(unitForm.bedrooms)
                      : undefined,
                    bathrooms: unitForm.bathrooms
                      ? Number(unitForm.bathrooms)
                      : undefined,
                    size: unitForm.size ? Number(unitForm.size) : undefined,
                    monthlyRent: Number(unitForm.monthlyRent),
                    securityDeposit: unitForm.securityDeposit
                      ? Number(unitForm.securityDeposit)
                      : undefined,
                    status: unitForm.status,
                    features: {
                      nigeria: {
                        rentFrequency: unitForm.rentFrequency,
                        serviceCharge: unitForm.serviceCharge
                          ? Number(unitForm.serviceCharge)
                          : undefined,
                        legalFee: unitForm.legalFee
                          ? Number(unitForm.legalFee)
                          : undefined,
                        agentCommission: unitForm.agentCommission
                          ? Number(unitForm.agentCommission)
                          : undefined,
                        agreementFee: unitForm.agreementFee
                          ? Number(unitForm.agreementFee)
                          : undefined,
                        electricityMeter:
                          unitForm.electricityMeter || undefined,
                        prepaidMeter: unitForm.prepaidMeter,
                        wasteFee: unitForm.wasteFee
                          ? Number(unitForm.wasteFee)
                          : undefined,
                        estateDues: unitForm.estateDues
                          ? Number(unitForm.estateDues)
                          : undefined,
                        waterSource: unitForm.waterSource,
                        parkingAvailable: unitForm.parkingAvailable,
                      },
                    },
                  };
                  const res = await createUnit(payload);
                  if ((res as any).error)
                    throw new Error(
                      (res as any).error.error || "Failed to create unit"
                    );

                  // Get the created unit from response
                  const createdUnit = (res as any).data;

                  // Optimistic UI update - add unit immediately to the list
                  if (createdUnit) {
                    setUnitsData((prev) => [...prev, createdUnit]);
                  }

                  toast.success("Unit created successfully");
                  setShowAddUnitDialog(false);
                  setUnitForm({
                    propertyId: "",
                    unitNumber: "",
                    type: "",
                    floor: "",
                    bedrooms: "",
                    bathrooms: "",
                    size: "",
                    monthlyRent: "",
                    securityDeposit: "",
                    status: "vacant",
                    rentFrequency: "monthly",
                    serviceCharge: "",
                    legalFee: "",
                    agentCommission: "",
                    agreementFee: "",
                    electricityMeter: "",
                    prepaidMeter: false,
                    wasteFee: "",
                    estateDues: "",
                    waterSource: "public",
                    parkingAvailable: true,
                  });

                  // Background sync - refresh from server to ensure consistency
                  getUnits().then((uRes) => {
                    if (!uRes.error && Array.isArray(uRes.data))
                      setUnitsData(uRes.data);
                  });
                } catch (e: any) {
                  toast.error(e?.message || "Failed to create unit");
                } finally {
                  setUnitSaving(false);
                }
              }}
            >
              {unitSaving ? "Saving..." : "Save Unit"}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Import Properties Dialog */}
      <Dialog
        open={showImportDialog}
        onOpenChange={(open) =>
          !isImporting &&
          (open ? setShowImportDialog(true) : resetImportDialog())
        }
      >
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <FileSpreadsheet className="h-5 w-5" />
              Import Properties
            </DialogTitle>
            <DialogDescription>
              Upload a CSV file to import multiple properties at once. Download
              the sample template to see the required format.
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-6 py-4">
            {/* Step 1: Download Template */}
            <div className="border rounded-lg p-4 bg-gray-50">
              <h4 className="font-medium mb-2 flex items-center gap-2">
                <span className="bg-gray-900 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">
                  1
                </span>
                Download Template
              </h4>
              <p className="text-sm text-gray-600 mb-3">
                Download our CSV template with sample data to understand the
                required format.
              </p>
              <Button variant="outline" onClick={downloadSampleCSV}>
                <Download className="h-4 w-4 mr-2" />
                Download Sample CSV
              </Button>
            </div>

            {/* Step 2: Upload File */}
            <div className="border rounded-lg p-4">
              <h4 className="font-medium mb-2 flex items-center gap-2">
                <span className="bg-gray-900 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">
                  2
                </span>
                Upload Your File
              </h4>
              <p className="text-sm text-gray-600 mb-3">
                Select your CSV file with property data. Required fields: name,
                propertyType, address, city, state, totalUnits.
              </p>
              <div className="flex items-center gap-3">
                <Input
                  type="file"
                  accept=".csv"
                  onChange={handleFileSelect}
                  disabled={isImporting}
                  className="flex-1"
                />
                {importFile && (
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => {
                      setImportFile(null);
                      setImportData([]);
                      setImportErrors([]);
                      setImportResults(null);
                    }}
                  >
                    <X className="h-4 w-4" />
                  </Button>
                )}
              </div>
              {importFile && (
                <p className="text-sm text-green-600 mt-2">
                  âœ“ Selected: {importFile.name}
                </p>
              )}
            </div>

            {/* Validation Results */}
            {(importData.length > 0 || importErrors.length > 0) &&
              !importResults && (
                <div className="border rounded-lg p-4">
                  <h4 className="font-medium mb-2 flex items-center gap-2">
                    <span className="bg-gray-900 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">
                      3
                    </span>
                    Validation Results
                  </h4>

                  {importData.length > 0 && (
                    <div className="flex items-center gap-2 text-green-600 mb-2">
                      <CheckCircle className="h-4 w-4" />
                      <span className="text-sm">
                        {importData.length} valid properties ready to import
                      </span>
                    </div>
                  )}

                  {importErrors.length > 0 && (
                    <div className="mt-2">
                      <div className="flex items-center gap-2 text-red-600 mb-2">
                        <AlertCircle className="h-4 w-4" />
                        <span className="text-sm">
                          {importErrors.length} rows with errors (will be
                          skipped)
                        </span>
                      </div>
                      <div className="max-h-32 overflow-y-auto bg-red-50 rounded p-2">
                        {importErrors.slice(0, 5).map((error, idx) => (
                          <p key={idx} className="text-xs text-red-600">
                            {error}
                          </p>
                        ))}
                        {importErrors.length > 5 && (
                          <p className="text-xs text-red-600 font-medium">
                            ...and {importErrors.length - 5} more errors
                          </p>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Preview Table */}
                  {importData.length > 0 && (
                    <div className="mt-4">
                      <p className="text-sm font-medium mb-2">
                        Preview (first 3 properties):
                      </p>
                      <div className="overflow-x-auto">
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead className="text-xs">Name</TableHead>
                              <TableHead className="text-xs">
                                Location
                              </TableHead>
                              <TableHead className="text-xs">Units</TableHead>
                              <TableHead className="text-xs">Rent</TableHead>
                              <TableHead className="text-xs">Images</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {importData.slice(0, 3).map((prop, idx) => (
                              <TableRow key={idx}>
                                <TableCell className="text-xs">
                                  <div>
                                    <p className="font-medium">{prop.name}</p>
                                    <p className="text-gray-500">
                                      {prop.propertyType}
                                    </p>
                                  </div>
                                </TableCell>
                                <TableCell className="text-xs">
                                  {prop.city}, {prop.state}
                                </TableCell>
                                <TableCell className="text-xs">
                                  {prop.totalUnits}
                                </TableCell>
                                <TableCell className="text-xs">
                                  {prop.avgRent
                                    ? formatCurrency(
                                        prop.avgRent,
                                        prop.currency || "NGN"
                                      )
                                    : "-"}
                                </TableCell>
                                <TableCell className="text-xs">
                                  {prop.images && prop.images.length > 0 ? (
                                    <span className="text-green-600">
                                      âœ“ {prop.images.length} image(s)
                                    </span>
                                  ) : (
                                    <span className="text-gray-400">
                                      No images
                                    </span>
                                  )}
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </div>
                    </div>
                  )}
                </div>
              )}

            {/* Import Progress */}
            {isImporting && (
              <div className="border rounded-lg p-4">
                <h4 className="font-medium mb-2">Importing Properties...</h4>
                <Progress value={importProgress} className="mb-2" />
                <p className="text-sm text-gray-600">
                  {importProgress}% complete
                </p>
              </div>
            )}

            {/* Import Results */}
            {importResults && (
              <div className="border rounded-lg p-4">
                <h4 className="font-medium mb-2">Import Complete</h4>
                <div className="space-y-2">
                  {importResults.success > 0 && (
                    <div className="flex items-center gap-2 text-green-600">
                      <CheckCircle className="h-4 w-4" />
                      <span className="text-sm">
                        {importResults.success} properties imported successfully
                      </span>
                    </div>
                  )}
                  {importResults.failed > 0 && (
                    <div className="flex items-center gap-2 text-red-600">
                      <AlertCircle className="h-4 w-4" />
                      <span className="text-sm">
                        {importResults.failed} properties failed to import
                      </span>
                    </div>
                  )}
                  {importResults.errors.length > 0 && (
                    <div className="max-h-32 overflow-y-auto bg-red-50 rounded p-2 mt-2">
                      {importResults.errors.map((error, idx) => (
                        <p key={idx} className="text-xs text-red-600">
                          {error}
                        </p>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          <div className="flex justify-end gap-2 pt-2 border-t">
            <Button
              variant="outline"
              onClick={resetImportDialog}
              disabled={isImporting}
            >
              {importResults ? "Close" : "Cancel"}
            </Button>
            {!importResults && (
              <Button
                onClick={handleImportProperties}
                disabled={importData.length === 0 || isImporting}
                className="bg-gray-900 hover:bg-black"
              >
                {isImporting ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                    Importing...
                  </>
                ) : (
                  <>
                    <Upload className="h-4 w-4 mr-2" />
                    Import {importData.length} Properties
                  </>
                )}
              </Button>
            )}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
