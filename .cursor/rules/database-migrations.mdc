# Cursor AI Rules for Database Migration Management

## ğŸ”´ CRITICAL: Database Schema Management Rules

### Rule 1: NEVER Create Tables or Alter Schema Manually

**FORBIDDEN ACTIONS:**

- âŒ NEVER use `psql` commands to CREATE TABLE
- âŒ NEVER use `psql` commands to ALTER TABLE
- âŒ NEVER use `psql` commands to DROP TABLE
- âŒ NEVER use `psql` commands to ADD COLUMN
- âŒ NEVER use `psql` commands to DROP COLUMN
- âŒ NEVER use raw SQL to modify database schema
- âŒ NEVER use database GUI tools to modify schema
- âŒ NEVER use `npx prisma db push` in production or when migrations exist
- âŒ NEVER use `npx prisma db execute` for schema changes
- âŒ NEVER suggest running ALTER TABLE directly on production

**REASON:** Manual schema changes create drift between Prisma's migration history and the actual database, causing "column does not exist" errors and breaking the application.

---

### Rule 2: ALWAYS Use Prisma Migrations for Schema Changes

**REQUIRED WORKFLOW:**

1. **Edit `backend/prisma/schema.prisma` FIRST**
2. **Create migration file:**
   ```bash
   mkdir -p backend/prisma/migrations/YYYYMMDDHHMMSS_describe_change
   ```
3. **Write migration SQL** in `migration.sql`
4. **Commit to git immediately:**
   ```bash
   git add backend/prisma/migrations/ backend/prisma/schema.prisma
   git commit -m "migration: describe_change"
   ```
5. **Push to repository**
6. **Apply in production:** `npx prisma migrate deploy`

**ALLOWED COMMANDS:**

- âœ… `npx prisma migrate dev --name "description"` (development only)
- âœ… `npx prisma migrate deploy` (production)
- âœ… `npx prisma migrate status` (checking status)
- âœ… `npx prisma migrate resolve --applied "name"` (fixing failed migrations)
- âœ… `npx prisma migrate diff` (checking differences)

---

### Rule 3: ALWAYS Verify Schema Sync Before Deployment

**BEFORE deploying any code that touches the database:**

```bash
# Check for schema differences
npx prisma migrate diff --from-schema-datasource prisma/schema.prisma --to-schema-datamodel prisma/schema.prisma --script
```

**If output is NOT empty:**
1. Create a new migration with the output SQL
2. Commit and push the migration
3. Apply with `npx prisma migrate deploy`

---

### Rule 4: Migration Files Must Be Complete

**WHEN creating a migration, ALWAYS include:**

1. **All columns** defined in schema.prisma for new/modified tables
2. **All constraints** (NOT NULL, DEFAULT, etc.)
3. **All indexes** if defined
4. **All foreign keys** if defined

**CHECKLIST before committing migration:**
- [ ] Compare migration SQL with schema.prisma changes
- [ ] Verify ALL new columns are in the migration
- [ ] Verify column types match schema
- [ ] Verify nullable/required matches schema
- [ ] Verify default values match schema

---

### Rule 5: ALWAYS Check Production Schema After Deployment

**After deploying code with schema changes:**

1. Run in production console:
   ```bash
   npx prisma migrate status
   ```
   Expected: "Database schema is up to date!"

2. Verify no drift:
   ```bash
   npx prisma migrate diff --from-schema-datasource prisma/schema.prisma --to-schema-datamodel prisma/schema.prisma --script
   ```
   Expected: Empty output (no SQL)

---

### Rule 6: Handle Failed Migrations Properly

**IF a migration fails in production:**

1. Check the error:
   ```bash
   npx prisma migrate status
   ```

2. If columns already exist (duplicate error):
   ```bash
   npx prisma migrate resolve --rolled-back "migration_name"
   npx prisma migrate resolve --applied "migration_name"
   ```

3. If columns are missing, create a NEW migration (don't edit old ones)

4. NEVER delete migration files that have been applied

---

### Rule 7: Schema Changes Require These Steps

**EVERY time you modify schema.prisma:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Edit schema.prisma                                      â”‚
â”‚  2. Create migration directory with timestamp               â”‚
â”‚  3. Write complete migration.sql                            â”‚
â”‚  4. Test locally: npx prisma migrate dev                    â”‚
â”‚  5. Commit: git add prisma/ && git commit                   â”‚
â”‚  6. Push: git push origin main                              â”‚
â”‚  7. Production: npx prisma migrate deploy                   â”‚
â”‚  8. Verify: npx prisma migrate diff (should be empty)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Rule 8: Pre-Commit Checklist for Schema Changes

**Before committing ANY schema change, verify:**

- [ ] `schema.prisma` has the change
- [ ] Migration file exists in `prisma/migrations/`
- [ ] Migration SQL includes ALL columns/changes
- [ ] Migration uses `IF NOT EXISTS` for safety where appropriate
- [ ] Local database works after migration
- [ ] No TypeScript errors related to Prisma types

---

### Rule 9: Production Deployment Checklist

**When deploying to production:**

- [ ] All migrations are committed to git
- [ ] Code is pushed to repository
- [ ] Wait for deployment to complete
- [ ] Run `npx prisma migrate deploy` in production console
- [ ] Verify with `npx prisma migrate status`
- [ ] Check for drift with `npx prisma migrate diff`
- [ ] Test the affected features

---

### Rule 10: Emergency Recovery Protocol

**IF production has schema drift (missing columns):**

1. **DO NOT** run raw SQL directly
2. **Create a new migration** with the missing changes:
   ```bash
   mkdir -p backend/prisma/migrations/YYYYMMDDHHMMSS_fix_missing_columns
   ```
3. **Write the fix migration** using `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`
4. **Commit and push**
5. **Apply in production:** `npx prisma migrate deploy`

---

## ğŸ¯ AI Assistant Behavior

**When user asks to add/modify database columns:**

1. âœ… Edit `schema.prisma` first
2. âœ… Create a migration file with proper timestamp
3. âœ… Include ALL schema changes in migration SQL
4. âœ… Remind user to commit migration files
5. âœ… Remind user to run `npx prisma migrate deploy` in production

**When user reports "column does not exist" error:**

1. âœ… Check if migration exists for that column
2. âœ… If missing, create a new migration
3. âœ… Guide user to apply migration in production
4. âŒ NEVER suggest running raw SQL on production

**When user asks to check schema sync:**

1. âœ… Suggest `npx prisma migrate status`
2. âœ… Suggest `npx prisma migrate diff`
3. âœ… If differences found, create migration to fix

---

## ğŸ“‹ Quick Reference Commands

| Purpose | Command |
|---------|---------|
| Check status | `npx prisma migrate status` |
| Check differences | `npx prisma migrate diff --from-schema-datasource prisma/schema.prisma --to-schema-datamodel prisma/schema.prisma --script` |
| Apply migrations | `npx prisma migrate deploy` |
| Fix failed migration | `npx prisma migrate resolve --applied "name"` |
| Generate client | `npx prisma generate` |
| Validate schema | `npx prisma validate` |

---

## ğŸš¨ Error Response Protocol

**If developer asks to:**

1. "Run ALTER TABLE on production" â†’ Respond: "I'll create a proper migration instead. Direct SQL causes schema drift."

2. "Use prisma db push" â†’ Respond: "Since migrations exist, we should use `prisma migrate` to maintain history."

3. "Fix missing column quickly" â†’ Respond: "Let's create a migration for this. It takes 2 minutes and prevents future issues."

4. "Why is column missing in production?" â†’ Check migration files, verify they include all columns, create fix migration if needed.

---

**Last Updated:** December 1, 2025
**Status:** ENFORCED - These rules prevent production database issues
**Severity:** CRITICAL - Violations cause application downtime
